
import { unreachable } from '@glimmer/util';
import { Stack as WasmStack } from '@glimmer/low-level';
import { $sp, $fp } from '@glimmer/vm';
import { initializeRegistersWithSP } from './low-level';
import { REGISTERS } from '../symbols';
const MAX_SMI = 0xfffffff;
export class InnerStack {
    constructor(inner = new WasmStack(), js = []) {
        this.inner = inner;
        this.js = js;
    }
    slice(start, end) {
        let inner;
        if (typeof start === 'number' && typeof end === 'number') {
            inner = this.inner.slice(start, end);
        } else if (typeof start === 'number' && end === undefined) {
            inner = this.inner.sliceFrom(start);
        } else {
            inner = this.inner.clone();
        }
        return new InnerStack(inner, this.js.slice(start, end));
    }
    sliceInner(start, end) {
        let out = [];
        for (let i = start; i < end; i++) {
            out.push(this.get(i));
        }
        return out;
    }
    copy(from, to) {
        this.inner.copy(from, to);
    }
    write(pos, value) {
        if (isImmediate(value)) {
            this.writeRaw(pos, encodeImmediate(value));
        } else {
            this.writeJs(pos, value);
        }
    }
    writeJs(pos, value) {
        let idx = this.js.length;
        this.js.push(value);
        this.inner.writeRaw(pos, ~idx);
    }
    writeRaw(pos, value) {
        this.inner.writeRaw(pos, value);
    }
    get(pos) {
        let value = this.inner.getRaw(pos);
        if (value < 0) {
            return this.js[~value];
        } else {
            return decodeImmediate(value);
        }
    }
    reset() {
        this.inner.reset();
        this.js.length = 0;
    }
    get length() {
        return this.inner.len();
    }
}
export default class EvaluationStackImpl {
    // fp -> sp
    constructor(stack, registers) {
        this.stack = stack;
        this[REGISTERS] = registers;
        if (false) {
            Object.seal(this);
        }
    }
    static restore(snapshot) {
        let stack = new InnerStack();
        for (let i = 0; i < snapshot.length; i++) {
            stack.write(i, snapshot[i]);
        }
        return new this(stack, initializeRegistersWithSP(snapshot.length - 1));
    }
    push(value) {
        this.stack.write(++this[REGISTERS][$sp], value);
    }
    pushRaw(value) {
        this.stack.writeRaw(++this[REGISTERS][$sp], value);
    }
    pushNull() {
        this.stack.write(++this[REGISTERS][$sp], null);
    }
    dup(position = this[REGISTERS][$sp]) {
        this.stack.copy(position, ++this[REGISTERS][$sp]);
    }
    copy(from, to) {
        this.stack.copy(from, to);
    }
    pop(n = 1) {
        let top = this.stack.get(this[REGISTERS][$sp]);
        this[REGISTERS][$sp] -= n;
        return top;
    }
    peek(offset = 0) {
        return this.stack.get(this[REGISTERS][$sp] - offset);
    }
    get(offset, base = this[REGISTERS][$fp]) {
        return this.stack.get(base + offset);
    }
    set(value, offset, base = this[REGISTERS][$fp]) {
        this.stack.write(base + offset, value);
    }
    slice(start, end) {
        return this.stack.slice(start, end);
    }
    sliceArray(start, end) {
        return this.stack.sliceInner(start, end);
    }
    capture(items) {
        let end = this[REGISTERS][$sp] + 1;
        let start = end - items;
        return this.stack.sliceInner(start, end);
    }
    reset() {
        this.stack.reset();
    }
    toArray() {
        console.log(this[REGISTERS]);
        return this.stack.sliceInner(this[REGISTERS][$fp], this[REGISTERS][$sp] + 1);
    }
}
function isImmediate(value) {
    let type = typeof value;
    if (value === null || value === undefined) return true;
    switch (type) {
        case 'boolean':
        case 'undefined':
            return true;
        case 'number':
            // not an integer
            if (value % 1 !== 0) return false;
            let abs = Math.abs(value);
            // too big
            if (abs > MAX_SMI) return false;
            return true;
        default:
            return false;
    }
}
function encodeSmi(primitive) {
    if (primitive < 0) {
        return Math.abs(primitive) << 3 | 4 /* NEGATIVE */;
    } else {
        return primitive << 3 | 0 /* NUMBER */;
    }
}
function encodeImmediate(primitive) {
    switch (typeof primitive) {
        case 'number':
            return encodeSmi(primitive);
        case 'boolean':
            return primitive ? 11 /* True */ : 3 /* False */;
        case 'object':
            // assume null
            return 19 /* Null */;
        case 'undefined':
            return 27 /* Undef */;
        default:
            throw unreachable();
    }
}
function decodeSmi(smi) {
    switch (smi & 0b111) {
        case 0 /* NUMBER */:
            return smi >> 3;
        case 4 /* NEGATIVE */:
            return -(smi >> 3);
        default:
            throw unreachable();
    }
}
function decodeImmediate(immediate) {
    switch (immediate) {
        case 3 /* False */:
            return false;
        case 11 /* True */:
            return true;
        case 19 /* Null */:
            return null;
        case 27 /* Undef */:
            return undefined;
        default:
            return decodeSmi(immediate);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL3ZtL3N0YWNrLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFFQSxTQUFTLFdBQVQsUUFBNEIsZUFBNUI7QUFDQSxTQUFTLFNBQVMsU0FBbEIsUUFBbUMsb0JBQW5DO0FBQ0EsU0FBMEIsR0FBMUIsRUFBK0IsR0FBL0IsUUFBMEMsYUFBMUM7QUFDQSxTQUE0Qix5QkFBNUIsUUFBNkQsYUFBN0Q7QUFDQSxTQUFTLFNBQVQsUUFBMEIsWUFBMUI7QUFFQSxNQUFNLFVBQVUsU0FBaEI7QUFFQSxPQUFNLE1BQU8sVUFBUCxDQUFpQjtBQUNyQixnQkFBb0IsUUFBUSxJQUFJLFNBQUosRUFBNUIsRUFBcUQsS0FBZ0IsRUFBckUsRUFBdUU7QUFBbkQsYUFBQSxLQUFBLEdBQUEsS0FBQTtBQUFpQyxhQUFBLEVBQUEsR0FBQSxFQUFBO0FBQXNCO0FBRTNFLFVBQU0sS0FBTixFQUFzQixHQUF0QixFQUFrQztBQUNoQyxZQUFJLEtBQUo7QUFFQSxZQUFJLE9BQU8sS0FBUCxLQUFpQixRQUFqQixJQUE2QixPQUFPLEdBQVAsS0FBZSxRQUFoRCxFQUEwRDtBQUN4RCxvQkFBUSxLQUFLLEtBQUwsQ0FBVyxLQUFYLENBQWlCLEtBQWpCLEVBQXdCLEdBQXhCLENBQVI7QUFDRCxTQUZELE1BRU8sSUFBSSxPQUFPLEtBQVAsS0FBaUIsUUFBakIsSUFBNkIsUUFBUSxTQUF6QyxFQUFvRDtBQUN6RCxvQkFBUSxLQUFLLEtBQUwsQ0FBVyxTQUFYLENBQXFCLEtBQXJCLENBQVI7QUFDRCxTQUZNLE1BRUE7QUFDTCxvQkFBUSxLQUFLLEtBQUwsQ0FBVyxLQUFYLEVBQVI7QUFDRDtBQUVELGVBQU8sSUFBSSxVQUFKLENBQWUsS0FBZixFQUFzQixLQUFLLEVBQUwsQ0FBUSxLQUFSLENBQWMsS0FBZCxFQUFxQixHQUFyQixDQUF0QixDQUFQO0FBQ0Q7QUFFRCxlQUF3QixLQUF4QixFQUF1QyxHQUF2QyxF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dkIsQ0FBdUIsWUFBdkI7QUFDRDtBQUNGO0FBRUQsU0FBUyxlQUFULENBQXlCLFNBQXpCLEVBQXVFO0FBQ3JFLFlBQVEsT0FBTyxTQUFmO0FBQ0UsYUFBSyxRQUFMO0FBQ0UsbUJBQU8sVUFBVSxTQUFWLENBQVA7QUFDRixhQUFLLFNBQUw7QUFDRSxtQkFBTyxZQUFXLEVBQVgsQ0FBVyxVQUFYLEdBQTZCLENBQXBDLENBQW9DLFdBQXBDO0FBQ0YsYUFBSyxRQUFMO0FBQ0U7QUFDQSxtQkFBQSxFQUFBLENBQUEsVUFBQTtBQUNGLGFBQUssV0FBTDtBQUNFLG1CQUFBLEVBQUEsQ0FBQSxXQUFBO0FBQ0Y7QUFDRSxrQkFBTSxhQUFOO0FBWEo7QUFhRDtBQUVELFNBQVMsU0FBVCxDQUFtQixHQUFuQixFQUE4QjtBQUM1QixZQUFRLE1BQU0sS0FBZDtBQUNFLGFBQUEsQ0FBQSxDQUFBLFlBQUE7QUFDRSxtQkFBTyxPQUFPLENBQWQ7QUFDRixhQUFBLENBQUEsQ0FBQSxjQUFBO0FBQ0UsbUJBQU8sRUFBRSxPQUFPLENBQVQsQ0FBUDtBQUNGO0FBQ0Usa0JBQU0sYUFBTjtBQU5KO0FBUUQ7QUFFRCxTQUFTLGVBQVQsQ0FBeUIsU0FBekIsRUFBMEM7QUFDeEMsWUFBUSxTQUFSO0FBQ0UsYUFBQSxDQUFBLENBQUEsV0FBQTtBQUNFLG1CQUFPLEtBQVA7QUFDRixhQUFBLEVBQUEsQ0FBQSxVQUFBO0FBQ0UsbUJBQU8sSUFBUDtBQUNGLGFBQUEsRUFBQSxDQUFBLFVBQUE7QUFDRSxtQkFBTyxJQUFQO0FBQ0YsYUFBQSxFQUFBLENBQUEsV0FBQTtBQUNFLG1CQUFPLFNBQVA7QUFDRjtBQUNFLG1CQUFPLFVBQVUsU0FBVixDQUFQO0FBVko7QUFZRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IERFQlVHIH0gZnJvbSAnQGdsaW1tZXIvbG9jYWwtZGVidWctZmxhZ3MnO1xuaW1wb3J0IHsgUHJpbWl0aXZlVHlwZSB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgdW5yZWFjaGFibGUgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IFN0YWNrIGFzIFdhc21TdGFjayB9IGZyb20gJ0BnbGltbWVyL2xvdy1sZXZlbCc7XG5pbXBvcnQgeyBNYWNoaW5lUmVnaXN0ZXIsICRzcCwgJGZwIH0gZnJvbSAnQGdsaW1tZXIvdm0nO1xuaW1wb3J0IHsgTG93TGV2ZWxSZWdpc3RlcnMsIGluaXRpYWxpemVSZWdpc3RlcnNXaXRoU1AgfSBmcm9tICcuL2xvdy1sZXZlbCc7XG5pbXBvcnQgeyBSRUdJU1RFUlMgfSBmcm9tICcuLi9zeW1ib2xzJztcblxuY29uc3QgTUFYX1NNSSA9IDB4ZmZmZmZmZjtcblxuZXhwb3J0IGNsYXNzIElubmVyU3RhY2sge1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGlubmVyID0gbmV3IFdhc21TdGFjaygpLCBwcml2YXRlIGpzOiB1bmtub3duW10gPSBbXSkge31cblxuICBzbGljZShzdGFydD86IG51bWJlciwgZW5kPzogbnVtYmVyKTogSW5uZXJTdGFjayB7XG4gICAgbGV0IGlubmVyOiBXYXNtU3RhY2s7XG5cbiAgICBpZiAodHlwZW9mIHN0YXJ0ID09PSAnbnVtYmVyJyAmJiB0eXBlb2YgZW5kID09PSAnbnVtYmVyJykge1xuICAgICAgaW5uZXIgPSB0aGlzLmlubmVyLnNsaWNlKHN0YXJ0LCBlbmQpO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIHN0YXJ0ID09PSAnbnVtYmVyJyAmJiBlbmQgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaW5uZXIgPSB0aGlzLmlubmVyLnNsaWNlRnJvbShzdGFydCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlubmVyID0gdGhpcy5pbm5lci5jbG9uZSgpO1xuICAgIH1cblxuICAgIHJldHVybiBuZXcgSW5uZXJTdGFjayhpbm5lciwgdGhpcy5qcy5zbGljZShzdGFydCwgZW5kKSk7XG4gIH1cblxuICBzbGljZUlubmVyPFQgPSB1bmtub3duPihzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlcik6IFRbXSB7XG4gICAgbGV0IG91dCA9IFtdO1xuXG4gICAgZm9yIChsZXQgaSA9IHN0YXJ0OyBpIDwgZW5kOyBpKyspIHtcbiAgICAgIG91dC5wdXNoKHRoaXMuZ2V0KGkpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gb3V0O1xuICB9XG5cbiAgY29weShmcm9tOiBudW1iZXIsIHRvOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmlubmVyLmNvcHkoZnJvbSwgdG8pO1xuICB9XG5cbiAgd3JpdGUocG9zOiBudW1iZXIsIHZhbHVlOiB1bmtub3duKTogdm9pZCB7XG4gICAgaWYgKGlzSW1tZWRpYXRlKHZhbHVlKSkge1xuICAgICAgdGhpcy53cml0ZVJhdyhwb3MsIGVuY29kZUltbWVkaWF0ZSh2YWx1ZSkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLndyaXRlSnMocG9zLCB2YWx1ZSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSB3cml0ZUpzKHBvczogbnVtYmVyLCB2YWx1ZTogdW5rbm93bik6IHZvaWQge1xuICAgIGxldCBpZHggPSB0aGlzLmpzLmxlbmd0aDtcbiAgICB0aGlzLmpzLnB1c2godmFsdWUpO1xuICAgIHRoaXMuaW5uZXIud3JpdGVSYXcocG9zLCB+aWR4KTtcbiAgfVxuXG4gIHdyaXRlUmF3KHBvczogbnVtYmVyLCB2YWx1ZTogbnVtYmVyKSB7XG4gICAgdGhpcy5pbm5lci53cml0ZVJhdyhwb3MsIHZhbHVlKTtcbiAgfVxuXG4gIGdldDxUPihwb3M6IG51bWJlcik6IFQge1xuICAgIGxldCB2YWx1ZSA9IHRoaXMuaW5uZXIuZ2V0UmF3KHBvcyk7XG5cbiAgICBpZiAodmFsdWUgPCAwKSB7XG4gICAgICByZXR1cm4gdGhpcy5qc1t+dmFsdWVdIGFzIFQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBkZWNvZGVJbW1lZGlhdGUodmFsdWUpIGFzIGFueTtcbiAgICB9XG4gIH1cblxuICByZXNldCgpOiB2b2lkIHtcbiAgICB0aGlzLmlubmVyLnJlc2V0KCk7XG4gICAgdGhpcy5qcy5sZW5ndGggPSAwO1xuICB9XG5cbiAgZ2V0IGxlbmd0aCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmlubmVyLmxlbigpO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXZhbHVhdGlvblN0YWNrIHtcbiAgW1JFR0lTVEVSU106IExvd0xldmVsUmVnaXN0ZXJzO1xuXG4gIHB1c2godmFsdWU6IHVua25vd24pOiB2b2lkO1xuICBwdXNoTnVsbCgpOiB2b2lkO1xuICBwdXNoUmF3KHZhbHVlOiBudW1iZXIpOiB2b2lkO1xuICBkdXAocG9zaXRpb24/OiBNYWNoaW5lUmVnaXN0ZXIpOiB2b2lkO1xuICBjb3B5KGZyb206IG51bWJlciwgdG86IG51bWJlcik6IHZvaWQ7XG4gIHBvcDxUPihuPzogbnVtYmVyKTogVDtcbiAgcGVlazxUPihvZmZzZXQ/OiBudW1iZXIpOiBUO1xuICBnZXQ8VD4ob2Zmc2V0OiBudW1iZXIsIGJhc2U/OiBudW1iZXIpOiBUO1xuICBzZXQodmFsdWU6IHVua25vd24sIG9mZnNldDogbnVtYmVyLCBiYXNlPzogbnVtYmVyKTogdm9pZDtcbiAgc2xpY2Uoc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpOiBJbm5lclN0YWNrO1xuICBzbGljZUFycmF5PFQgPSB1bmtub3duPihzdGFydDogbnVtYmVyLCBlbmQ6IG51bWJlcik6IFRbXTtcbiAgY2FwdHVyZShpdGVtczogbnVtYmVyKTogdW5rbm93bltdO1xuICByZXNldCgpOiB2b2lkO1xuICB0b0FycmF5KCk6IHVua25vd25bXTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgRXZhbHVhdGlvblN0YWNrSW1wbCBpbXBsZW1lbnRzIEV2YWx1YXRpb25TdGFjayB7XG4gIHN0YXRpYyByZXN0b3JlKHNuYXBzaG90OiB1bmtub3duW10pOiBFdmFsdWF0aW9uU3RhY2sge1xuICAgIGxldCBzdGFjayA9IG5ldyBJbm5lclN0YWNrKCk7XG5cbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IHNuYXBzaG90Lmxlbmd0aDsgaSsrKSB7XG4gICAgICBzdGFjay53cml0ZShpLCBzbmFwc2hvdFtpXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG5ldyB0aGlzKHN0YWNrLCBpbml0aWFsaXplUmVnaXN0ZXJzV2l0aFNQKHNuYXBzaG90Lmxlbmd0aCAtIDEpKTtcbiAgfVxuXG4gIHJlYWRvbmx5IFtSRUdJU1RFUlNdOiBMb3dMZXZlbFJlZ2lzdGVycztcblxuICAvLyBmcCAtPiBzcFxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHN0YWNrOiBJbm5lclN0YWNrLCByZWdpc3RlcnM6IExvd0xldmVsUmVnaXN0ZXJzKSB7XG4gICAgdGhpc1tSRUdJU1RFUlNdID0gcmVnaXN0ZXJzO1xuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBPYmplY3Quc2VhbCh0aGlzKTtcbiAgICB9XG4gIH1cblxuICBwdXNoKHZhbHVlOiB1bmtub3duKTogdm9pZCB7XG4gICAgdGhpcy5zdGFjay53cml0ZSgrK3RoaXNbUkVHSVNURVJTXVskc3BdLCB2YWx1ZSk7XG4gIH1cblxuICBwdXNoUmF3KHZhbHVlOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnN0YWNrLndyaXRlUmF3KCsrdGhpc1tSRUdJU1RFUlNdWyRzcF0sIHZhbHVlKTtcbiAgfVxuXG4gIHB1c2hOdWxsKCk6IHZvaWQge1xuICAgIHRoaXMuc3RhY2sud3JpdGUoKyt0aGlzW1JFR0lTVEVSU11bJHNwXSwgbnVsbCk7XG4gIH1cblxuICBkdXAocG9zaXRpb24gPSB0aGlzW1JFR0lTVEVSU11bJHNwXSk6IHZvaWQge1xuICAgIHRoaXMuc3RhY2suY29weShwb3NpdGlvbiwgKyt0aGlzW1JFR0lTVEVSU11bJHNwXSk7XG4gIH1cblxuICBjb3B5KGZyb206IG51bWJlciwgdG86IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMuc3RhY2suY29weShmcm9tLCB0byk7XG4gIH1cblxuICBwb3A8VD4obiA9IDEpOiBUIHtcbiAgICBsZXQgdG9wID0gdGhpcy5zdGFjay5nZXQ8VD4odGhpc1tSRUdJU1RFUlNdWyRzcF0pO1xuICAgIHRoaXNbUkVHSVNURVJTXVskc3BdIC09IG47XG4gICAgcmV0dXJuIHRvcDtcbiAgfVxuXG4gIHBlZWs8VD4ob2Zmc2V0ID0gMCk6IFQge1xuICAgIHJldHVybiB0aGlzLnN0YWNrLmdldDxUPih0aGlzW1JFR0lTVEVSU11bJHNwXSAtIG9mZnNldCk7XG4gIH1cblxuICBnZXQ8VD4ob2Zmc2V0OiBudW1iZXIsIGJhc2UgPSB0aGlzW1JFR0lTVEVSU11bJGZwXSk6IFQge1xuICAgIHJldHVybiB0aGlzLnN0YWNrLmdldDxUPihiYXNlICsgb2Zmc2V0KTtcbiAgfVxuXG4gIHNldCh2YWx1ZTogdW5rbm93biwgb2Zmc2V0OiBudW1iZXIsIGJhc2UgPSB0aGlzW1JFR0lTVEVSU11bJGZwXSkge1xuICAgIHRoaXMuc3RhY2sud3JpdGUoYmFzZSArIG9mZnNldCwgdmFsdWUpO1xuICB9XG5cbiAgc2xpY2Uoc3RhcnQ6IG51bWJlciwgZW5kOiBudW1iZXIpOiBJbm5lclN0YWNrIHtcbiAgICByZXR1cm4gdGhpcy5zdGFjay5zbGljZShzdGFydCwgZW5kKTtcbiAgfVxuXG4gIHNsaWNlQXJyYXk8VCA9IHVua25vd24+KHN0YXJ0OiBudW1iZXIsIGVuZDogbnVtYmVyKTogVFtdIHtcbiAgICByZXR1cm4gdGhpcy5zdGFjay5zbGljZUlubmVyKHN0YXJ0LCBlbmQpO1xuICB9XG5cbiAgY2FwdHVyZShpdGVtczogbnVtYmVyKTogdW5rbm93bltdIHtcbiAgICBsZXQgZW5kID0gdGhpc1tSRUdJU1RFUlNdWyRzcF0gKyAxO1xuICAgIGxldCBzdGFydCA9IGVuZCAtIGl0ZW1zO1xuICAgIHJldHVybiB0aGlzLnN0YWNrLnNsaWNlSW5uZXIoc3RhcnQsIGVuZCk7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICB0aGlzLnN0YWNrLnJlc2V0KCk7XG4gIH1cblxuICB0b0FycmF5KCkge1xuICAgIGNvbnNvbGUubG9nKHRoaXNbUkVHSVNURVJTXSk7XG4gICAgcmV0dXJuIHRoaXMuc3RhY2suc2xpY2VJbm5lcih0aGlzW1JFR0lTVEVSU11bJGZwXSwgdGhpc1tSRUdJU1RFUlNdWyRzcF0gKyAxKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBpc0ltbWVkaWF0ZSh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIG51bWJlciB8IGJvb2xlYW4gfCBudWxsIHwgdW5kZWZpbmVkIHtcbiAgbGV0IHR5cGUgPSB0eXBlb2YgdmFsdWU7XG5cbiAgaWYgKHZhbHVlID09PSBudWxsIHx8IHZhbHVlID09PSB1bmRlZmluZWQpIHJldHVybiB0cnVlO1xuXG4gIHN3aXRjaCAodHlwZSkge1xuICAgIGNhc2UgJ2Jvb2xlYW4nOlxuICAgIGNhc2UgJ3VuZGVmaW5lZCc6XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICBjYXNlICdudW1iZXInOlxuICAgICAgLy8gbm90IGFuIGludGVnZXJcbiAgICAgIGlmICgodmFsdWUgYXMgbnVtYmVyKSAlIDEgIT09IDApIHJldHVybiBmYWxzZTtcblxuICAgICAgbGV0IGFicyA9IE1hdGguYWJzKHZhbHVlIGFzIG51bWJlcik7XG5cbiAgICAgIC8vIHRvbyBiaWdcbiAgICAgIGlmIChhYnMgPiBNQVhfU01JKSByZXR1cm4gZmFsc2U7XG5cbiAgICAgIHJldHVybiB0cnVlO1xuICAgIGRlZmF1bHQ6XG4gICAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGNvbnN0IGVudW0gVHlwZSB7XG4gIE5VTUJFUiA9IDBiMDAwLFxuICBGTE9BVCA9IDBiMDAxLFxuICBTVFJJTkcgPSAwYjAxMCxcbiAgQk9PTEVBTl9PUl9WT0lEID0gMGIwMTEsXG4gIE5FR0FUSVZFID0gMGIxMDAsXG59XG5cbmV4cG9ydCBjb25zdCBlbnVtIEltbWVkaWF0ZXMge1xuICBGYWxzZSA9ICgwIDw8IDMpIHwgVHlwZS5CT09MRUFOX09SX1ZPSUQsXG4gIFRydWUgPSAoMSA8PCAzKSB8IFR5cGUuQk9PTEVBTl9PUl9WT0lELFxuICBOdWxsID0gKDIgPDwgMykgfCBUeXBlLkJPT0xFQU5fT1JfVk9JRCxcbiAgVW5kZWYgPSAoMyA8PCAzKSB8IFR5cGUuQk9PTEVBTl9PUl9WT0lELFxufVxuXG5mdW5jdGlvbiBlbmNvZGVTbWkocHJpbWl0aXZlOiBudW1iZXIpIHtcbiAgaWYgKHByaW1pdGl2ZSA8IDApIHtcbiAgICByZXR1cm4gKE1hdGguYWJzKHByaW1pdGl2ZSkgPDwgMykgfCBQcmltaXRpdmVUeXBlLk5FR0FUSVZFO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiAocHJpbWl0aXZlIDw8IDMpIHwgUHJpbWl0aXZlVHlwZS5OVU1CRVI7XG4gIH1cbn1cblxuZnVuY3Rpb24gZW5jb2RlSW1tZWRpYXRlKHByaW1pdGl2ZTogbnVtYmVyIHwgYm9vbGVhbiB8IG51bGwgfCB1bmRlZmluZWQpOiBudW1iZXIge1xuICBzd2l0Y2ggKHR5cGVvZiBwcmltaXRpdmUpIHtcbiAgICBjYXNlICdudW1iZXInOlxuICAgICAgcmV0dXJuIGVuY29kZVNtaShwcmltaXRpdmUgYXMgbnVtYmVyKTtcbiAgICBjYXNlICdib29sZWFuJzpcbiAgICAgIHJldHVybiBwcmltaXRpdmUgPyBJbW1lZGlhdGVzLlRydWUgOiBJbW1lZGlhdGVzLkZhbHNlO1xuICAgIGNhc2UgJ29iamVjdCc6XG4gICAgICAvLyBhc3N1bWUgbnVsbFxuICAgICAgcmV0dXJuIEltbWVkaWF0ZXMuTnVsbDtcbiAgICBjYXNlICd1bmRlZmluZWQnOlxuICAgICAgcmV0dXJuIEltbWVkaWF0ZXMuVW5kZWY7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IHVucmVhY2hhYmxlKCk7XG4gIH1cbn1cblxuZnVuY3Rpb24gZGVjb2RlU21pKHNtaTogbnVtYmVyKTogbnVtYmVyIHtcbiAgc3dpdGNoIChzbWkgJiAwYjExMSkge1xuICAgIGNhc2UgUHJpbWl0aXZlVHlwZS5OVU1CRVI6XG4gICAgICByZXR1cm4gc21pID4+IDM7XG4gICAgY2FzZSBQcmltaXRpdmVUeXBlLk5FR0FUSVZFOlxuICAgICAgcmV0dXJuIC0oc21pID4+IDMpO1xuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyB1bnJlYWNoYWJsZSgpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGRlY29kZUltbWVkaWF0ZShpbW1lZGlhdGU6IG51bWJlcik6IG51bWJlciB8IGJvb2xlYW4gfCBudWxsIHwgdW5kZWZpbmVkIHtcbiAgc3dpdGNoIChpbW1lZGlhdGUpIHtcbiAgICBjYXNlIEltbWVkaWF0ZXMuRmFsc2U6XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgY2FzZSBJbW1lZGlhdGVzLlRydWU6XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICBjYXNlIEltbWVkaWF0ZXMuTnVsbDpcbiAgICAgIHJldHVybiBudWxsO1xuICAgIGNhc2UgSW1tZWRpYXRlcy5VbmRlZjpcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBkZWNvZGVTbWkoaW1tZWRpYXRlKTtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==