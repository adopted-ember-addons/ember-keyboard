import { $v0 } from '@glimmer/vm';
import { APPEND_OPCODES } from '../../opcodes';
import { FALSE_REFERENCE, TRUE_REFERENCE } from '../../references';
import { ConcatReference } from '../expressions/concat';
import { assert } from '@glimmer/util';

import { stackAssert } from './assert';

import { CONSTANTS } from '../../symbols';
APPEND_OPCODES.add(16 /* Helper */, (vm, { op1: handle }) => {
    let stack = vm.stack;
    let helper = vm.runtime.resolver.resolve(handle);
    let args = stack.pop();
    let value = helper(args, vm);
    vm.loadValue($v0, value);
});
APPEND_OPCODES.add(22 /* GetVariable */, (vm, { op1: symbol }) => {
    let expr = vm.referenceForSymbol(symbol);
    vm.stack.push(expr);
});
APPEND_OPCODES.add(19 /* SetVariable */, (vm, { op1: symbol }) => {
    let expr = vm.stack.pop();
    vm.scope().bindSymbol(symbol, expr);
});
APPEND_OPCODES.add(21 /* SetJitBlock */, (vm, { op1: symbol }) => {
    let handle = vm.stack.pop();
    let scope = vm.stack.pop();
    let table = vm.stack.pop();
    let block = table ? [handle, scope, table] : null;
    vm.scope().bindBlock(symbol, block);
}, 'jit');
APPEND_OPCODES.add(20 /* SetAotBlock */, (vm, { op1: symbol }) => {
    let handle = vm.stack.pop();
    let scope = vm.stack.pop();
    let table = vm.stack.pop();
    let block = table ? [handle, scope, table] : null;
    vm.scope().bindBlock(symbol, block);
});
APPEND_OPCODES.add(104 /* ResolveMaybeLocal */, (vm, { op1: _name }) => {
    let name = vm[CONSTANTS].getString(_name);
    let locals = vm.scope().getPartialMap();
    let ref = locals[name];
    if (ref === undefined) {
        ref = vm.getSelf().get(name);
    }
    vm.stack.push(ref);
});
APPEND_OPCODES.add(36 /* RootScope */, (vm, { op1: symbols }) => {
    vm.pushRootScope(symbols);
});
APPEND_OPCODES.add(23 /* GetProperty */, (vm, { op1: _key }) => {
    let key = vm[CONSTANTS].getString(_key);
    let expr = vm.stack.pop();
    vm.stack.push(expr.get(key));
});
APPEND_OPCODES.add(24 /* GetBlock */, (vm, { op1: _block }) => {
    let { stack } = vm;
    let block = vm.scope().getBlock(_block);
    if (block) {
        stack.push(block[2]);
        stack.push(block[1]);
        stack.push(block[0]);
    } else {
        stack.push(null);
        stack.push(null);
        stack.push(null);
    }
});
APPEND_OPCODES.add(25 /* HasBlock */, (vm, { op1: _block }) => {
    let hasBlock = !!vm.scope().getBlock(_block);
    vm.stack.push(hasBlock ? TRUE_REFERENCE : FALSE_REFERENCE);
});
APPEND_OPCODES.add(26 /* HasBlockParams */, vm => {
    // FIXME(mmun): should only need to push the symbol table
    let block = vm.stack.pop();
    let scope = vm.stack.pop();

    let table = vm.stack.pop();
    (false && assert(table === null || table && typeof table === 'object' && Array.isArray(table.parameters), stackAssert('Option<BlockSymbolTable>', table)));

    let hasBlockParams = table && table.parameters.length;
    vm.stack.push(hasBlockParams ? TRUE_REFERENCE : FALSE_REFERENCE);
});
APPEND_OPCODES.add(27 /* Concat */, (vm, { op1: count }) => {
    let out = new Array(count);
    for (let i = count; i > 0; i--) {
        let offset = i - 1;
        out[offset] = vm.stack.pop();
    }
    vm.stack.push(new ConcatReference(out));
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvZXhwcmVzc2lvbnMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBRUEsU0FBUyxHQUFULFFBQW9CLGFBQXBCO0FBQ0EsU0FBUyxjQUFULFFBQStCLGVBQS9CO0FBQ0EsU0FBUyxlQUFULEVBQTBCLGNBQTFCLFFBQWdELGtCQUFoRDtBQUNBLFNBQVMsZUFBVCxRQUFnQyx1QkFBaEM7QUFDQSxTQUFTLE1BQVQsUUFBdUIsZUFBdkI7O0FBRUEsU0FBUyxXQUFULFFBQTRCLFVBQTVCOztBQVFBLFNBQVMsU0FBVCxRQUEwQixlQUExQjtBQUlBLGVBQWUsR0FBZixDQUFrQixFQUFsQixDQUFrQixZQUFsQixFQUE4QixDQUFDLEVBQUQsRUFBSyxFQUFFLEtBQUssTUFBUCxFQUFMLEtBQXdCO0FBQ3BELFFBQUksUUFBUSxHQUFHLEtBQWY7QUFDQSxRQUFJLFNBQWUsR0FBRyxPQUFILENBQVcsUUFBWCxDQUFvQixPQUFwQixDQUE0QixNQUE1QixDQUFuQjtBQUNBLFFBQUksT0FBYSxNQUFNLEdBQU4sRUFBakI7QUFDQSxRQUFJLFFBQVEsT0FBTyxJQUFQLEVBQWEsRUFBYixDQUFaO0FBRUEsT0FBRyxTQUFILENBQWEsR0FBYixFQUFrQixLQUFsQjtBQUNELENBUEQ7QUFTQSxlQUFlLEdBQWYsQ0FBa0IsRUFBbEIsQ0FBa0IsaUJBQWxCLEVBQW1DLENBQUMsRUFBRCxFQUFLLEVBQUUsS0FBSyxNQUFQLEVBQUwsS0FBd0I7QUFDekQsUUFBSSxPQUFPLEdBQUcsa0JBQUgsQ0FBc0IsTUFBdEIsQ0FBWDtBQUNBLE9BQUcsS0FBSCxDQUFTLElBQVQsQ0FBYyxJQUFkO0FBQ0QsQ0FIRDtBQUtBLGVBQWUsR0FBZixDQUFrQixFQUFsQixDQUFrQixpQkFBbEIsRUFBbUMsQ0FBQyxFQUFELEVBQUssRUFBRSxLQUFLLE1BQVAsRUFBTCxLQUF3QjtBQUN6RCxR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QTJCLEdBQTNCLEVBQWdDO0FBQzlCLFlBQUksU0FBUyxJQUFJLENBQWpCO0FBQ0EsWUFBSSxNQUFKLElBQW9CLEdBQUcsS0FBSCxDQUFTLEdBQVQsRUFBcEI7QUFDRDtBQUVELE9BQUcsS0FBSCxDQUFTLElBQVQsQ0FBYyxJQUFJLGVBQUosQ0FBb0IsR0FBcEIsQ0FBZDtBQUNELENBVEQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBPcHRpb24sIE9wLCBKaXRTY29wZUJsb2NrLCBBb3RTY29wZUJsb2NrLCBWTSBhcyBQdWJsaWNWTSB9IGZyb20gJ0BnbGltbWVyL2ludGVyZmFjZXMnO1xuaW1wb3J0IHsgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZSB9IGZyb20gJ0BnbGltbWVyL3JlZmVyZW5jZSc7XG5pbXBvcnQgeyAkdjAgfSBmcm9tICdAZ2xpbW1lci92bSc7XG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUyB9IGZyb20gJy4uLy4uL29wY29kZXMnO1xuaW1wb3J0IHsgRkFMU0VfUkVGRVJFTkNFLCBUUlVFX1JFRkVSRU5DRSB9IGZyb20gJy4uLy4uL3JlZmVyZW5jZXMnO1xuaW1wb3J0IHsgQ29uY2F0UmVmZXJlbmNlIH0gZnJvbSAnLi4vZXhwcmVzc2lvbnMvY29uY2F0JztcbmltcG9ydCB7IGFzc2VydCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgY2hlY2ssIENoZWNrT3B0aW9uLCBDaGVja0hhbmRsZSwgQ2hlY2tCbG9ja1N5bWJvbFRhYmxlLCBDaGVja09yIH0gZnJvbSAnQGdsaW1tZXIvZGVidWcnO1xuaW1wb3J0IHsgc3RhY2tBc3NlcnQgfSBmcm9tICcuL2Fzc2VydCc7XG5pbXBvcnQge1xuICBDaGVja0FyZ3VtZW50cyxcbiAgQ2hlY2tQYXRoUmVmZXJlbmNlLFxuICBDaGVja0NvbXBpbGFibGVCbG9jayxcbiAgQ2hlY2tTY29wZSxcbiAgQ2hlY2tIZWxwZXIsXG59IGZyb20gJy4vLWRlYnVnLXN0cmlwJztcbmltcG9ydCB7IENPTlNUQU5UUyB9IGZyb20gJy4uLy4uL3N5bWJvbHMnO1xuXG5leHBvcnQgdHlwZSBGdW5jdGlvbkV4cHJlc3Npb248VD4gPSAodm06IFB1YmxpY1ZNKSA9PiBWZXJzaW9uZWRQYXRoUmVmZXJlbmNlPFQ+O1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuSGVscGVyLCAodm0sIHsgb3AxOiBoYW5kbGUgfSkgPT4ge1xuICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgbGV0IGhlbHBlciA9IGNoZWNrKHZtLnJ1bnRpbWUucmVzb2x2ZXIucmVzb2x2ZShoYW5kbGUpLCBDaGVja0hlbHBlcik7XG4gIGxldCBhcmdzID0gY2hlY2soc3RhY2sucG9wKCksIENoZWNrQXJndW1lbnRzKTtcbiAgbGV0IHZhbHVlID0gaGVscGVyKGFyZ3MsIHZtKTtcblxuICB2bS5sb2FkVmFsdWUoJHYwLCB2YWx1ZSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkdldFZhcmlhYmxlLCAodm0sIHsgb3AxOiBzeW1ib2wgfSkgPT4ge1xuICBsZXQgZXhwciA9IHZtLnJlZmVyZW5jZUZvclN5bWJvbChzeW1ib2wpO1xuICB2bS5zdGFjay5wdXNoKGV4cHIpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5TZXRWYXJpYWJsZSwgKHZtLCB7IG9wMTogc3ltYm9sIH0pID0+IHtcbiAgbGV0IGV4cHIgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tQYXRoUmVmZXJlbmNlKTtcbiAgdm0uc2NvcGUoKS5iaW5kU3ltYm9sKHN5bWJvbCwgZXhwcik7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKFxuICBPcC5TZXRKaXRCbG9jayxcbiAgKHZtLCB7IG9wMTogc3ltYm9sIH0pID0+IHtcbiAgICBsZXQgaGFuZGxlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrT3B0aW9uKENoZWNrQ29tcGlsYWJsZUJsb2NrKSk7XG4gICAgbGV0IHNjb3BlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrU2NvcGUpO1xuICAgIGxldCB0YWJsZSA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja09wdGlvbihDaGVja0Jsb2NrU3ltYm9sVGFibGUpKTtcblxuICAgIGxldCBibG9jazogT3B0aW9uPEppdFNjb3BlQmxvY2s+ID0gdGFibGUgPyBbaGFuZGxlISwgc2NvcGUsIHRhYmxlXSA6IG51bGw7XG5cbiAgICB2bS5zY29wZSgpLmJpbmRCbG9jayhzeW1ib2wsIGJsb2NrKTtcbiAgfSxcbiAgJ2ppdCdcbik7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5TZXRBb3RCbG9jaywgKHZtLCB7IG9wMTogc3ltYm9sIH0pID0+IHtcbiAgbGV0IGhhbmRsZSA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja09wdGlvbihDaGVja0hhbmRsZSkpO1xuICBsZXQgc2NvcGUgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tTY29wZSk7XG4gIGxldCB0YWJsZSA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja09wdGlvbihDaGVja0Jsb2NrU3ltYm9sVGFibGUpKTtcblxuICBsZXQgYmxvY2s6IE9wdGlvbjxBb3RTY29wZUJsb2NrPiA9IHRhYmxlID8gW2hhbmRsZSEsIHNjb3BlLCB0YWJsZV0gOiBudWxsO1xuXG4gIHZtLnNjb3BlKCkuYmluZEJsb2NrKHN5bWJvbCwgYmxvY2spO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5SZXNvbHZlTWF5YmVMb2NhbCwgKHZtLCB7IG9wMTogX25hbWUgfSkgPT4ge1xuICBsZXQgbmFtZSA9IHZtW0NPTlNUQU5UU10uZ2V0U3RyaW5nKF9uYW1lKTtcbiAgbGV0IGxvY2FscyA9IHZtLnNjb3BlKCkuZ2V0UGFydGlhbE1hcCgpITtcblxuICBsZXQgcmVmID0gbG9jYWxzW25hbWVdO1xuICBpZiAocmVmID09PSB1bmRlZmluZWQpIHtcbiAgICByZWYgPSB2bS5nZXRTZWxmKCkuZ2V0KG5hbWUpO1xuICB9XG5cbiAgdm0uc3RhY2sucHVzaChyZWYpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5Sb290U2NvcGUsICh2bSwgeyBvcDE6IHN5bWJvbHMgfSkgPT4ge1xuICB2bS5wdXNoUm9vdFNjb3BlKHN5bWJvbHMpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5HZXRQcm9wZXJ0eSwgKHZtLCB7IG9wMTogX2tleSB9KSA9PiB7XG4gIGxldCBrZXkgPSB2bVtDT05TVEFOVFNdLmdldFN0cmluZyhfa2V5KTtcbiAgbGV0IGV4cHIgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tQYXRoUmVmZXJlbmNlKTtcbiAgdm0uc3RhY2sucHVzaChleHByLmdldChrZXkpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuR2V0QmxvY2ssICh2bSwgeyBvcDE6IF9ibG9jayB9KSA9PiB7XG4gIGxldCB7IHN0YWNrIH0gPSB2bTtcbiAgbGV0IGJsb2NrID0gdm0uc2NvcGUoKS5nZXRCbG9jayhfYmxvY2spO1xuXG4gIGlmIChibG9jaykge1xuICAgIHN0YWNrLnB1c2goYmxvY2tbMl0pO1xuICAgIHN0YWNrLnB1c2goYmxvY2tbMV0pO1xuICAgIHN0YWNrLnB1c2goYmxvY2tbMF0pO1xuICB9IGVsc2Uge1xuICAgIHN0YWNrLnB1c2gobnVsbCk7XG4gICAgc3RhY2sucHVzaChudWxsKTtcbiAgICBzdGFjay5wdXNoKG51bGwpO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkhhc0Jsb2NrLCAodm0sIHsgb3AxOiBfYmxvY2sgfSkgPT4ge1xuICBsZXQgaGFzQmxvY2sgPSAhIXZtLnNjb3BlKCkuZ2V0QmxvY2soX2Jsb2NrKTtcbiAgdm0uc3RhY2sucHVzaChoYXNCbG9jayA/IFRSVUVfUkVGRVJFTkNFIDogRkFMU0VfUkVGRVJFTkNFKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuSGFzQmxvY2tQYXJhbXMsIHZtID0+IHtcbiAgLy8gRklYTUUobW11bik6IHNob3VsZCBvbmx5IG5lZWQgdG8gcHVzaCB0aGUgc3ltYm9sIHRhYmxlXG4gIGxldCBibG9jayA9IHZtLnN0YWNrLnBvcCgpO1xuICBsZXQgc2NvcGUgPSB2bS5zdGFjay5wb3AoKTtcbiAgY2hlY2soYmxvY2ssIENoZWNrT3B0aW9uKENoZWNrT3IoQ2hlY2tIYW5kbGUsIENoZWNrQ29tcGlsYWJsZUJsb2NrKSkpO1xuICBjaGVjayhzY29wZSwgQ2hlY2tPcHRpb24oQ2hlY2tTY29wZSkpO1xuICBsZXQgdGFibGUgPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tPcHRpb24oQ2hlY2tCbG9ja1N5bWJvbFRhYmxlKSk7XG5cbiAgYXNzZXJ0KFxuICAgIHRhYmxlID09PSBudWxsIHx8ICh0YWJsZSAmJiB0eXBlb2YgdGFibGUgPT09ICdvYmplY3QnICYmIEFycmF5LmlzQXJyYXkodGFibGUucGFyYW1ldGVycykpLFxuICAgIHN0YWNrQXNzZXJ0KCdPcHRpb248QmxvY2tTeW1ib2xUYWJsZT4nLCB0YWJsZSlcbiAgKTtcblxuICBsZXQgaGFzQmxvY2tQYXJhbXMgPSB0YWJsZSAmJiB0YWJsZS5wYXJhbWV0ZXJzLmxlbmd0aDtcbiAgdm0uc3RhY2sucHVzaChoYXNCbG9ja1BhcmFtcyA/IFRSVUVfUkVGRVJFTkNFIDogRkFMU0VfUkVGRVJFTkNFKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQ29uY2F0LCAodm0sIHsgb3AxOiBjb3VudCB9KSA9PiB7XG4gIGxldCBvdXQ6IEFycmF5PFZlcnNpb25lZFBhdGhSZWZlcmVuY2U8dW5rbm93bj4+ID0gbmV3IEFycmF5KGNvdW50KTtcblxuICBmb3IgKGxldCBpID0gY291bnQ7IGkgPiAwOyBpLS0pIHtcbiAgICBsZXQgb2Zmc2V0ID0gaSAtIDE7XG4gICAgb3V0W29mZnNldF0gPSBjaGVjayh2bS5zdGFjay5wb3AoKSwgQ2hlY2tQYXRoUmVmZXJlbmNlKTtcbiAgfVxuXG4gIHZtLnN0YWNrLnB1c2gobmV3IENvbmNhdFJlZmVyZW5jZShvdXQpKTtcbn0pO1xuIl0sInNvdXJjZVJvb3QiOiIifQ==