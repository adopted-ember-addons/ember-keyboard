import { ReferenceCache, isConst, isConstTag, value, validate } from '@glimmer/reference';

import { $t0 } from '@glimmer/vm';
import { APPEND_OPCODES, UpdatingOpcode } from '../../opcodes';
import { Assert } from './vm';

import { CONSTANTS } from '../../symbols';

APPEND_OPCODES.add(40 /* Text */, (vm, { op1: text }) => {
    vm.elements().appendText(vm[CONSTANTS].getString(text));
});
APPEND_OPCODES.add(41 /* Comment */, (vm, { op1: text }) => {
    vm.elements().appendComment(vm[CONSTANTS].getString(text));
});
APPEND_OPCODES.add(47 /* OpenElement */, (vm, { op1: tag }) => {
    vm.elements().openElement(vm[CONSTANTS].getString(tag));
});
APPEND_OPCODES.add(48 /* OpenDynamicElement */, vm => {
    let tagName = vm.stack.pop().value();
    vm.elements().openElement(tagName);
});
APPEND_OPCODES.add(49 /* PushRemoteElement */, vm => {
    let elementRef = vm.stack.pop();
    let insertBeforeRef = vm.stack.pop();
    let guidRef = vm.stack.pop();
    let element;
    let insertBefore;
    let guid = guidRef.value();
    if (isConst(elementRef)) {
        element = elementRef.value();
    } else {
        let cache = new ReferenceCache(elementRef);
        element = cache.peek();
        vm.updateWith(new Assert(cache));
    }
    if (insertBeforeRef.value() !== undefined) {
        if (isConst(insertBeforeRef)) {
            insertBefore = insertBeforeRef.value();
        } else {
            let cache = new ReferenceCache(insertBeforeRef);
            insertBefore = cache.peek();
            vm.updateWith(new Assert(cache));
        }
    }
    let block = vm.elements().pushRemoteElement(element, guid, insertBefore);
    if (block) vm.associateDestroyable(block);
});
APPEND_OPCODES.add(55 /* PopRemoteElement */, vm => {
    vm.elements().popRemoteElement();
});
APPEND_OPCODES.add(53 /* FlushElement */, vm => {
    let operations = vm.fetchValue($t0);
    let modifiers = null;
    if (operations) {
        modifiers = operations.flush(vm);
        vm.loadValue($t0, null);
    }
    vm.elements().flushElement(modifiers);
});
APPEND_OPCODES.add(54 /* CloseElement */, vm => {
    let modifiers = vm.elements().closeElement();
    if (modifiers) {
        modifiers.forEach(([manager, modifier]) => {
            vm.env.scheduleInstallModifier(modifier, manager);
            let d = manager.getDestructor(modifier);
            if (d) {
                vm.associateDestroyable(d);
            }
        });
    }
});
APPEND_OPCODES.add(56 /* Modifier */, (vm, { op1: handle }) => {
    let { manager, state } = vm.runtime.resolver.resolve(handle);
    let stack = vm.stack;
    let args = stack.pop();
    let { constructing, updateOperations } = vm.elements();
    let dynamicScope = vm.dynamicScope();
    let modifier = manager.create(constructing, state, args, dynamicScope, updateOperations);
    let operations = vm.fetchValue($t0);
    operations.addModifier(manager, modifier);
    let tag = manager.getTag(modifier);
    if (!isConstTag(tag)) {
        vm.updateWith(new UpdateModifierOpcode(tag, manager, modifier));
    }
});
export class UpdateModifierOpcode extends UpdatingOpcode {
    constructor(tag, manager, modifier) {
        super();
        this.tag = tag;
        this.manager = manager;
        this.modifier = modifier;
        this.type = 'update-modifier';
        this.lastUpdated = value(tag);
    }
    evaluate(vm) {
        let { manager, modifier, tag, lastUpdated } = this;
        if (!validate(tag, lastUpdated)) {
            vm.env.scheduleUpdateModifier(modifier, manager);
            this.lastUpdated = value(tag);
        }
    }
}
APPEND_OPCODES.add(50 /* StaticAttr */, (vm, { op1: _name, op2: _value, op3: _namespace }) => {
    let name = vm[CONSTANTS].getString(_name);
    let value = vm[CONSTANTS].getString(_value);
    let namespace = _namespace ? vm[CONSTANTS].getString(_namespace) : null;
    vm.elements().setStaticAttribute(name, value, namespace);
});
APPEND_OPCODES.add(51 /* DynamicAttr */, (vm, { op1: _name, op2: trusting, op3: _namespace }) => {
    let name = vm[CONSTANTS].getString(_name);
    let reference = vm.stack.pop();
    let value = reference.value();
    let namespace = _namespace ? vm[CONSTANTS].getString(_namespace) : null;
    let attribute = vm.elements().setDynamicAttribute(name, value, !!trusting, namespace);
    if (!isConst(reference)) {
        vm.updateWith(new UpdateDynamicAttributeOpcode(reference, attribute));
    }
});
export class UpdateDynamicAttributeOpcode extends UpdatingOpcode {
    constructor(reference, attribute) {
        super();
        this.reference = reference;
        this.attribute = attribute;
        this.type = 'patch-element';
        let { tag } = reference;
        this.tag = tag;
        this.lastRevision = value(tag);
    }
    evaluate(vm) {
        let { attribute, reference, tag } = this;
        if (!validate(tag, this.lastRevision)) {
            this.lastRevision = value(tag);
            attribute.update(reference.value(), vm.env);
        }
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvZG9tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBRUUsY0FGRixFQU1FLE9BTkYsRUFPRSxVQVBGLEVBUUUsS0FSRixFQVNFLFFBVEYsUUFVTyxvQkFWUDs7QUFhQSxTQUFTLEdBQVQsUUFBb0IsYUFBcEI7QUFNQSxTQUFTLGNBQVQsRUFBeUIsY0FBekIsUUFBK0MsZUFBL0M7QUFFQSxTQUFTLE1BQVQsUUFBdUIsTUFBdkI7O0FBR0EsU0FBUyxTQUFULFFBQTBCLGVBQTFCOztBQUlBLGVBQWUsR0FBZixDQUFrQixFQUFsQixDQUFrQixVQUFsQixFQUE0QixDQUFDLEVBQUQsRUFBSyxFQUFFLEtBQUssSUFBUCxFQUFMLEtBQXNCO0FBQ2hELE9BQUcsUUFBSCxHQUFjLFVBQWQsQ0FBeUIsR0FBRyxTQUFILEVBQWMsU0FBZCxDQUF3QixJQUF4QixDQUF6QjtBQUNELENBRkQ7QUFJQSxlQUFlLEdBQWYsQ0FBa0IsRUFBbEIsQ0FBa0IsYUFBbEIsRUFBK0IsQ0FBQyxFQUFELEVBQUssRUFBRSxLQUFLLElBQVAsRUFBTCxLQUFzQjtBQUNuRCxPQUFHLFFBQUgsR0FBYyxhQUFkLENBQTRCLEdBQUcsU0FBSCxFQUFjLFNBQWQsQ0FBd0IsSUFBeEIsQ0FBNUI7QUFDRCxDQUZEO0FBSUEsZUFBZSxHQUFmLENBQWtCLEVBQWxCLENBQWtCLGlCQUFsQixFQUFtQyxDQUFDLEVBQUQsRUFBSyxFQUFFLEtBQUssR0FBUCxFQUFMLEtBQXFCO0FBQ3RELE9BQUcsUUFBSCxHQUFjLFdBQWQsQ0FBMEIsR0FBRyxTQUFILEVBQWMsU0FBZCxDQUF3QixHQUF4QixDQUExQjtBQUNELENBRkQ7QUFJQSxlQUFlLEdBQWYsQ0FBa0IsRUFBbEIsQ0FBa0Isd0JBQWxCLEVBQTBDLE1BQUs7QUFDN0MsUUFBSSxVQUFzQixHQUFHLEtBQUgsQ0FBUyxHQUFULEVB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QUFQLFNBQTRDLGNBQTVDLENBQTBEO0FBTTlELGdCQUFvQixTQUFwQixFQUFvRSxTQUFwRSxFQUErRjtBQUM3RjtBQURrQixhQUFBLFNBQUEsR0FBQSxTQUFBO0FBQWdELGFBQUEsU0FBQSxHQUFBLFNBQUE7QUFMN0QsYUFBQSxJQUFBLEdBQU8sZUFBUDtBQU9MLFlBQUksRUFBRSxHQUFGLEtBQVUsU0FBZDtBQUNBLGFBQUssR0FBTCxHQUFXLEdBQVg7QUFDQSxhQUFLLFlBQUwsR0FBb0IsTUFBTSxHQUFOLENBQXBCO0FBQ0Q7QUFFRCxhQUFTLEVBQVQsRUFBdUI7QUFDckIsWUFBSSxFQUFFLFNBQUYsRUFBYSxTQUFiLEVBQXdCLEdBQXhCLEtBQWdDLElBQXBDO0FBQ0EsWUFBSSxDQUFDLFNBQVMsR0FBVCxFQUFjLEtBQUssWUFBbkIsQ0FBTCxFQUF1QztBQUNyQyxpQkFBSyxZQUFMLEdBQW9CLE1BQU0sR0FBTixDQUFwQjtBQUNBLHNCQUFVLE1BQVYsQ0FBaUIsVUFBVSxLQUFWLEVBQWpCLEVBQW9DLEdBQUcsR0FBdkM7QUFDRDtBQUNGO0FBbkI2RCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJlZmVyZW5jZSxcbiAgUmVmZXJlbmNlQ2FjaGUsXG4gIFJldmlzaW9uLFxuICBUYWcsXG4gIFZlcnNpb25lZFJlZmVyZW5jZSxcbiAgaXNDb25zdCxcbiAgaXNDb25zdFRhZyxcbiAgdmFsdWUsXG4gIHZhbGlkYXRlLFxufSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgY2hlY2ssIENoZWNrU3RyaW5nLCBDaGVja0VsZW1lbnQsIENoZWNrT3B0aW9uLCBDaGVja05vZGUgfSBmcm9tICdAZ2xpbW1lci9kZWJ1Zyc7XG5pbXBvcnQgeyBPcCwgT3B0aW9uLCBNb2RpZmllck1hbmFnZXIgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7ICR0MCB9IGZyb20gJ0BnbGltbWVyL3ZtJztcbmltcG9ydCB7XG4gIE1vZGlmaWVyRGVmaW5pdGlvbixcbiAgSW50ZXJuYWxNb2RpZmllck1hbmFnZXIsXG4gIE1vZGlmaWVySW5zdGFuY2VTdGF0ZSxcbn0gZnJvbSAnLi4vLi4vbW9kaWZpZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUywgVXBkYXRpbmdPcGNvZGUgfSBmcm9tICcuLi8uLi9vcGNvZGVzJztcbmltcG9ydCB7IFVwZGF0aW5nVk0gfSBmcm9tICcuLi8uLi92bSc7XG5pbXBvcnQgeyBBc3NlcnQgfSBmcm9tICcuL3ZtJztcbmltcG9ydCB7IER5bmFtaWNBdHRyaWJ1dGUgfSBmcm9tICcuLi8uLi92bS9hdHRyaWJ1dGVzL2R5bmFtaWMnO1xuaW1wb3J0IHsgQ2hlY2tSZWZlcmVuY2UsIENoZWNrQXJndW1lbnRzLCBDaGVja09wZXJhdGlvbnMgfSBmcm9tICcuLy1kZWJ1Zy1zdHJpcCc7XG5pbXBvcnQgeyBDT05TVEFOVFMgfSBmcm9tICcuLi8uLi9zeW1ib2xzJztcbmltcG9ydCB7IFNpbXBsZUVsZW1lbnQsIFNpbXBsZU5vZGUgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZXhwZWN0LCBNYXliZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuVGV4dCwgKHZtLCB7IG9wMTogdGV4dCB9KSA9PiB7XG4gIHZtLmVsZW1lbnRzKCkuYXBwZW5kVGV4dCh2bVtDT05TVEFOVFNdLmdldFN0cmluZyh0ZXh0KSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkNvbW1lbnQsICh2bSwgeyBvcDE6IHRleHQgfSkgPT4ge1xuICB2bS5lbGVtZW50cygpLmFwcGVuZENvbW1lbnQodm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcodGV4dCkpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5PcGVuRWxlbWVudCwgKHZtLCB7IG9wMTogdGFnIH0pID0+IHtcbiAgdm0uZWxlbWVudHMoKS5vcGVuRWxlbWVudCh2bVtDT05TVEFOVFNdLmdldFN0cmluZyh0YWcpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuT3BlbkR5bmFtaWNFbGVtZW50LCB2bSA9PiB7XG4gIGxldCB0YWdOYW1lID0gY2hlY2soY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKS52YWx1ZSgpLCBDaGVja1N0cmluZyk7XG4gIHZtLmVsZW1lbnRzKCkub3BlbkVsZW1lbnQodGFnTmFtZSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlB1c2hSZW1vdGVFbGVtZW50LCB2bSA9PiB7XG4gIGxldCBlbGVtZW50UmVmID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcbiAgbGV0IGluc2VydEJlZm9yZVJlZiA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja1JlZmVyZW5jZSk7XG4gIGxldCBndWlkUmVmID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBsZXQgZWxlbWVudDogU2ltcGxlRWxlbWVudDtcbiAgbGV0IGluc2VydEJlZm9yZTogTWF5YmU8U2ltcGxlTm9kZT47XG4gIGxldCBndWlkID0gZ3VpZFJlZi52YWx1ZSgpIGFzIHN0cmluZztcblxuICBpZiAoaXNDb25zdChlbGVtZW50UmVmKSkge1xuICAgIGVsZW1lbnQgPSBjaGVjayhlbGVtZW50UmVmLnZhbHVlKCksIENoZWNrRWxlbWVudCk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGNhY2hlID0gbmV3IFJlZmVyZW5jZUNhY2hlKGVsZW1lbnRSZWYgYXMgUmVmZXJlbmNlPFNpbXBsZUVsZW1lbnQ+KTtcbiAgICBlbGVtZW50ID0gY2hlY2soY2FjaGUucGVlaygpLCBDaGVja0VsZW1lbnQpO1xuICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICB9XG5cbiAgaWYgKGluc2VydEJlZm9yZVJlZi52YWx1ZSgpICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoaXNDb25zdChpbnNlcnRCZWZvcmVSZWYpKSB7XG4gICAgICBpbnNlcnRCZWZvcmUgPSBjaGVjayhpbnNlcnRCZWZvcmVSZWYudmFsdWUoKSwgQ2hlY2tPcHRpb24oQ2hlY2tOb2RlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjYWNoZSA9IG5ldyBSZWZlcmVuY2VDYWNoZShpbnNlcnRCZWZvcmVSZWYgYXMgUmVmZXJlbmNlPE9wdGlvbjxTaW1wbGVOb2RlPj4pO1xuICAgICAgaW5zZXJ0QmVmb3JlID0gY2hlY2soY2FjaGUucGVlaygpLCBDaGVja09wdGlvbihDaGVja05vZGUpKTtcbiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBibG9jayA9IHZtLmVsZW1lbnRzKCkucHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgZ3VpZCwgaW5zZXJ0QmVmb3JlKTtcbiAgaWYgKGJsb2NrKSB2bS5hc3NvY2lhdGVEZXN0cm95YWJsZShibG9jayk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlBvcFJlbW90ZUVsZW1lbnQsIHZtID0+IHtcbiAgdm0uZWxlbWVudHMoKS5wb3BSZW1vdGVFbGVtZW50KCk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkZsdXNoRWxlbWVudCwgdm0gPT4ge1xuICBsZXQgb3BlcmF0aW9ucyA9IGNoZWNrKHZtLmZldGNoVmFsdWUoJHQwKSwgQ2hlY2tPcGVyYXRpb25zKTtcbiAgbGV0IG1vZGlmaWVyczogT3B0aW9uPFtNb2RpZmllck1hbmFnZXIsIHVua25vd25dW10+ID0gbnVsbDtcblxuICBpZiAob3BlcmF0aW9ucykge1xuICAgIG1vZGlmaWVycyA9IG9wZXJhdGlvbnMuZmx1c2godm0pO1xuICAgIHZtLmxvYWRWYWx1ZSgkdDAsIG51bGwpO1xuICB9XG5cbiAgdm0uZWxlbWVudHMoKS5mbHVzaEVsZW1lbnQobW9kaWZpZXJzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQ2xvc2VFbGVtZW50LCB2bSA9PiB7XG4gIGxldCBtb2RpZmllcnMgPSB2bS5lbGVtZW50cygpLmNsb3NlRWxlbWVudCgpO1xuXG4gIGlmIChtb2RpZmllcnMpIHtcbiAgICBtb2RpZmllcnMuZm9yRWFjaCgoW21hbmFnZXIsIG1vZGlmaWVyXSkgPT4ge1xuICAgICAgdm0uZW52LnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKTtcbiAgICAgIGxldCBkID0gbWFuYWdlci5nZXREZXN0cnVjdG9yKG1vZGlmaWVyKTtcblxuICAgICAgaWYgKGQpIHtcbiAgICAgICAgdm0uYXNzb2NpYXRlRGVzdHJveWFibGUoZCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuTW9kaWZpZXIsICh2bSwgeyBvcDE6IGhhbmRsZSB9KSA9PiB7XG4gIGxldCB7IG1hbmFnZXIsIHN0YXRlIH0gPSB2bS5ydW50aW1lLnJlc29sdmVyLnJlc29sdmU8TW9kaWZpZXJEZWZpbml0aW9uPihoYW5kbGUpO1xuICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgbGV0IGFyZ3MgPSBjaGVjayhzdGFjay5wb3AoKSwgQ2hlY2tBcmd1bWVudHMpO1xuICBsZXQgeyBjb25zdHJ1Y3RpbmcsIHVwZGF0ZU9wZXJhdGlvbnMgfSA9IHZtLmVsZW1lbnRzKCk7XG4gIGxldCBkeW5hbWljU2NvcGUgPSB2bS5keW5hbWljU2NvcGUoKTtcbiAgbGV0IG1vZGlmaWVyID0gbWFuYWdlci5jcmVhdGUoXG4gICAgZXhwZWN0KGNvbnN0cnVjdGluZywgJ0JVRzogRWxlbWVudE1vZGlmaWVyIGNvdWxkIG5vdCBmaW5kIHRoZSBlbGVtZW50IGl0IGFwcGxpZXMgdG8nKSxcbiAgICBzdGF0ZSxcbiAgICBhcmdzLFxuICAgIGR5bmFtaWNTY29wZSxcbiAgICB1cGRhdGVPcGVyYXRpb25zXG4gICk7XG5cbiAgbGV0IG9wZXJhdGlvbnMgPSBleHBlY3QoXG4gICAgY2hlY2sodm0uZmV0Y2hWYWx1ZSgkdDApLCBDaGVja09wZXJhdGlvbnMpLFxuICAgICdCVUc6IEVsZW1lbnRNb2RpZmllciBjb3VsZCBub3QgZmluZCBvcGVyYXRpb25zIHRvIGFwcGVuZCB0bydcbiAgKTtcblxuICBvcGVyYXRpb25zLmFkZE1vZGlmaWVyKG1hbmFnZXIsIG1vZGlmaWVyKTtcblxuICBsZXQgdGFnID0gbWFuYWdlci5nZXRUYWcobW9kaWZpZXIpO1xuXG4gIGlmICghaXNDb25zdFRhZyh0YWcpKSB7XG4gICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlTW9kaWZpZXJPcGNvZGUodGFnLCBtYW5hZ2VyLCBtb2RpZmllcikpO1xuICB9XG59KTtcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZU1vZGlmaWVyT3Bjb2RlIGV4dGVuZHMgVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9ICd1cGRhdGUtbW9kaWZpZXInO1xuICBwcml2YXRlIGxhc3RVcGRhdGVkOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgdGFnOiBUYWcsXG4gICAgcHJpdmF0ZSBtYW5hZ2VyOiBJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcixcbiAgICBwcml2YXRlIG1vZGlmaWVyOiBNb2RpZmllckluc3RhbmNlU3RhdGVcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmxhc3RVcGRhdGVkID0gdmFsdWUodGFnKTtcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgbGV0IHsgbWFuYWdlciwgbW9kaWZpZXIsIHRhZywgbGFzdFVwZGF0ZWQgfSA9IHRoaXM7XG5cbiAgICBpZiAoIXZhbGlkYXRlKHRhZywgbGFzdFVwZGF0ZWQpKSB7XG4gICAgICB2bS5lbnYuc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7XG4gICAgICB0aGlzLmxhc3RVcGRhdGVkID0gdmFsdWUodGFnKTtcbiAgICB9XG4gIH1cbn1cblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlN0YXRpY0F0dHIsICh2bSwgeyBvcDE6IF9uYW1lLCBvcDI6IF92YWx1ZSwgb3AzOiBfbmFtZXNwYWNlIH0pID0+IHtcbiAgbGV0IG5hbWUgPSB2bVtDT05TVEFOVFNdLmdldFN0cmluZyhfbmFtZSk7XG4gIGxldCB2YWx1ZSA9IHZtW0NPTlNUQU5UU10uZ2V0U3RyaW5nKF92YWx1ZSk7XG4gIGxldCBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWVzcGFjZSkgOiBudWxsO1xuXG4gIHZtLmVsZW1lbnRzKCkuc2V0U3RhdGljQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5EeW5hbWljQXR0ciwgKHZtLCB7IG9wMTogX25hbWUsIG9wMjogdHJ1c3RpbmcsIG9wMzogX25hbWVzcGFjZSB9KSA9PiB7XG4gIGxldCBuYW1lID0gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWUpO1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcbiAgbGV0IHZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7XG4gIGxldCBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWVzcGFjZSkgOiBudWxsO1xuXG4gIGxldCBhdHRyaWJ1dGUgPSB2bS5lbGVtZW50cygpLnNldER5bmFtaWNBdHRyaWJ1dGUobmFtZSwgdmFsdWUsICEhdHJ1c3RpbmcsIG5hbWVzcGFjZSk7XG5cbiAgaWYgKCFpc0NvbnN0KHJlZmVyZW5jZSkpIHtcbiAgICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlKHJlZmVyZW5jZSwgYXR0cmlidXRlKSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgY2xhc3MgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZSBleHRlbmRzIFVwZGF0aW5nT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSAncGF0Y2gtZWxlbWVudCc7XG5cbiAgcHVibGljIHRhZzogVGFnO1xuICBwdWJsaWMgbGFzdFJldmlzaW9uOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlZmVyZW5jZTogVmVyc2lvbmVkUmVmZXJlbmNlPHVua25vd24+LCBwcml2YXRlIGF0dHJpYnV0ZTogRHluYW1pY0F0dHJpYnV0ZSkge1xuICAgIHN1cGVyKCk7XG4gICAgbGV0IHsgdGFnIH0gPSByZWZlcmVuY2U7XG4gICAgdGhpcy50YWcgPSB0YWc7XG4gICAgdGhpcy5sYXN0UmV2aXNpb24gPSB2YWx1ZSh0YWcpO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFVwZGF0aW5nVk0pIHtcbiAgICBsZXQgeyBhdHRyaWJ1dGUsIHJlZmVyZW5jZSwgdGFnIH0gPSB0aGlzO1xuICAgIGlmICghdmFsaWRhdGUodGFnLCB0aGlzLmxhc3RSZXZpc2lvbikpIHtcbiAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gdmFsdWUodGFnKTtcbiAgICAgIGF0dHJpYnV0ZS51cGRhdGUocmVmZXJlbmNlLnZhbHVlKCksIHZtLmVudik7XG4gICAgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9