function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

import { capabilityFlagsFrom } from './capabilities';
import { hasStaticLayoutCapability } from './compiled/opcodes/component';
import { resolveComponent } from './component/resolve';
import { ARGS } from './symbols';
import { AotVM, JitVM } from './vm/append';
import { NewElementBuilder } from './vm/element-builder';
import { DefaultDynamicScope } from './dynamic-scope';
import { UNDEFINED_REFERENCE } from './references';

var TemplateIteratorImpl = function () {
    function TemplateIteratorImpl(vm) {
        _classCallCheck(this, TemplateIteratorImpl);

        this.vm = vm;
    }

    TemplateIteratorImpl.prototype.next = function next() {
        return this.vm.next();
    };

    TemplateIteratorImpl.prototype.sync = function sync() {
        return renderSync(this.vm.runtime.env, this);
    };

    return TemplateIteratorImpl;
}();

export function renderSync(env, iterator) {
    env.begin();
    var iteratorResult = void 0;
    do {
        iteratorResult = iterator.next();
    } while (!iteratorResult.done);
    var result = iteratorResult.value;
    env.commit();
    return result;
}
export function renderAotMain(runtime, self, treeBuilder, handle) {
    var dynamicScope = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : new DefaultDynamicScope();

    var vm = AotVM.initial(runtime, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
export function renderAot(runtime, handle, cursor) {
    var self = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : UNDEFINED_REFERENCE;

    var treeBuilder = NewElementBuilder.forInitialRender(runtime.env, cursor);
    var dynamicScope = new DefaultDynamicScope();
    var vm = AotVM.initial(runtime, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
export function renderJitMain(runtime, context, self, treeBuilder, handle) {
    var dynamicScope = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : new DefaultDynamicScope();

    var vm = JitVM.initial(runtime, context, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
function renderInvocation(vm, invocation, definition, args) {
    // Get a list of tuples of argument names and references, like
    // [['title', reference], ['name', reference]]
    var argList = Object.keys(args).map(function (key) {
        return [key, args[key]];
    });
    var blockNames = ['main', 'else', 'attrs'];
    // Prefix argument names with `@` symbol
    var argNames = argList.map(function (_ref) {
        var name = _ref[0];
        return '@' + name;
    });
    vm.pushFrame();
    // Push blocks on to the stack, three stack values per block
    for (var i = 0; i < 3 * blockNames.length; i++) {
        vm.stack.push(null);
    }
    vm.stack.push(null);
    // For each argument, push its backing reference on to the stack
    argList.forEach(function (_ref2) {
        var reference = _ref2[1];

        vm.stack.push(reference);
    });
    // Configure VM based on blocks and args just pushed on to the stack.
    vm[ARGS].setup(vm.stack, argNames, blockNames, 0, true);
    // Needed for the Op.Main opcode: arguments, component invocation object, and
    // component definition.
    vm.stack.push(vm[ARGS]);
    vm.stack.push(invocation);
    vm.stack.push(definition);
    return new TemplateIteratorImpl(vm);
}
export function renderAotComponent(runtime, treeBuilder, main, name) {
    var args = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};
    var dynamicScope = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : new DefaultDynamicScope();

    var vm = AotVM.empty(runtime, { treeBuilder: treeBuilder, handle: main, dynamicScope: dynamicScope });
    var definition = resolveComponent(vm.runtime.resolver, name);
    var manager = definition.manager,
        state = definition.state;

    var capabilities = capabilityFlagsFrom(manager.getCapabilities(state));
    var invocation = void 0;
    if (hasStaticLayoutCapability(capabilities, manager)) {
        invocation = manager.getAotStaticLayout(state, vm.runtime.resolver);
    } else {
        throw new Error('Cannot invoke components with dynamic layouts as a root component.');
    }
    return renderInvocation(vm, invocation, definition, args);
}
export function renderJitComponent(runtime, treeBuilder, context, main, name) {
    var args = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};
    var dynamicScope = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : new DefaultDynamicScope();

    var vm = JitVM.empty(runtime, { treeBuilder: treeBuilder, handle: main, dynamicScope: dynamicScope }, context);
    var definition = resolveComponent(vm.runtime.resolver, name);
    var manager = definition.manager,
        state = definition.state;

    var capabilities = capabilityFlagsFrom(manager.getCapabilities(state));
    var invocation = void 0;
    if (hasStaticLayoutCapability(capabilities, manager)) {
        var layout = manager.getJitStaticLayout(state, vm.runtime.resolver);
        invocation = { handle: layout.compile(context), symbolTable: layout.symbolTable };
    } else {
        throw new Error('Cannot invoke components with dynamic layouts as a root component.');
    }
    return renderInvocation(vm, invocation, definition, args);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL3JlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQW9CQSxTQUFBLG1CQUFBLFFBQUEsZ0JBQUE7QUFDQSxTQUFBLHlCQUFBLFFBQUEsOEJBQUE7QUFDQSxTQUFBLGdCQUFBLFFBQUEscUJBQUE7QUFDQSxTQUFBLElBQUEsUUFBQSxXQUFBO0FBQ0EsU0FBQSxLQUFBLEVBQUEsS0FBQSxRQUFBLGFBQUE7QUFDQSxTQUFBLGlCQUFBLFFBQUEsc0JBQUE7QUFDQSxTQUFBLG1CQUFBLFFBQUEsaUJBQUE7QUFDQSxTQUFBLG1CQUFBLFFBQUEsY0FBQTs7SUFFQSxvQjtBQUNFLGtDQUFBLEVBQUEsRUFBcUM7QUFBQTs7QUFBakIsYUFBQSxFQUFBLEdBQUEsRUFBQTtBQUFxQjs7bUNBQ3pDLEksbUJBQUk7QUFDRixlQUFPLEtBQUEsRUFBQSxDQUFQLElBQU8sRUFBUDtBQUNELEs7O21DQUVELEksbUJBQUk7QUFDRixlQUFPLFdBQVcsS0FBQSxFQUFBLENBQUEsT0FBQSxDQUFYLEdBQUEsRUFBUCxJQUFPLENBQVA7QUFDRCxLOzs7OztBQUdILE9BQU0sU0FBQSxVQUFBLENBQUEsR0FBQSxFQUFBLFFBQUEsRUFBaUU7QUFDckUsUUFBQSxLQUFBO0FBRUEsUUFBQSx1QkFBQTtBQUVBLE9BQUc7QUFDRCx5QkFBaUIsU0FBakIsSUFBaUIsRUFBakI7QUFERixLQUFBLFFBRVMsQ0FBQyxlQUZWLElBQUE7QUFJQSxRQUFJLFNBQVMsZUFBYixLQUFBO0FBRUEsUUFBQSxNQUFBO0FBRUEsV0FBQSxNQUFBO0FBQ0Q7QUFFRCxPQUFNLFNBQUEsYUFBQSxDQUFBLE9BQUEsRUFBQSxJQUFBLEVBQUEsV0FBQSxFQUFBLE1BQUEsRUFLa0Q7QUFBQSxRQUF0RCxZQUFzRCx1RUFBekIsSUFMekIsbUJBS3lCLEVBQXlCOztBQUV0RCxRQUFJLEtBQUssTUFBQSxPQUFBLENBQUEsT0FBQSxFQUF1QixF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QXNEO0FBQ3BELFlBQUksU0FBVSxRQUFBLGtCQUFBLENBQUEsS0FBQSxFQUEwRCxHQUFBLE9BQUEsQ0FBeEUsUUFBYyxDQUFkO0FBQ0EscUJBQWEsRUFBRSxRQUFRLE9BQUEsT0FBQSxDQUFWLE9BQVUsQ0FBVixFQUFtQyxhQUFhLE9BQTdELFdBQWEsRUFBYjtBQUZGLEtBQUEsTUFHTztBQUNMLGNBQU0sSUFBQSxLQUFBLENBQU4sb0VBQU0sQ0FBTjtBQUNEO0FBRUQsV0FBTyxpQkFBQSxFQUFBLEVBQUEsVUFBQSxFQUFBLFVBQUEsRUFBUCxJQUFPLENBQVA7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIERpY3QsXG4gIER5bmFtaWNTY29wZSxcbiAgRW52aXJvbm1lbnQsXG4gIEludm9jYXRpb24sXG4gIEppdE9yQW90QmxvY2ssXG4gIFJlbmRlclJlc3VsdCxcbiAgUmljaEl0ZXJhdG9yUmVzdWx0LFxuICBTeW50YXhDb21waWxhdGlvbkNvbnRleHQsXG4gIFdpdGhBb3RTdGF0aWNMYXlvdXQsXG4gIFdpdGhKaXRTdGF0aWNMYXlvdXQsXG4gIFRlbXBsYXRlSXRlcmF0b3IsXG4gIEN1cnNvcixcbiAgQ29tcG9uZW50RGVmaW5pdGlvbixcbiAgSml0UnVudGltZUNvbnRleHQsXG4gIEFvdFJ1bnRpbWVDb250ZXh0LFxuICBFbGVtZW50QnVpbGRlcixcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBQYXRoUmVmZXJlbmNlIH0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IGV4cGVjdCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgY2FwYWJpbGl0eUZsYWdzRnJvbSB9IGZyb20gJy4vY2FwYWJpbGl0aWVzJztcbmltcG9ydCB7IGhhc1N0YXRpY0xheW91dENhcGFiaWxpdHkgfSBmcm9tICcuL2NvbXBpbGVkL29wY29kZXMvY29tcG9uZW50JztcbmltcG9ydCB7IHJlc29sdmVDb21wb25lbnQgfSBmcm9tICcuL2NvbXBvbmVudC9yZXNvbHZlJztcbmltcG9ydCB7IEFSR1MgfSBmcm9tICcuL3N5bWJvbHMnO1xuaW1wb3J0IHsgQW90Vk0sIEludGVybmFsVk0sIEppdFZNIH0gZnJvbSAnLi92bS9hcHBlbmQnO1xuaW1wb3J0IHsgTmV3RWxlbWVudEJ1aWxkZXIgfSBmcm9tICcuL3ZtL2VsZW1lbnQtYnVpbGRlcic7XG5pbXBvcnQgeyBEZWZhdWx0RHluYW1pY1Njb3BlIH0gZnJvbSAnLi9keW5hbWljLXNjb3BlJztcbmltcG9ydCB7IFVOREVGSU5FRF9SRUZFUkVOQ0UgfSBmcm9tICcuL3JlZmVyZW5jZXMnO1xuXG5jbGFzcyBUZW1wbGF0ZUl0ZXJhdG9ySW1wbDxDIGV4dGVuZHMgSml0T3JBb3RCbG9jaz4gaW1wbGVtZW50cyBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSB2bTogSW50ZXJuYWxWTTxDPikge31cbiAgbmV4dCgpOiBSaWNoSXRlcmF0b3JSZXN1bHQ8bnVsbCwgUmVuZGVyUmVzdWx0PiB7XG4gICAgcmV0dXJuIHRoaXMudm0ubmV4dCgpO1xuICB9XG5cbiAgc3luYygpOiBSZW5kZXJSZXN1bHQge1xuICAgIHJldHVybiByZW5kZXJTeW5jKHRoaXMudm0ucnVudGltZS5lbnYsIHRoaXMpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJTeW5jKGVudjogRW52aXJvbm1lbnQsIGl0ZXJhdG9yOiBUZW1wbGF0ZUl0ZXJhdG9yKTogUmVuZGVyUmVzdWx0IHtcbiAgZW52LmJlZ2luKCk7XG5cbiAgbGV0IGl0ZXJhdG9yUmVzdWx0OiBJdGVyYXRvclJlc3VsdDxSZW5kZXJSZXN1bHQ+O1xuXG4gIGRvIHtcbiAgICBpdGVyYXRvclJlc3VsdCA9IGl0ZXJhdG9yLm5leHQoKSBhcyBJdGVyYXRvclJlc3VsdDxSZW5kZXJSZXN1bHQ+O1xuICB9IHdoaWxlICghaXRlcmF0b3JSZXN1bHQuZG9uZSk7XG5cbiAgbGV0IHJlc3VsdCA9IGl0ZXJhdG9yUmVzdWx0LnZhbHVlO1xuXG4gIGVudi5jb21taXQoKTtcblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQW90TWFpbihcbiAgcnVudGltZTogQW90UnVudGltZUNvbnRleHQsXG4gIHNlbGY6IFBhdGhSZWZlcmVuY2UsXG4gIHRyZWVCdWlsZGVyOiBFbGVtZW50QnVpbGRlcixcbiAgaGFuZGxlOiBudW1iZXIsXG4gIGR5bmFtaWNTY29wZTogRHluYW1pY1Njb3BlID0gbmV3IERlZmF1bHREeW5hbWljU2NvcGUoKVxuKTogVGVtcGxhdGVJdGVyYXRvciB7XG4gIGxldCB2bSA9IEFvdFZNLmluaXRpYWwocnVudGltZSwgeyBzZWxmLCBkeW5hbWljU2NvcGUsIHRyZWVCdWlsZGVyLCBoYW5kbGUgfSk7XG4gIHJldHVybiBuZXcgVGVtcGxhdGVJdGVyYXRvckltcGwodm0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQW90KFxuICBydW50aW1lOiBBb3RSdW50aW1lQ29udGV4dCxcbiAgaGFuZGxlOiBudW1iZXIsXG4gIGN1cnNvcjogQ3Vyc29yLFxuICBzZWxmOiBQYXRoUmVmZXJlbmNlID0gVU5ERUZJTkVEX1JFRkVSRU5DRVxuKTogVGVtcGxhdGVJdGVyYXRvciB7XG4gIGxldCB0cmVlQnVpbGRlciA9IE5ld0VsZW1lbnRCdWlsZGVyLmZvckluaXRpYWxSZW5kZXIocnVudGltZS5lbnYsIGN1cnNvcik7XG4gIGxldCBkeW5hbWljU2NvcGUgPSBuZXcgRGVmYXVsdER5bmFtaWNTY29wZSgpO1xuICBsZXQgdm0gPSBBb3RWTS5pbml0aWFsKHJ1bnRpbWUsIHsgc2VsZiwgZHluYW1pY1Njb3BlLCB0cmVlQnVpbGRlciwgaGFuZGxlIH0pO1xuICByZXR1cm4gbmV3IFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckppdE1haW4oXG4gIHJ1bnRpbWU6IEppdFJ1bnRpbWVDb250ZXh0LFxuICBjb250ZXh0OiBTeW50YXhDb21waWxhdGlvbkNvbnRleHQsXG4gIHNlbGY6IFBhdGhSZWZlcmVuY2UsXG4gIHRyZWVCdWlsZGVyOiBFbGVtZW50QnVpbGRlcixcbiAgaGFuZGxlOiBudW1iZXIsXG4gIGR5bmFtaWNTY29wZTogRHluYW1pY1Njb3BlID0gbmV3IERlZmF1bHREeW5hbWljU2NvcGUoKVxuKTogVGVtcGxhdGVJdGVyYXRvciB7XG4gIGxldCB2bSA9IEppdFZNLmluaXRpYWwocnVudGltZSwgY29udGV4dCwgeyBzZWxmLCBkeW5hbWljU2NvcGUsIHRyZWVCdWlsZGVyLCBoYW5kbGUgfSk7XG4gIHJldHVybiBuZXcgVGVtcGxhdGVJdGVyYXRvckltcGwodm0pO1xufVxuXG5leHBvcnQgdHlwZSBSZW5kZXJDb21wb25lbnRBcmdzID0gRGljdDxQYXRoUmVmZXJlbmNlPjtcblxuZnVuY3Rpb24gcmVuZGVySW52b2NhdGlvbjxDIGV4dGVuZHMgSml0T3JBb3RCbG9jaz4oXG4gIHZtOiBJbnRlcm5hbFZNPEM+LFxuICBpbnZvY2F0aW9uOiBJbnZvY2F0aW9uLFxuICBkZWZpbml0aW9uOiBDb21wb25lbnREZWZpbml0aW9uLFxuICBhcmdzOiBSZW5kZXJDb21wb25lbnRBcmdzXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgLy8gR2V0IGEgbGlzdCBvZiB0dXBsZXMgb2YgYXJndW1lbnQgbmFtZXMgYW5kIHJlZmVyZW5jZXMsIGxpa2VcbiAgLy8gW1sndGl0bGUnLCByZWZlcmVuY2VdLCBbJ25hbWUnLCByZWZlcmVuY2VdXVxuICBjb25zdCBhcmdMaXN0ID0gT2JqZWN0LmtleXMoYXJncykubWFwKGtleSA9PiBba2V5LCBhcmdzW2tleV1dKTtcblxuICBjb25zdCBibG9ja05hbWVzID0gWydtYWluJywgJ2Vsc2UnLCAnYXR0cnMnXTtcbiAgLy8gUHJlZml4IGFyZ3VtZW50IG5hbWVzIHdpdGggYEBgIHN5bWJvbFxuICBjb25zdCBhcmdOYW1lcyA9IGFyZ0xpc3QubWFwKChbbmFtZV0pID0+IGBAJHtuYW1lfWApO1xuXG4gIHZtLnB1c2hGcmFtZSgpO1xuXG4gIC8vIFB1c2ggYmxvY2tzIG9uIHRvIHRoZSBzdGFjaywgdGhyZWUgc3RhY2sgdmFsdWVzIHBlciBibG9ja1xuICBmb3IgKGxldCBpID0gMDsgaSA8IDMgKiBibG9ja05hbWVzLmxlbmd0aDsgaSsrKSB7XG4gICAgdm0uc3RhY2sucHVzaChudWxsKTtcbiAgfVxuXG4gIHZtLnN0YWNrLnB1c2gobnVsbCk7XG5cbiAgLy8gRm9yIGVhY2ggYXJndW1lbnQsIHB1c2ggaXRzIGJhY2tpbmcgcmVmZXJlbmNlIG9uIHRvIHRoZSBzdGFja1xuICBhcmdMaXN0LmZvckVhY2goKFssIHJlZmVyZW5jZV0pID0+IHtcbiAgICB2bS5zdGFjay5wdXNoKHJlZmVyZW5jZSk7XG4gIH0pO1xuXG4gIC8vIENvbmZpZ3VyZSBWTSBiYXNlZCBvbiBibG9ja3MgYW5kIGFyZ3MganVzdCBwdXNoZWQgb24gdG8gdGhlIHN0YWNrLlxuICB2bVtBUkdTXS5zZXR1cCh2bS5zdGFjaywgYXJnTmFtZXMsIGJsb2NrTmFtZXMsIDAsIHRydWUpO1xuXG4gIC8vIE5lZWRlZCBmb3IgdGhlIE9wLk1haW4gb3Bjb2RlOiBhcmd1bWVudHMsIGNvbXBvbmVudCBpbnZvY2F0aW9uIG9iamVjdCwgYW5kXG4gIC8vIGNvbXBvbmVudCBkZWZpbml0aW9uLlxuICB2bS5zdGFjay5wdXNoKHZtW0FSR1NdKTtcbiAgdm0uc3RhY2sucHVzaChpbnZvY2F0aW9uKTtcbiAgdm0uc3RhY2sucHVzaChkZWZpbml0aW9uKTtcblxuICByZXR1cm4gbmV3IFRlbXBsYXRlSXRlcmF0b3JJbXBsKHZtKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckFvdENvbXBvbmVudDxSPihcbiAgcnVudGltZTogQW90UnVudGltZUNvbnRleHQ8Uj4sXG4gIHRyZWVCdWlsZGVyOiBFbGVtZW50QnVpbGRlcixcbiAgbWFpbjogbnVtYmVyLFxuICBuYW1lOiBzdHJpbmcsXG4gIGFyZ3M6IFJlbmRlckNvbXBvbmVudEFyZ3MgPSB7fSxcbiAgZHluYW1pY1Njb3BlOiBEeW5hbWljU2NvcGUgPSBuZXcgRGVmYXVsdER5bmFtaWNTY29wZSgpXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgbGV0IHZtID0gQW90Vk0uZW1wdHkocnVudGltZSwgeyB0cmVlQnVpbGRlciwgaGFuZGxlOiBtYWluLCBkeW5hbWljU2NvcGUgfSk7XG5cbiAgY29uc3QgZGVmaW5pdGlvbiA9IGV4cGVjdChcbiAgICByZXNvbHZlQ29tcG9uZW50KHZtLnJ1bnRpbWUucmVzb2x2ZXIsIG5hbWUpLFxuICAgIGBjb3VsZCBub3QgZmluZCBjb21wb25lbnQgXCIke25hbWV9XCJgXG4gICk7XG5cbiAgY29uc3QgeyBtYW5hZ2VyLCBzdGF0ZSB9ID0gZGVmaW5pdGlvbjtcblxuICBjb25zdCBjYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXR5RmxhZ3NGcm9tKG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKHN0YXRlKSk7XG5cbiAgbGV0IGludm9jYXRpb247XG5cbiAgaWYgKGhhc1N0YXRpY0xheW91dENhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCBtYW5hZ2VyKSkge1xuICAgIGludm9jYXRpb24gPSAobWFuYWdlciBhcyBXaXRoQW90U3RhdGljTGF5b3V0KS5nZXRBb3RTdGF0aWNMYXlvdXQoc3RhdGUsIHZtLnJ1bnRpbWUucmVzb2x2ZXIpO1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGludm9rZSBjb21wb25lbnRzIHdpdGggZHluYW1pYyBsYXlvdXRzIGFzIGEgcm9vdCBjb21wb25lbnQuJyk7XG4gIH1cblxuICByZXR1cm4gcmVuZGVySW52b2NhdGlvbih2bSwgaW52b2NhdGlvbiwgZGVmaW5pdGlvbiwgYXJncyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJKaXRDb21wb25lbnQoXG4gIHJ1bnRpbWU6IEppdFJ1bnRpbWVDb250ZXh0LFxuICB0cmVlQnVpbGRlcjogRWxlbWVudEJ1aWxkZXIsXG4gIGNvbnRleHQ6IFN5bnRheENvbXBpbGF0aW9uQ29udGV4dCxcbiAgbWFpbjogbnVtYmVyLFxuICBuYW1lOiBzdHJpbmcsXG4gIGFyZ3M6IFJlbmRlckNvbXBvbmVudEFyZ3MgPSB7fSxcbiAgZHluYW1pY1Njb3BlOiBEeW5hbWljU2NvcGUgPSBuZXcgRGVmYXVsdER5bmFtaWNTY29wZSgpXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgbGV0IHZtID0gSml0Vk0uZW1wdHkocnVudGltZSwgeyB0cmVlQnVpbGRlciwgaGFuZGxlOiBtYWluLCBkeW5hbWljU2NvcGUgfSwgY29udGV4dCk7XG5cbiAgY29uc3QgZGVmaW5pdGlvbiA9IGV4cGVjdChcbiAgICByZXNvbHZlQ29tcG9uZW50KHZtLnJ1bnRpbWUucmVzb2x2ZXIsIG5hbWUpLFxuICAgIGBjb3VsZCBub3QgZmluZCBjb21wb25lbnQgXCIke25hbWV9XCJgXG4gICk7XG5cbiAgY29uc3QgeyBtYW5hZ2VyLCBzdGF0ZSB9ID0gZGVmaW5pdGlvbjtcblxuICBjb25zdCBjYXBhYmlsaXRpZXMgPSBjYXBhYmlsaXR5RmxhZ3NGcm9tKG1hbmFnZXIuZ2V0Q2FwYWJpbGl0aWVzKHN0YXRlKSk7XG5cbiAgbGV0IGludm9jYXRpb246IEludm9jYXRpb247XG5cbiAgaWYgKGhhc1N0YXRpY0xheW91dENhcGFiaWxpdHkoY2FwYWJpbGl0aWVzLCBtYW5hZ2VyKSkge1xuICAgIGxldCBsYXlvdXQgPSAobWFuYWdlciBhcyBXaXRoSml0U3RhdGljTGF5b3V0KS5nZXRKaXRTdGF0aWNMYXlvdXQoc3RhdGUsIHZtLnJ1bnRpbWUucmVzb2x2ZXIpO1xuICAgIGludm9jYXRpb24gPSB7IGhhbmRsZTogbGF5b3V0LmNvbXBpbGUoY29udGV4dCksIHN5bWJvbFRhYmxlOiBsYXlvdXQuc3ltYm9sVGFibGUgfTtcbiAgfSBlbHNlIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBpbnZva2UgY29tcG9uZW50cyB3aXRoIGR5bmFtaWMgbGF5b3V0cyBhcyBhIHJvb3QgY29tcG9uZW50LicpO1xuICB9XG5cbiAgcmV0dXJuIHJlbmRlckludm9jYXRpb24odm0sIGludm9jYXRpb24sIGRlZmluaXRpb24sIGFyZ3MpO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==