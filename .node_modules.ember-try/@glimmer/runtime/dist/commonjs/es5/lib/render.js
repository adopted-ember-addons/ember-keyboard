'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.renderSync = renderSync;
exports.renderAotMain = renderAotMain;
exports.renderAot = renderAot;
exports.renderJitMain = renderJitMain;
exports.renderAotComponent = renderAotComponent;
exports.renderJitComponent = renderJitComponent;

var _capabilities = require('./capabilities');

var _component = require('./compiled/opcodes/component');

var _resolve = require('./component/resolve');

var _symbols = require('./symbols');

var _append = require('./vm/append');

var _elementBuilder = require('./vm/element-builder');

var _dynamicScope = require('./dynamic-scope');

var _references = require('./references');

function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
        throw new TypeError("Cannot call a class as a function");
    }
}

var TemplateIteratorImpl = function () {
    function TemplateIteratorImpl(vm) {
        _classCallCheck(this, TemplateIteratorImpl);

        this.vm = vm;
    }

    TemplateIteratorImpl.prototype.next = function next() {
        return this.vm.next();
    };

    TemplateIteratorImpl.prototype.sync = function sync() {
        return renderSync(this.vm.runtime.env, this);
    };

    return TemplateIteratorImpl;
}();

function renderSync(env, iterator) {
    env.begin();
    var iteratorResult = void 0;
    do {
        iteratorResult = iterator.next();
    } while (!iteratorResult.done);
    var result = iteratorResult.value;
    env.commit();
    return result;
}
function renderAotMain(runtime, self, treeBuilder, handle) {
    var dynamicScope = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : new _dynamicScope.DefaultDynamicScope();

    var vm = _append.AotVM.initial(runtime, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
function renderAot(runtime, handle, cursor) {
    var self = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : _references.UNDEFINED_REFERENCE;

    var treeBuilder = _elementBuilder.NewElementBuilder.forInitialRender(runtime.env, cursor);
    var dynamicScope = new _dynamicScope.DefaultDynamicScope();
    var vm = _append.AotVM.initial(runtime, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
function renderJitMain(runtime, context, self, treeBuilder, handle) {
    var dynamicScope = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : new _dynamicScope.DefaultDynamicScope();

    var vm = _append.JitVM.initial(runtime, context, { self: self, dynamicScope: dynamicScope, treeBuilder: treeBuilder, handle: handle });
    return new TemplateIteratorImpl(vm);
}
function renderInvocation(vm, invocation, definition, args) {
    // Get a list of tuples of argument names and references, like
    // [['title', reference], ['name', reference]]
    var argList = Object.keys(args).map(function (key) {
        return [key, args[key]];
    });
    var blockNames = ['main', 'else', 'attrs'];
    // Prefix argument names with `@` symbol
    var argNames = argList.map(function (_ref) {
        var name = _ref[0];
        return '@' + name;
    });
    vm.pushFrame();
    // Push blocks on to the stack, three stack values per block
    for (var i = 0; i < 3 * blockNames.length; i++) {
        vm.stack.push(null);
    }
    vm.stack.push(null);
    // For each argument, push its backing reference on to the stack
    argList.forEach(function (_ref2) {
        var reference = _ref2[1];

        vm.stack.push(reference);
    });
    // Configure VM based on blocks and args just pushed on to the stack.
    vm[_symbols.ARGS].setup(vm.stack, argNames, blockNames, 0, true);
    // Needed for the Op.Main opcode: arguments, component invocation object, and
    // component definition.
    vm.stack.push(vm[_symbols.ARGS]);
    vm.stack.push(invocation);
    vm.stack.push(definition);
    return new TemplateIteratorImpl(vm);
}
function renderAotComponent(runtime, treeBuilder, main, name) {
    var args = arguments.length > 4 && arguments[4] !== undefined ? arguments[4] : {};
    var dynamicScope = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : new _dynamicScope.DefaultDynamicScope();

    var vm = _append.AotVM.empty(runtime, { treeBuilder: treeBuilder, handle: main, dynamicScope: dynamicScope });
    var definition = (0, _resolve.resolveComponent)(vm.runtime.resolver, name);
    var manager = definition.manager,
        state = definition.state;

    var capabilities = (0, _capabilities.capabilityFlagsFrom)(manager.getCapabilities(state));
    var invocation = void 0;
    if ((0, _component.hasStaticLayoutCapability)(capabilities, manager)) {
        invocation = manager.getAotStaticLayout(state, vm.runtime.resolver);
    } else {
        throw new Error('Cannot invoke components with dynamic layouts as a root component.');
    }
    return renderInvocation(vm, invocation, definition, args);
}
function renderJitComponent(runtime, treeBuilder, context, main, name) {
    var args = arguments.length > 5 && arguments[5] !== undefined ? arguments[5] : {};
    var dynamicScope = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : new _dynamicScope.DefaultDynamicScope();

    var vm = _append.JitVM.empty(runtime, { treeBuilder: treeBuilder, handle: main, dynamicScope: dynamicScope }, context);
    var definition = (0, _resolve.resolveComponent)(vm.runtime.resolver, name);
    var manager = definition.manager,
        state = definition.state;

    var capabilities = (0, _capabilities.capabilityFlagsFrom)(manager.getCapabilities(state));
    var invocation = void 0;
    if ((0, _component.hasStaticLayoutCapability)(capabilities, manager)) {
        var layout = manager.getJitStaticLayout(state, vm.runtime.resolver);
        invocation = { handle: layout.compile(context), symbolTable: layout.symbolTable };
    } else {
        throw new Error('Cannot invoke components with dynamic layouts as a root component.');
    }
    return renderInvocation(vm, invocation, definition, args);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL3JlbmRlci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztRQXdDTSxVLEdBQUEsVTtRQWdCQSxhLEdBQUEsYTtRQVdBLFMsR0FBQSxTO1FBWUEsYSxHQUFBLGE7UUFzREEsa0IsR0FBQSxrQjtRQThCQSxrQixHQUFBLGtCOztBQS9JTjs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7Ozs7Ozs7SUFFQSx1QjtBQUNFLGFBQUEsb0JBQUEsQ0FBQSxFQUFBLEVBQXFDO0FBQUEsd0JBQUEsSUFBQSxFQUFBLG9CQUFBOztBQUFqQixhQUFBLEVBQUEsR0FBQSxFQUFBO0FBQXFCOzttQ0FDekMsSSxtQkFBSTtBQUNGLGVBQU8sS0FBQSxFQUFBLENBQVAsSUFBTyxFQUFQOzs7bUNBR0YsSSxtQkFBSTtBQUNGLGVBQU8sV0FBVyxLQUFBLEVBQUEsQ0FBQSxPQUFBLENBQVgsR0FBQSxFQUFQLElBQU8sQ0FBUDs7Ozs7O0FBSUUsU0FBQSxVQUFBLENBQUEsR0FBQSxFQUFBLFFBQUEsRUFBaUU7QUFDckUsUUFBQSxLQUFBO0FBRUEsUUFBQSxpQkFBQSxLQUFBLENBQUE7QUFFQSxPQUFHO0FBQ0QseUJBQWlCLFNBQWpCLElBQWlCLEVBQWpCO0FBREYsS0FBQSxRQUVTLENBQUMsZUFGVixJQUFBO0FBSUEsUUFBSSxTQUFTLGVBQWIsS0FBQTtBQUVBLFFBQUEsTUFBQTtBQUVBLFdBQUEsTUFBQTtBQUNEO0FBRUssU0FBQSxhQUFBLENBQUEsT0FBQSxFQUFBLElBQUEsRUFBQSxXQUFBLEVBQUEsTUFBQSxFQUtrRDtBQUFBLFFBQXRELGVBQXNELFVBQUEsTUFBQSxHQUFBLENBQUEsSUFBQSxVQUFBLENBQUEsTUFBQSxTQUFBLEdBQUEsVUFBQSxDQUFBLENBQUEsR0FBekIsSUFMekIsaUNBS3lCLEVBQXlCOztBQUV0RCxRQUFJLEtBQUssY0FBQSxPQUFBLENBQUEs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LFVBQUEsQ0FBQSxDQUFBLEdBUGxELEVBT2tEO0FBQUEsUUFBdEQsZUFBc0QsVUFBQSxNQUFBLEdBQUEsQ0FBQSxJQUFBLFVBQUEsQ0FBQSxNQUFBLFNBQUEsR0FBQSxVQUFBLENBQUEsQ0FBQSxHQUF6QixJQVB6QixpQ0FPeUIsRUFBeUI7O0FBRXRELFFBQUksS0FBSyxjQUFBLEtBQUEsQ0FBQSxPQUFBLEVBQXFCLEVBQUEsYUFBQSxXQUFBLEVBQWUsUUFBZixJQUFBLEVBQXJCLGNBQUEsWUFBcUIsRUFBckIsRUFBVCxPQUFTLENBQVQ7QUFFQSxRQUFNLGFBQ0osK0JBQWlCLEdBQUEsT0FBQSxDQUFqQixRQUFBLEVBREYsSUFDRSxDQURGO0FBSnNELFFBQUEsVUFBQSxXQUFBLE9BQUE7QUFBQSxRQUFBLFFBQUEsV0FBQSxLQUFBOztBQVd0RCxRQUFNLGVBQWUsdUNBQW9CLFFBQUEsZUFBQSxDQUF6QyxLQUF5QyxDQUFwQixDQUFyQjtBQUVBLFFBQUEsYUFBQSxLQUFBLENBQUE7QUFFQSxRQUFJLDBDQUFBLFlBQUEsRUFBSixPQUFJLENBQUosRUFBc0Q7QUFDcEQsWUFBSSxTQUFVLFFBQUEsa0JBQUEsQ0FBQSxLQUFBLEVBQTBELEdBQUEsT0FBQSxDQUF4RSxRQUFjLENBQWQ7QUFDQSxxQkFBYSxFQUFFLFFBQVEsT0FBQSxPQUFBLENBQVYsT0FBVSxDQUFWLEVBQW1DLGFBQWEsT0FBN0QsV0FBYSxFQUFiO0FBRkYsS0FBQSxNQUdPO0FBQ0wsY0FBTSxJQUFBLEtBQUEsQ0FBTixvRUFBTSxDQUFOO0FBQ0Q7QUFFRCxXQUFPLGlCQUFBLEVBQUEsRUFBQSxVQUFBLEVBQUEsVUFBQSxFQUFQLElBQU8sQ0FBUDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGljdCxcbiAgRHluYW1pY1Njb3BlLFxuICBFbnZpcm9ubWVudCxcbiAgSW52b2NhdGlvbixcbiAgSml0T3JBb3RCbG9jayxcbiAgUmVuZGVyUmVzdWx0LFxuICBSaWNoSXRlcmF0b3JSZXN1bHQsXG4gIFN5bnRheENvbXBpbGF0aW9uQ29udGV4dCxcbiAgV2l0aEFvdFN0YXRpY0xheW91dCxcbiAgV2l0aEppdFN0YXRpY0xheW91dCxcbiAgVGVtcGxhdGVJdGVyYXRvcixcbiAgQ3Vyc29yLFxuICBDb21wb25lbnREZWZpbml0aW9uLFxuICBKaXRSdW50aW1lQ29udGV4dCxcbiAgQW90UnVudGltZUNvbnRleHQsXG4gIEVsZW1lbnRCdWlsZGVyLFxufSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7IFBhdGhSZWZlcmVuY2UgfSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgZXhwZWN0IH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBjYXBhYmlsaXR5RmxhZ3NGcm9tIH0gZnJvbSAnLi9jYXBhYmlsaXRpZXMnO1xuaW1wb3J0IHsgaGFzU3RhdGljTGF5b3V0Q2FwYWJpbGl0eSB9IGZyb20gJy4vY29tcGlsZWQvb3Bjb2Rlcy9jb21wb25lbnQnO1xuaW1wb3J0IHsgcmVzb2x2ZUNvbXBvbmVudCB9IGZyb20gJy4vY29tcG9uZW50L3Jlc29sdmUnO1xuaW1wb3J0IHsgQVJHUyB9IGZyb20gJy4vc3ltYm9scyc7XG5pbXBvcnQgeyBBb3RWTSwgSW50ZXJuYWxWTSwgSml0Vk0gfSBmcm9tICcuL3ZtL2FwcGVuZCc7XG5pbXBvcnQgeyBOZXdFbGVtZW50QnVpbGRlciB9IGZyb20gJy4vdm0vZWxlbWVudC1idWlsZGVyJztcbmltcG9ydCB7IERlZmF1bHREeW5hbWljU2NvcGUgfSBmcm9tICcuL2R5bmFtaWMtc2NvcGUnO1xuaW1wb3J0IHsgVU5ERUZJTkVEX1JFRkVSRU5DRSB9IGZyb20gJy4vcmVmZXJlbmNlcyc7XG5cbmNsYXNzIFRlbXBsYXRlSXRlcmF0b3JJbXBsPEMgZXh0ZW5kcyBKaXRPckFvdEJsb2NrPiBpbXBsZW1lbnRzIFRlbXBsYXRlSXRlcmF0b3Ige1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHZtOiBJbnRlcm5hbFZNPEM+KSB7fVxuICBuZXh0KCk6IFJpY2hJdGVyYXRvclJlc3VsdDxudWxsLCBSZW5kZXJSZXN1bHQ+IHtcbiAgICByZXR1cm4gdGhpcy52bS5uZXh0KCk7XG4gIH1cblxuICBzeW5jKCk6IFJlbmRlclJlc3VsdCB7XG4gICAgcmV0dXJuIHJlbmRlclN5bmModGhpcy52bS5ydW50aW1lLmVudiwgdGhpcyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlclN5bmMoZW52OiBFbnZpcm9ubWVudCwgaXRlcmF0b3I6IFRlbXBsYXRlSXRlcmF0b3IpOiBSZW5kZXJSZXN1bHQge1xuICBlbnYuYmVnaW4oKTtcblxuICBsZXQgaXRlcmF0b3JSZXN1bHQ6IEl0ZXJhdG9yUmVzdWx0PFJlbmRlclJlc3VsdD47XG5cbiAgZG8ge1xuICAgIGl0ZXJhdG9yUmVzdWx0ID0gaXRlcmF0b3IubmV4dCgpIGFzIEl0ZXJhdG9yUmVzdWx0PFJlbmRlclJlc3VsdD47XG4gIH0gd2hpbGUgKCFpdGVyYXRvclJlc3VsdC5kb25lKTtcblxuICBsZXQgcmVzdWx0ID0gaXRlcmF0b3JSZXN1bHQudmFsdWU7XG5cbiAgZW52LmNvbW1pdCgpO1xuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJBb3RNYWluKFxuICBydW50aW1lOiBBb3RSdW50aW1lQ29udGV4dCxcbiAgc2VsZjogUGF0aFJlZmVyZW5jZSxcbiAgdHJlZUJ1aWxkZXI6IEVsZW1lbnRCdWlsZGVyLFxuICBoYW5kbGU6IG51bWJlcixcbiAgZHluYW1pY1Njb3BlOiBEeW5hbWljU2NvcGUgPSBuZXcgRGVmYXVsdER5bmFtaWNTY29wZSgpXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgbGV0IHZtID0gQW90Vk0uaW5pdGlhbChydW50aW1lLCB7IHNlbGYsIGR5bmFtaWNTY29wZSwgdHJlZUJ1aWxkZXIsIGhhbmRsZSB9KTtcbiAgcmV0dXJuIG5ldyBUZW1wbGF0ZUl0ZXJhdG9ySW1wbCh2bSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiByZW5kZXJBb3QoXG4gIHJ1bnRpbWU6IEFvdFJ1bnRpbWVDb250ZXh0LFxuICBoYW5kbGU6IG51bWJlcixcbiAgY3Vyc29yOiBDdXJzb3IsXG4gIHNlbGY6IFBhdGhSZWZlcmVuY2UgPSBVTkRFRklORURfUkVGRVJFTkNFXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgbGV0IHRyZWVCdWlsZGVyID0gTmV3RWxlbWVudEJ1aWxkZXIuZm9ySW5pdGlhbFJlbmRlcihydW50aW1lLmVudiwgY3Vyc29yKTtcbiAgbGV0IGR5bmFtaWNTY29wZSA9IG5ldyBEZWZhdWx0RHluYW1pY1Njb3BlKCk7XG4gIGxldCB2bSA9IEFvdFZNLmluaXRpYWwocnVudGltZSwgeyBzZWxmLCBkeW5hbWljU2NvcGUsIHRyZWVCdWlsZGVyLCBoYW5kbGUgfSk7XG4gIHJldHVybiBuZXcgVGVtcGxhdGVJdGVyYXRvckltcGwodm0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVySml0TWFpbihcbiAgcnVudGltZTogSml0UnVudGltZUNvbnRleHQsXG4gIGNvbnRleHQ6IFN5bnRheENvbXBpbGF0aW9uQ29udGV4dCxcbiAgc2VsZjogUGF0aFJlZmVyZW5jZSxcbiAgdHJlZUJ1aWxkZXI6IEVsZW1lbnRCdWlsZGVyLFxuICBoYW5kbGU6IG51bWJlcixcbiAgZHluYW1pY1Njb3BlOiBEeW5hbWljU2NvcGUgPSBuZXcgRGVmYXVsdER5bmFtaWNTY29wZSgpXG4pOiBUZW1wbGF0ZUl0ZXJhdG9yIHtcbiAgbGV0IHZtID0gSml0Vk0uaW5pdGlhbChydW50aW1lLCBjb250ZXh0LCB7IHNlbGYsIGR5bmFtaWNTY29wZSwgdHJlZUJ1aWxkZXIsIGhhbmRsZSB9KTtcbiAgcmV0dXJuIG5ldyBUZW1wbGF0ZUl0ZXJhdG9ySW1wbCh2bSk7XG59XG5cbmV4cG9ydCB0eXBlIFJlbmRlckNvbXBvbmVudEFyZ3MgPSBEaWN0PFBhdGhSZWZlcmVuY2U+O1xuXG5mdW5jdGlvbiByZW5kZXJJbnZvY2F0aW9uPEMgZXh0ZW5kcyBKaXRPckFvdEJsb2NrPihcbiAgdm06IEludGVybmFsVk08Qz4sXG4gIGludm9jYXRpb246IEludm9jYXRpb24sXG4gIGRlZmluaXRpb246IENvbXBvbmVudERlZmluaXRpb24sXG4gIGFyZ3M6IFJlbmRlckNvbXBvbmVudEFyZ3Ncbik6IFRlbXBsYXRlSXRlcmF0b3Ige1xuICAvLyBHZXQgYSBsaXN0IG9mIHR1cGxlcyBvZiBhcmd1bWVudCBuYW1lcyBhbmQgcmVmZXJlbmNlcywgbGlrZVxuICAvLyBbWyd0aXRsZScsIHJlZmVyZW5jZV0sIFsnbmFtZScsIHJlZmVyZW5jZV1dXG4gIGNvbnN0IGFyZ0xpc3QgPSBPYmplY3Qua2V5cyhhcmdzKS5tYXAoa2V5ID0+IFtrZXksIGFyZ3Nba2V5XV0pO1xuXG4gIGNvbnN0IGJsb2NrTmFtZXMgPSBbJ21haW4nLCAnZWxzZScsICdhdHRycyddO1xuICAvLyBQcmVmaXggYXJndW1lbnQgbmFtZXMgd2l0aCBgQGAgc3ltYm9sXG4gIGNvbnN0IGFyZ05hbWVzID0gYXJnTGlzdC5tYXAoKFtuYW1lXSkgPT4gYEAke25hbWV9YCk7XG5cbiAgdm0ucHVzaEZyYW1lKCk7XG5cbiAgLy8gUHVzaCBibG9ja3Mgb24gdG8gdGhlIHN0YWNrLCB0aHJlZSBzdGFjayB2YWx1ZXMgcGVyIGJsb2NrXG4gIGZvciAobGV0IGkgPSAwOyBpIDwgMyAqIGJsb2NrTmFtZXMubGVuZ3RoOyBpKyspIHtcbiAgICB2bS5zdGFjay5wdXNoKG51bGwpO1xuICB9XG5cbiAgdm0uc3RhY2sucHVzaChudWxsKTtcblxuICAvLyBGb3IgZWFjaCBhcmd1bWVudCwgcHVzaCBpdHMgYmFja2luZyByZWZlcmVuY2Ugb24gdG8gdGhlIHN0YWNrXG4gIGFyZ0xpc3QuZm9yRWFjaCgoWywgcmVmZXJlbmNlXSkgPT4ge1xuICAgIHZtLnN0YWNrLnB1c2gocmVmZXJlbmNlKTtcbiAgfSk7XG5cbiAgLy8gQ29uZmlndXJlIFZNIGJhc2VkIG9uIGJsb2NrcyBhbmQgYXJncyBqdXN0IHB1c2hlZCBvbiB0byB0aGUgc3RhY2suXG4gIHZtW0FSR1NdLnNldHVwKHZtLnN0YWNrLCBhcmdOYW1lcywgYmxvY2tOYW1lcywgMCwgdHJ1ZSk7XG5cbiAgLy8gTmVlZGVkIGZvciB0aGUgT3AuTWFpbiBvcGNvZGU6IGFyZ3VtZW50cywgY29tcG9uZW50IGludm9jYXRpb24gb2JqZWN0LCBhbmRcbiAgLy8gY29tcG9uZW50IGRlZmluaXRpb24uXG4gIHZtLnN0YWNrLnB1c2godm1bQVJHU10pO1xuICB2bS5zdGFjay5wdXNoKGludm9jYXRpb24pO1xuICB2bS5zdGFjay5wdXNoKGRlZmluaXRpb24pO1xuXG4gIHJldHVybiBuZXcgVGVtcGxhdGVJdGVyYXRvckltcGwodm0pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcmVuZGVyQW90Q29tcG9uZW50PFI+KFxuICBydW50aW1lOiBBb3RSdW50aW1lQ29udGV4dDxSPixcbiAgdHJlZUJ1aWxkZXI6IEVsZW1lbnRCdWlsZGVyLFxuICBtYWluOiBudW1iZXIsXG4gIG5hbWU6IHN0cmluZyxcbiAgYXJnczogUmVuZGVyQ29tcG9uZW50QXJncyA9IHt9LFxuICBkeW5hbWljU2NvcGU6IER5bmFtaWNTY29wZSA9IG5ldyBEZWZhdWx0RHluYW1pY1Njb3BlKClcbik6IFRlbXBsYXRlSXRlcmF0b3Ige1xuICBsZXQgdm0gPSBBb3RWTS5lbXB0eShydW50aW1lLCB7IHRyZWVCdWlsZGVyLCBoYW5kbGU6IG1haW4sIGR5bmFtaWNTY29wZSB9KTtcblxuICBjb25zdCBkZWZpbml0aW9uID0gZXhwZWN0KFxuICAgIHJlc29sdmVDb21wb25lbnQodm0ucnVudGltZS5yZXNvbHZlciwgbmFtZSksXG4gICAgYGNvdWxkIG5vdCBmaW5kIGNvbXBvbmVudCBcIiR7bmFtZX1cImBcbiAgKTtcblxuICBjb25zdCB7IG1hbmFnZXIsIHN0YXRlIH0gPSBkZWZpbml0aW9uO1xuXG4gIGNvbnN0IGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpKTtcblxuICBsZXQgaW52b2NhdGlvbjtcblxuICBpZiAoaGFzU3RhdGljTGF5b3V0Q2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIG1hbmFnZXIpKSB7XG4gICAgaW52b2NhdGlvbiA9IChtYW5hZ2VyIGFzIFdpdGhBb3RTdGF0aWNMYXlvdXQpLmdldEFvdFN0YXRpY0xheW91dChzdGF0ZSwgdm0ucnVudGltZS5yZXNvbHZlcik7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3QgaW52b2tlIGNvbXBvbmVudHMgd2l0aCBkeW5hbWljIGxheW91dHMgYXMgYSByb290IGNvbXBvbmVudC4nKTtcbiAgfVxuXG4gIHJldHVybiByZW5kZXJJbnZvY2F0aW9uKHZtLCBpbnZvY2F0aW9uLCBkZWZpbml0aW9uLCBhcmdzKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHJlbmRlckppdENvbXBvbmVudChcbiAgcnVudGltZTogSml0UnVudGltZUNvbnRleHQsXG4gIHRyZWVCdWlsZGVyOiBFbGVtZW50QnVpbGRlcixcbiAgY29udGV4dDogU3ludGF4Q29tcGlsYXRpb25Db250ZXh0LFxuICBtYWluOiBudW1iZXIsXG4gIG5hbWU6IHN0cmluZyxcbiAgYXJnczogUmVuZGVyQ29tcG9uZW50QXJncyA9IHt9LFxuICBkeW5hbWljU2NvcGU6IER5bmFtaWNTY29wZSA9IG5ldyBEZWZhdWx0RHluYW1pY1Njb3BlKClcbik6IFRlbXBsYXRlSXRlcmF0b3Ige1xuICBsZXQgdm0gPSBKaXRWTS5lbXB0eShydW50aW1lLCB7IHRyZWVCdWlsZGVyLCBoYW5kbGU6IG1haW4sIGR5bmFtaWNTY29wZSB9LCBjb250ZXh0KTtcblxuICBjb25zdCBkZWZpbml0aW9uID0gZXhwZWN0KFxuICAgIHJlc29sdmVDb21wb25lbnQodm0ucnVudGltZS5yZXNvbHZlciwgbmFtZSksXG4gICAgYGNvdWxkIG5vdCBmaW5kIGNvbXBvbmVudCBcIiR7bmFtZX1cImBcbiAgKTtcblxuICBjb25zdCB7IG1hbmFnZXIsIHN0YXRlIH0gPSBkZWZpbml0aW9uO1xuXG4gIGNvbnN0IGNhcGFiaWxpdGllcyA9IGNhcGFiaWxpdHlGbGFnc0Zyb20obWFuYWdlci5nZXRDYXBhYmlsaXRpZXMoc3RhdGUpKTtcblxuICBsZXQgaW52b2NhdGlvbjogSW52b2NhdGlvbjtcblxuICBpZiAoaGFzU3RhdGljTGF5b3V0Q2FwYWJpbGl0eShjYXBhYmlsaXRpZXMsIG1hbmFnZXIpKSB7XG4gICAgbGV0IGxheW91dCA9IChtYW5hZ2VyIGFzIFdpdGhKaXRTdGF0aWNMYXlvdXQpLmdldEppdFN0YXRpY0xheW91dChzdGF0ZSwgdm0ucnVudGltZS5yZXNvbHZlcik7XG4gICAgaW52b2NhdGlvbiA9IHsgaGFuZGxlOiBsYXlvdXQuY29tcGlsZShjb250ZXh0KSwgc3ltYm9sVGFibGU6IGxheW91dC5zeW1ib2xUYWJsZSB9O1xuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGludm9rZSBjb21wb25lbnRzIHdpdGggZHluYW1pYyBsYXlvdXRzIGFzIGEgcm9vdCBjb21wb25lbnQuJyk7XG4gIH1cblxuICByZXR1cm4gcmVuZGVySW52b2NhdGlvbih2bSwgaW52b2NhdGlvbiwgZGVmaW5pdGlvbiwgYXJncyk7XG59XG4iXSwic291cmNlUm9vdCI6IiJ9