'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.UpdateDynamicAttributeOpcode = exports.UpdateModifierOpcode = undefined;

var _reference = require('@glimmer/reference');

var _vm = require('@glimmer/vm');

var _opcodes = require('../../opcodes');

var _vm2 = require('./vm');

var _symbols = require('../../symbols');

_opcodes.APPEND_OPCODES.add(40 /* Text */, (vm, { op1: text }) => {
    vm.elements().appendText(vm[_symbols.CONSTANTS].getString(text));
});
_opcodes.APPEND_OPCODES.add(41 /* Comment */, (vm, { op1: text }) => {
    vm.elements().appendComment(vm[_symbols.CONSTANTS].getString(text));
});
_opcodes.APPEND_OPCODES.add(47 /* OpenElement */, (vm, { op1: tag }) => {
    vm.elements().openElement(vm[_symbols.CONSTANTS].getString(tag));
});
_opcodes.APPEND_OPCODES.add(48 /* OpenDynamicElement */, vm => {
    let tagName = vm.stack.pop().value();
    vm.elements().openElement(tagName);
});
_opcodes.APPEND_OPCODES.add(49 /* PushRemoteElement */, vm => {
    let elementRef = vm.stack.pop();
    let insertBeforeRef = vm.stack.pop();
    let guidRef = vm.stack.pop();
    let element;
    let insertBefore;
    let guid = guidRef.value();
    if ((0, _reference.isConst)(elementRef)) {
        element = elementRef.value();
    } else {
        let cache = new _reference.ReferenceCache(elementRef);
        element = cache.peek();
        vm.updateWith(new _vm2.Assert(cache));
    }
    if (insertBeforeRef.value() !== undefined) {
        if ((0, _reference.isConst)(insertBeforeRef)) {
            insertBefore = insertBeforeRef.value();
        } else {
            let cache = new _reference.ReferenceCache(insertBeforeRef);
            insertBefore = cache.peek();
            vm.updateWith(new _vm2.Assert(cache));
        }
    }
    let block = vm.elements().pushRemoteElement(element, guid, insertBefore);
    if (block) vm.associateDestroyable(block);
});
_opcodes.APPEND_OPCODES.add(55 /* PopRemoteElement */, vm => {
    vm.elements().popRemoteElement();
});
_opcodes.APPEND_OPCODES.add(53 /* FlushElement */, vm => {
    let operations = vm.fetchValue(_vm.$t0);
    let modifiers = null;
    if (operations) {
        modifiers = operations.flush(vm);
        vm.loadValue(_vm.$t0, null);
    }
    vm.elements().flushElement(modifiers);
});
_opcodes.APPEND_OPCODES.add(54 /* CloseElement */, vm => {
    let modifiers = vm.elements().closeElement();
    if (modifiers) {
        modifiers.forEach(([manager, modifier]) => {
            vm.env.scheduleInstallModifier(modifier, manager);
            let d = manager.getDestructor(modifier);
            if (d) {
                vm.associateDestroyable(d);
            }
        });
    }
});
_opcodes.APPEND_OPCODES.add(56 /* Modifier */, (vm, { op1: handle }) => {
    let { manager, state } = vm.runtime.resolver.resolve(handle);
    let stack = vm.stack;
    let args = stack.pop();
    let { constructing, updateOperations } = vm.elements();
    let dynamicScope = vm.dynamicScope();
    let modifier = manager.create(constructing, state, args, dynamicScope, updateOperations);
    let operations = vm.fetchValue(_vm.$t0);
    operations.addModifier(manager, modifier);
    let tag = manager.getTag(modifier);
    if (!(0, _reference.isConstTag)(tag)) {
        vm.updateWith(new UpdateModifierOpcode(tag, manager, modifier));
    }
});
class UpdateModifierOpcode extends _opcodes.UpdatingOpcode {
    constructor(tag, manager, modifier) {
        super();
        this.tag = tag;
        this.manager = manager;
        this.modifier = modifier;
        this.type = 'update-modifier';
        this.lastUpdated = (0, _reference.value)(tag);
    }
    evaluate(vm) {
        let { manager, modifier, tag, lastUpdated } = this;
        if (!(0, _reference.validate)(tag, lastUpdated)) {
            vm.env.scheduleUpdateModifier(modifier, manager);
            this.lastUpdated = (0, _reference.value)(tag);
        }
    }
}
exports.UpdateModifierOpcode = UpdateModifierOpcode;
_opcodes.APPEND_OPCODES.add(50 /* StaticAttr */, (vm, { op1: _name, op2: _value, op3: _namespace }) => {
    let name = vm[_symbols.CONSTANTS].getString(_name);
    let value = vm[_symbols.CONSTANTS].getString(_value);
    let namespace = _namespace ? vm[_symbols.CONSTANTS].getString(_namespace) : null;
    vm.elements().setStaticAttribute(name, value, namespace);
});
_opcodes.APPEND_OPCODES.add(51 /* DynamicAttr */, (vm, { op1: _name, op2: trusting, op3: _namespace }) => {
    let name = vm[_symbols.CONSTANTS].getString(_name);
    let reference = vm.stack.pop();
    let value = reference.value();
    let namespace = _namespace ? vm[_symbols.CONSTANTS].getString(_namespace) : null;
    let attribute = vm.elements().setDynamicAttribute(name, value, !!trusting, namespace);
    if (!(0, _reference.isConst)(reference)) {
        vm.updateWith(new UpdateDynamicAttributeOpcode(reference, attribute));
    }
});
class UpdateDynamicAttributeOpcode extends _opcodes.UpdatingOpcode {
    constructor(reference, attribute) {
        super();
        this.reference = reference;
        this.attribute = attribute;
        this.type = 'patch-element';
        let { tag } = reference;
        this.tag = tag;
        this.lastRevision = (0, _reference.value)(tag);
    }
    evaluate(vm) {
        let { attribute, reference, tag } = this;
        if (!(0, _reference.validate)(tag, this.lastRevision)) {
            this.lastRevision = (0, _reference.value)(tag);
            attribute.update(reference.value(), vm.env);
        }
    }
}
exports.UpdateDynamicAttributeOpcode = UpdateDynamicAttributeOpcode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvZG9tLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQWFBOztBQU1BOztBQUVBOztBQUdBOztBQUlBLHdCQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsVUFBQSxFQUE0QixDQUFBLEVBQUEsRUFBSyxFQUFFLEtBQVAsSUFBSyxFQUFMLEtBQXNCO0FBQ2hELE9BQUEsUUFBQSxHQUFBLFVBQUEsQ0FBeUIsR0FBQSxrQkFBQSxFQUFBLFNBQUEsQ0FBekIsSUFBeUIsQ0FBekI7QUFERixDQUFBO0FBSUEsd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxhQUFBLEVBQStCLENBQUEsRUFBQSxFQUFLLEVBQUUsS0FBUCxJQUFLLEVBQUwsS0FBc0I7QUFDbkQsT0FBQSxRQUFBLEdBQUEsYUFBQSxDQUE0QixHQUFBLGtCQUFBLEVBQUEsU0FBQSxDQUE1QixJQUE0QixDQUE1QjtBQURGLENBQUE7QUFJQSx3QkFBQSxHQUFBLENBQUEsRUFBQSxDQUFBLGlCQUFBLEVBQW1DLENBQUEsRUFBQSxFQUFLLEVBQUUsS0FBUCxHQUFLLEVBQUwsS0FBcUI7QUFDdEQsT0FBQSxRQUFBLEdBQUEsV0FBQSxDQUEwQixHQUFBLGtCQUFBLEVBQUEsU0FBQSxDQUExQixHQUEwQixDQUExQjtBQURGLENBQUE7QUFJQSx3QkFBQSxHQUFBLENBQUEsRUFBQSxDQUFBLHdCQUFBLEVBQTBDLE1BQUs7QUFDN0MsUUFBSSxVQUFzQixHQUFBLEtBQUEsQ0FBTixHQUFNLEdBQTFCLEtBQTBCLEVBQTFCO0FBQ0EsT0FBQSxRQUFBLEdBQUEsV0FBQSxDQUFBLE9BQUE7QUFGRixDQUFBO0FBS0Esd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSx1QkFBQSxFQUF5QyxNQUFLO0FBQzVDLFFBQUksYUFBbUIsR0FBQSxLQUFBLENBQXZCLEdBQXVCLEVBQXZCO0FBQ0EsUUFBSSxr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cEI7QUFDRDtBQUVELGFBQUEsRUFBQSxFQUF1QjtBQUNyQixZQUFJLEVBQUEsU0FBQSxFQUFBLFNBQUEsRUFBQSxHQUFBLEtBQUosSUFBQTtBQUNBLFlBQUksQ0FBQyx5QkFBQSxHQUFBLEVBQWMsS0FBbkIsWUFBSyxDQUFMLEVBQXVDO0FBQ3JDLGlCQUFBLFlBQUEsR0FBb0Isc0JBQXBCLEdBQW9CLENBQXBCO0FBQ0Esc0JBQUEsTUFBQSxDQUFpQixVQUFqQixLQUFpQixFQUFqQixFQUFvQyxHQUFwQyxHQUFBO0FBQ0Q7QUFDRjtBQW5CNkQ7UUFBMUQsNEIsR0FBQSw0QiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIFJlZmVyZW5jZSxcbiAgUmVmZXJlbmNlQ2FjaGUsXG4gIFJldmlzaW9uLFxuICBUYWcsXG4gIFZlcnNpb25lZFJlZmVyZW5jZSxcbiAgaXNDb25zdCxcbiAgaXNDb25zdFRhZyxcbiAgdmFsdWUsXG4gIHZhbGlkYXRlLFxufSBmcm9tICdAZ2xpbW1lci9yZWZlcmVuY2UnO1xuaW1wb3J0IHsgY2hlY2ssIENoZWNrU3RyaW5nLCBDaGVja0VsZW1lbnQsIENoZWNrT3B0aW9uLCBDaGVja05vZGUgfSBmcm9tICdAZ2xpbW1lci9kZWJ1Zyc7XG5pbXBvcnQgeyBPcCwgT3B0aW9uLCBNb2RpZmllck1hbmFnZXIgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7ICR0MCB9IGZyb20gJ0BnbGltbWVyL3ZtJztcbmltcG9ydCB7XG4gIE1vZGlmaWVyRGVmaW5pdGlvbixcbiAgSW50ZXJuYWxNb2RpZmllck1hbmFnZXIsXG4gIE1vZGlmaWVySW5zdGFuY2VTdGF0ZSxcbn0gZnJvbSAnLi4vLi4vbW9kaWZpZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBBUFBFTkRfT1BDT0RFUywgVXBkYXRpbmdPcGNvZGUgfSBmcm9tICcuLi8uLi9vcGNvZGVzJztcbmltcG9ydCB7IFVwZGF0aW5nVk0gfSBmcm9tICcuLi8uLi92bSc7XG5pbXBvcnQgeyBBc3NlcnQgfSBmcm9tICcuL3ZtJztcbmltcG9ydCB7IER5bmFtaWNBdHRyaWJ1dGUgfSBmcm9tICcuLi8uLi92bS9hdHRyaWJ1dGVzL2R5bmFtaWMnO1xuaW1wb3J0IHsgQ2hlY2tSZWZlcmVuY2UsIENoZWNrQXJndW1lbnRzLCBDaGVja09wZXJhdGlvbnMgfSBmcm9tICcuLy1kZWJ1Zy1zdHJpcCc7XG5pbXBvcnQgeyBDT05TVEFOVFMgfSBmcm9tICcuLi8uLi9zeW1ib2xzJztcbmltcG9ydCB7IFNpbXBsZUVsZW1lbnQsIFNpbXBsZU5vZGUgfSBmcm9tICdAc2ltcGxlLWRvbS9pbnRlcmZhY2UnO1xuaW1wb3J0IHsgZXhwZWN0LCBNYXliZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuVGV4dCwgKHZtLCB7IG9wMTogdGV4dCB9KSA9PiB7XG4gIHZtLmVsZW1lbnRzKCkuYXBwZW5kVGV4dCh2bVtDT05TVEFOVFNdLmdldFN0cmluZyh0ZXh0KSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkNvbW1lbnQsICh2bSwgeyBvcDE6IHRleHQgfSkgPT4ge1xuICB2bS5lbGVtZW50cygpLmFwcGVuZENvbW1lbnQodm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcodGV4dCkpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5PcGVuRWxlbWVudCwgKHZtLCB7IG9wMTogdGFnIH0pID0+IHtcbiAgdm0uZWxlbWVudHMoKS5vcGVuRWxlbWVudCh2bVtDT05TVEFOVFNdLmdldFN0cmluZyh0YWcpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuT3BlbkR5bmFtaWNFbGVtZW50LCB2bSA9PiB7XG4gIGxldCB0YWdOYW1lID0gY2hlY2soY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKS52YWx1ZSgpLCBDaGVja1N0cmluZyk7XG4gIHZtLmVsZW1lbnRzKCkub3BlbkVsZW1lbnQodGFnTmFtZSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlB1c2hSZW1vdGVFbGVtZW50LCB2bSA9PiB7XG4gIGxldCBlbGVtZW50UmVmID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcbiAgbGV0IGluc2VydEJlZm9yZVJlZiA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja1JlZmVyZW5jZSk7XG4gIGxldCBndWlkUmVmID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBsZXQgZWxlbWVudDogU2ltcGxlRWxlbWVudDtcbiAgbGV0IGluc2VydEJlZm9yZTogTWF5YmU8U2ltcGxlTm9kZT47XG4gIGxldCBndWlkID0gZ3VpZFJlZi52YWx1ZSgpIGFzIHN0cmluZztcblxuICBpZiAoaXNDb25zdChlbGVtZW50UmVmKSkge1xuICAgIGVsZW1lbnQgPSBjaGVjayhlbGVtZW50UmVmLnZhbHVlKCksIENoZWNrRWxlbWVudCk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGNhY2hlID0gbmV3IFJlZmVyZW5jZUNhY2hlKGVsZW1lbnRSZWYgYXMgUmVmZXJlbmNlPFNpbXBsZUVsZW1lbnQ+KTtcbiAgICBlbGVtZW50ID0gY2hlY2soY2FjaGUucGVlaygpLCBDaGVja0VsZW1lbnQpO1xuICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICB9XG5cbiAgaWYgKGluc2VydEJlZm9yZVJlZi52YWx1ZSgpICE9PSB1bmRlZmluZWQpIHtcbiAgICBpZiAoaXNDb25zdChpbnNlcnRCZWZvcmVSZWYpKSB7XG4gICAgICBpbnNlcnRCZWZvcmUgPSBjaGVjayhpbnNlcnRCZWZvcmVSZWYudmFsdWUoKSwgQ2hlY2tPcHRpb24oQ2hlY2tOb2RlKSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxldCBjYWNoZSA9IG5ldyBSZWZlcmVuY2VDYWNoZShpbnNlcnRCZWZvcmVSZWYgYXMgUmVmZXJlbmNlPE9wdGlvbjxTaW1wbGVOb2RlPj4pO1xuICAgICAgaW5zZXJ0QmVmb3JlID0gY2hlY2soY2FjaGUucGVlaygpLCBDaGVja09wdGlvbihDaGVja05vZGUpKTtcbiAgICAgIHZtLnVwZGF0ZVdpdGgobmV3IEFzc2VydChjYWNoZSkpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBibG9jayA9IHZtLmVsZW1lbnRzKCkucHVzaFJlbW90ZUVsZW1lbnQoZWxlbWVudCwgZ3VpZCwgaW5zZXJ0QmVmb3JlKTtcbiAgaWYgKGJsb2NrKSB2bS5hc3NvY2lhdGVEZXN0cm95YWJsZShibG9jayk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlBvcFJlbW90ZUVsZW1lbnQsIHZtID0+IHtcbiAgdm0uZWxlbWVudHMoKS5wb3BSZW1vdGVFbGVtZW50KCk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkZsdXNoRWxlbWVudCwgdm0gPT4ge1xuICBsZXQgb3BlcmF0aW9ucyA9IGNoZWNrKHZtLmZldGNoVmFsdWUoJHQwKSwgQ2hlY2tPcGVyYXRpb25zKTtcbiAgbGV0IG1vZGlmaWVyczogT3B0aW9uPFtNb2RpZmllck1hbmFnZXIsIHVua25vd25dW10+ID0gbnVsbDtcblxuICBpZiAob3BlcmF0aW9ucykge1xuICAgIG1vZGlmaWVycyA9IG9wZXJhdGlvbnMuZmx1c2godm0pO1xuICAgIHZtLmxvYWRWYWx1ZSgkdDAsIG51bGwpO1xuICB9XG5cbiAgdm0uZWxlbWVudHMoKS5mbHVzaEVsZW1lbnQobW9kaWZpZXJzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQ2xvc2VFbGVtZW50LCB2bSA9PiB7XG4gIGxldCBtb2RpZmllcnMgPSB2bS5lbGVtZW50cygpLmNsb3NlRWxlbWVudCgpO1xuXG4gIGlmIChtb2RpZmllcnMpIHtcbiAgICBtb2RpZmllcnMuZm9yRWFjaCgoW21hbmFnZXIsIG1vZGlmaWVyXSkgPT4ge1xuICAgICAgdm0uZW52LnNjaGVkdWxlSW5zdGFsbE1vZGlmaWVyKG1vZGlmaWVyLCBtYW5hZ2VyKTtcbiAgICAgIGxldCBkID0gbWFuYWdlci5nZXREZXN0cnVjdG9yKG1vZGlmaWVyKTtcblxuICAgICAgaWYgKGQpIHtcbiAgICAgICAgdm0uYXNzb2NpYXRlRGVzdHJveWFibGUoZCk7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuTW9kaWZpZXIsICh2bSwgeyBvcDE6IGhhbmRsZSB9KSA9PiB7XG4gIGxldCB7IG1hbmFnZXIsIHN0YXRlIH0gPSB2bS5ydW50aW1lLnJlc29sdmVyLnJlc29sdmU8TW9kaWZpZXJEZWZpbml0aW9uPihoYW5kbGUpO1xuICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgbGV0IGFyZ3MgPSBjaGVjayhzdGFjay5wb3AoKSwgQ2hlY2tBcmd1bWVudHMpO1xuICBsZXQgeyBjb25zdHJ1Y3RpbmcsIHVwZGF0ZU9wZXJhdGlvbnMgfSA9IHZtLmVsZW1lbnRzKCk7XG4gIGxldCBkeW5hbWljU2NvcGUgPSB2bS5keW5hbWljU2NvcGUoKTtcbiAgbGV0IG1vZGlmaWVyID0gbWFuYWdlci5jcmVhdGUoXG4gICAgZXhwZWN0KGNvbnN0cnVjdGluZywgJ0JVRzogRWxlbWVudE1vZGlmaWVyIGNvdWxkIG5vdCBmaW5kIHRoZSBlbGVtZW50IGl0IGFwcGxpZXMgdG8nKSxcbiAgICBzdGF0ZSxcbiAgICBhcmdzLFxuICAgIGR5bmFtaWNTY29wZSxcbiAgICB1cGRhdGVPcGVyYXRpb25zXG4gICk7XG5cbiAgbGV0IG9wZXJhdGlvbnMgPSBleHBlY3QoXG4gICAgY2hlY2sodm0uZmV0Y2hWYWx1ZSgkdDApLCBDaGVja09wZXJhdGlvbnMpLFxuICAgICdCVUc6IEVsZW1lbnRNb2RpZmllciBjb3VsZCBub3QgZmluZCBvcGVyYXRpb25zIHRvIGFwcGVuZCB0bydcbiAgKTtcblxuICBvcGVyYXRpb25zLmFkZE1vZGlmaWVyKG1hbmFnZXIsIG1vZGlmaWVyKTtcblxuICBsZXQgdGFnID0gbWFuYWdlci5nZXRUYWcobW9kaWZpZXIpO1xuXG4gIGlmICghaXNDb25zdFRhZyh0YWcpKSB7XG4gICAgdm0udXBkYXRlV2l0aChuZXcgVXBkYXRlTW9kaWZpZXJPcGNvZGUodGFnLCBtYW5hZ2VyLCBtb2RpZmllcikpO1xuICB9XG59KTtcblxuZXhwb3J0IGNsYXNzIFVwZGF0ZU1vZGlmaWVyT3Bjb2RlIGV4dGVuZHMgVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9ICd1cGRhdGUtbW9kaWZpZXInO1xuICBwcml2YXRlIGxhc3RVcGRhdGVkOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwdWJsaWMgdGFnOiBUYWcsXG4gICAgcHJpdmF0ZSBtYW5hZ2VyOiBJbnRlcm5hbE1vZGlmaWVyTWFuYWdlcixcbiAgICBwcml2YXRlIG1vZGlmaWVyOiBNb2RpZmllckluc3RhbmNlU3RhdGVcbiAgKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmxhc3RVcGRhdGVkID0gdmFsdWUodGFnKTtcbiAgfVxuXG4gIGV2YWx1YXRlKHZtOiBVcGRhdGluZ1ZNKSB7XG4gICAgbGV0IHsgbWFuYWdlciwgbW9kaWZpZXIsIHRhZywgbGFzdFVwZGF0ZWQgfSA9IHRoaXM7XG5cbiAgICBpZiAoIXZhbGlkYXRlKHRhZywgbGFzdFVwZGF0ZWQpKSB7XG4gICAgICB2bS5lbnYuc2NoZWR1bGVVcGRhdGVNb2RpZmllcihtb2RpZmllciwgbWFuYWdlcik7XG4gICAgICB0aGlzLmxhc3RVcGRhdGVkID0gdmFsdWUodGFnKTtcbiAgICB9XG4gIH1cbn1cblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlN0YXRpY0F0dHIsICh2bSwgeyBvcDE6IF9uYW1lLCBvcDI6IF92YWx1ZSwgb3AzOiBfbmFtZXNwYWNlIH0pID0+IHtcbiAgbGV0IG5hbWUgPSB2bVtDT05TVEFOVFNdLmdldFN0cmluZyhfbmFtZSk7XG4gIGxldCB2YWx1ZSA9IHZtW0NPTlNUQU5UU10uZ2V0U3RyaW5nKF92YWx1ZSk7XG4gIGxldCBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWVzcGFjZSkgOiBudWxsO1xuXG4gIHZtLmVsZW1lbnRzKCkuc2V0U3RhdGljQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBuYW1lc3BhY2UpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5EeW5hbWljQXR0ciwgKHZtLCB7IG9wMTogX25hbWUsIG9wMjogdHJ1c3RpbmcsIG9wMzogX25hbWVzcGFjZSB9KSA9PiB7XG4gIGxldCBuYW1lID0gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWUpO1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcbiAgbGV0IHZhbHVlID0gcmVmZXJlbmNlLnZhbHVlKCk7XG4gIGxldCBuYW1lc3BhY2UgPSBfbmFtZXNwYWNlID8gdm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcoX25hbWVzcGFjZSkgOiBudWxsO1xuXG4gIGxldCBhdHRyaWJ1dGUgPSB2bS5lbGVtZW50cygpLnNldER5bmFtaWNBdHRyaWJ1dGUobmFtZSwgdmFsdWUsICEhdHJ1c3RpbmcsIG5hbWVzcGFjZSk7XG5cbiAgaWYgKCFpc0NvbnN0KHJlZmVyZW5jZSkpIHtcbiAgICB2bS51cGRhdGVXaXRoKG5ldyBVcGRhdGVEeW5hbWljQXR0cmlidXRlT3Bjb2RlKHJlZmVyZW5jZSwgYXR0cmlidXRlKSk7XG4gIH1cbn0pO1xuXG5leHBvcnQgY2xhc3MgVXBkYXRlRHluYW1pY0F0dHJpYnV0ZU9wY29kZSBleHRlbmRzIFVwZGF0aW5nT3Bjb2RlIHtcbiAgcHVibGljIHR5cGUgPSAncGF0Y2gtZWxlbWVudCc7XG5cbiAgcHVibGljIHRhZzogVGFnO1xuICBwdWJsaWMgbGFzdFJldmlzaW9uOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlZmVyZW5jZTogVmVyc2lvbmVkUmVmZXJlbmNlPHVua25vd24+LCBwcml2YXRlIGF0dHJpYnV0ZTogRHluYW1pY0F0dHJpYnV0ZSkge1xuICAgIHN1cGVyKCk7XG4gICAgbGV0IHsgdGFnIH0gPSByZWZlcmVuY2U7XG4gICAgdGhpcy50YWcgPSB0YWc7XG4gICAgdGhpcy5sYXN0UmV2aXNpb24gPSB2YWx1ZSh0YWcpO1xuICB9XG5cbiAgZXZhbHVhdGUodm06IFVwZGF0aW5nVk0pIHtcbiAgICBsZXQgeyBhdHRyaWJ1dGUsIHJlZmVyZW5jZSwgdGFnIH0gPSB0aGlzO1xuICAgIGlmICghdmFsaWRhdGUodGFnLCB0aGlzLmxhc3RSZXZpc2lvbikpIHtcbiAgICAgIHRoaXMubGFzdFJldmlzaW9uID0gdmFsdWUodGFnKTtcbiAgICAgIGF0dHJpYnV0ZS51cGRhdGUocmVmZXJlbmNlLnZhbHVlKCksIHZtLmVudik7XG4gICAgfVxuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9