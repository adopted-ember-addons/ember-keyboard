'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.LabelOpcode = exports.DidModifyOpcode = exports.JumpIfNotModifiedOpcode = exports.Assert = undefined;

var _reference = require('@glimmer/reference');

var _util = require('@glimmer/util');

var _assert = require('./assert');

var _opcodes = require('../../opcodes');

var _references = require('../../references');

var _symbols = require('../../symbols');

_opcodes.APPEND_OPCODES.add(38 /* ChildScope */, vm => vm.pushChildScope());
_opcodes.APPEND_OPCODES.add(39 /* PopScope */, vm => vm.popScope());
_opcodes.APPEND_OPCODES.add(58 /* PushDynamicScope */, vm => vm.pushDynamicScope());
_opcodes.APPEND_OPCODES.add(59 /* PopDynamicScope */, vm => vm.popDynamicScope());
_opcodes.APPEND_OPCODES.add(28 /* Constant */, (vm, { op1: other }) => {
    vm.stack.push(vm[_symbols.CONSTANTS].getOther(other));
});
_opcodes.APPEND_OPCODES.add(29 /* Primitive */, (vm, { op1: primitive }) => {
    let stack = vm.stack;
    let flag = primitive & 7; // 111
    let value = primitive >> 3;
    switch (flag) {
        case 0 /* NUMBER */:
            stack.push(value);
            break;
        case 1 /* FLOAT */:
            stack.push(vm[_symbols.CONSTANTS].getNumber(value));
            break;
        case 2 /* STRING */:
            stack.push(vm[_symbols.CONSTANTS].getString(value));
            break;
        case 3 /* BOOLEAN_OR_VOID */:
            stack.pushRaw(primitive);
            break;
        case 4 /* NEGATIVE */:
            stack.push(vm[_symbols.CONSTANTS].getNumber(value));
            break;
        case 5 /* BIG_NUM */:
            stack.push(vm[_symbols.CONSTANTS].getNumber(value));
            break;
    }
});
_opcodes.APPEND_OPCODES.add(30 /* PrimitiveReference */, vm => {
    let stack = vm.stack;
    stack.push(_references.PrimitiveReference.create(stack.pop()));
});
_opcodes.APPEND_OPCODES.add(31 /* ReifyU32 */, vm => {
    let stack = vm.stack;
    stack.push(stack.peek().value());
});
_opcodes.APPEND_OPCODES.add(32 /* Dup */, (vm, { op1: register, op2: offset }) => {
    let position = vm.fetchValue(register) - offset;
    vm.stack.dup(position);
});
_opcodes.APPEND_OPCODES.add(33 /* Pop */, (vm, { op1: count }) => {
    vm.stack.pop(count);
});
_opcodes.APPEND_OPCODES.add(34 /* Load */, (vm, { op1: register }) => {
    vm.load(register);
});
_opcodes.APPEND_OPCODES.add(35 /* Fetch */, (vm, { op1: register }) => {
    vm.fetch(register);
});
_opcodes.APPEND_OPCODES.add(57 /* BindDynamicScope */, (vm, { op1: _names }) => {
    let names = vm[_symbols.CONSTANTS].getArray(_names);
    vm.bindDynamicScope(names);
});
_opcodes.APPEND_OPCODES.add(68 /* Enter */, (vm, { op1: args }) => {
    vm.enter(args);
});
_opcodes.APPEND_OPCODES.add(69 /* Exit */, vm => {
    vm.exit();
});
_opcodes.APPEND_OPCODES.add(62 /* PushSymbolTable */, (vm, { op1: _table }) => {
    let stack = vm.stack;
    stack.push(vm[_symbols.CONSTANTS].getTemplateMeta(_table));
});
_opcodes.APPEND_OPCODES.add(61 /* PushBlockScope */, vm => {
    let stack = vm.stack;
    stack.push(vm.scope());
});
_opcodes.APPEND_OPCODES.add(60 /* CompileBlock */, vm => {
    let stack = vm.stack;
    let block = stack.pop();
    if (block) {
        stack.push(vm.compile(block));
    } else {
        stack.push(null);
    }
}, 'jit');
_opcodes.APPEND_OPCODES.add(63 /* InvokeYield */, vm => {
    let { stack } = vm;
    let handle = stack.pop();
    let scope = stack.pop();
    let table = stack.pop();
    false && (0, _util.assert)(table === null || table && typeof table === 'object' && Array.isArray(table.parameters), (0, _assert.stackAssert)('Option<BlockSymbolTable>', table));

    let args = stack.pop();
    if (table === null) {
        // To balance the pop{Frame,Scope}
        vm.pushFrame();
        vm.pushScope(scope); // Could be null but it doesnt matter as it is immediatelly popped.
        return;
    }
    let invokingScope = scope;
    // If necessary, create a child scope
    {
        let locals = table.parameters;
        let localsCount = locals.length;
        if (localsCount > 0) {
            invokingScope = invokingScope.child();
            for (let i = 0; i < localsCount; i++) {
                invokingScope.bindSymbol(locals[i], args.at(i));
            }
        }
    }
    vm.pushFrame();
    vm.pushScope(invokingScope);
    vm.call(handle);
});
_opcodes.APPEND_OPCODES.add(64 /* JumpIf */, (vm, { op1: target }) => {
    let reference = vm.stack.pop();
    if ((0, _reference.isConst)(reference)) {
        if (reference.value()) {
            vm.goto(target);
        }
    } else {
        let cache = new _reference.ReferenceCache(reference);
        if (cache.peek()) {
            vm.goto(target);
        }
        vm.updateWith(new Assert(cache));
    }
});
_opcodes.APPEND_OPCODES.add(65 /* JumpUnless */, (vm, { op1: target }) => {
    let reference = vm.stack.pop();
    if ((0, _reference.isConst)(reference)) {
        if (!reference.value()) {
            vm.goto(target);
        }
    } else {
        let cache = new _reference.ReferenceCache(reference);
        if (!cache.peek()) {
            vm.goto(target);
        }
        vm.updateWith(new Assert(cache));
    }
});
_opcodes.APPEND_OPCODES.add(66 /* JumpEq */, (vm, { op1: target, op2: comparison }) => {
    let other = vm.stack.peek();
    if (other === comparison) {
        vm.goto(target);
    }
});
_opcodes.APPEND_OPCODES.add(67 /* AssertSame */, vm => {
    let reference = vm.stack.peek();
    if (!(0, _reference.isConst)(reference)) {
        vm.updateWith(Assert.initialize(new _reference.ReferenceCache(reference)));
    }
});
_opcodes.APPEND_OPCODES.add(70 /* ToBoolean */, vm => {
    let { env, stack } = vm;
    stack.push(env.toConditionalReference(stack.pop()));
});
class Assert extends _opcodes.UpdatingOpcode {
    constructor(cache) {
        super();
        this.type = 'assert';
        this.tag = cache.tag;
        this.cache = cache;
    }
    static initialize(cache) {
        let assert = new Assert(cache);
        cache.peek();
        return assert;
    }
    evaluate(vm) {
        let { cache } = this;
        if ((0, _reference.isModified)(cache.revalidate())) {
            vm.throw();
        }
    }
}
exports.Assert = Assert;
class JumpIfNotModifiedOpcode extends _opcodes.UpdatingOpcode {
    constructor(tag, target) {
        super();
        this.target = target;
        this.type = 'jump-if-not-modified';
        this.tag = tag;
        this.lastRevision = (0, _reference.value)(tag);
    }
    evaluate(vm) {
        let { tag, target, lastRevision } = this;
        if (!vm.alwaysRevalidate && (0, _reference.validate)(tag, lastRevision)) {
            vm.goto(target);
        }
    }
    didModify() {
        this.lastRevision = (0, _reference.value)(this.tag);
    }
}
exports.JumpIfNotModifiedOpcode = JumpIfNotModifiedOpcode;
class DidModifyOpcode extends _opcodes.UpdatingOpcode {
    constructor(target) {
        super();
        this.target = target;
        this.type = 'did-modify';
        this.tag = _reference.CONSTANT_TAG;
    }
    evaluate() {
        this.target.didModify();
    }
}
exports.DidModifyOpcode = DidModifyOpcode;
class LabelOpcode {
    constructor(label) {
        this.tag = _reference.CONSTANT_TAG;
        this.type = 'label';
        this.label = null;
        this.prev = null;
        this.next = null;
        (0, _util.initializeGuid)(this);
        this.label = label;
    }
    evaluate() {}
    inspect() {
        return `${this.label} [${this._guid}]`;
    }
}
exports.LabelOpcode = LabelOpcode;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3J1bnRpbWUvbGliL2NvbXBpbGVkL29wY29kZXMvdm0udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBV0E7O0FBVUE7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBR0Esd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxnQkFBQSxFQUFrQyxNQUFNLEdBQXhDLGNBQXdDLEVBQXhDO0FBRUEsd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxjQUFBLEVBQWdDLE1BQU0sR0FBdEMsUUFBc0MsRUFBdEM7QUFFQSx3QkFBQSxHQUFBLENBQUEsRUFBQSxDQUFBLHNCQUFBLEVBQXdDLE1BQU0sR0FBOUMsZ0JBQThDLEVBQTlDO0FBRUEsd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxxQkFBQSxFQUF1QyxNQUFNLEdBQTdDLGVBQTZDLEVBQTdDO0FBRUEsd0JBQUEsR0FBQSxDQUFBLEVBQUEsQ0FBQSxjQUFBLEVBQWdDLENBQUEsRUFBQSxFQUFLLEVBQUUsS0FBUCxLQUFLLEVBQUwsS0FBdUI7QUFDckQsT0FBQSxLQUFBLENBQUEsSUFBQSxDQUFjLEdBQUEsa0JBQUEsRUFBQSxRQUFBLENBQWQsS0FBYyxDQUFkO0FBREYsQ0FBQTtBQUlBLHdCQUFBLEdBQUEsQ0FBQSxFQUFBLENBQUEsZUFBQSxFQUFpQyxDQUFBLEVBQUEsRUFBSyxFQUFFLEtBQVAsU0FBSyxFQUFMLEtBQTJCO0FBQzFELFFBQUksUUFBUSxHQUFaLEtBQUE7QUFDQSxRQUFJLE9BQU8sWUFGK0MsQ0FFMUQsQ0FGMEQsQ0FFaEM7QUFDMUIsUUFBSSxRQUFRLGFBQVosQ0FBQTtBQUVBLFlBQUEsSUFBQTtBQUNFLGFBQUEsQ0FBQSxDQUFBLFlBQUE7QUFDRSxrQkFBQSxJQUFBLENBQUEsS0FBQTtBQUNBO0FBQ0YsYUFBQSxDQUFBLENBQUEsV0FBQTtBQUNFLGtCQUFBLElBQUEsQ0FBVyxHQUFBLGtCQUFBLEVBQUEsU0FBQSxDQUFY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QUFBLEdBQUEsR0FBQSx1QkFBQTtBQUNBLGFBQUEsSUFBQSxHQUFBLE9BQUE7QUFDQSxhQUFBLEtBQUEsR0FBQSxJQUFBO0FBR1AsYUFBQSxJQUFBLEdBQUEsSUFBQTtBQUNBLGFBQUEsSUFBQSxHQUFBLElBQUE7QUFHRSxrQ0FBQSxJQUFBO0FBQ0EsYUFBQSxLQUFBLEdBQUEsS0FBQTtBQUNEO0FBRUQsZUFBUSxDQUFLO0FBRWIsY0FBTztBQUNMLGVBQU8sR0FBRyxLQUFLLEtBQUssS0FBSyxLQUFLLEtBQTlCLEdBQUE7QUFDRDtBQWxCcUI7UUFBbEIsVyxHQUFBLFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBQcmltaXRpdmVUeXBlLCBDb21waWxhYmxlVGVtcGxhdGUsIE9wdGlvbiwgT3AgfSBmcm9tICdAZ2xpbW1lci9pbnRlcmZhY2VzJztcbmltcG9ydCB7XG4gIENPTlNUQU5UX1RBRyxcbiAgaXNDb25zdCxcbiAgaXNNb2RpZmllZCxcbiAgUmVmZXJlbmNlQ2FjaGUsXG4gIFJldmlzaW9uLFxuICBUYWcsXG4gIHZhbHVlLFxuICB2YWxpZGF0ZSxcbn0gZnJvbSAnQGdsaW1tZXIvcmVmZXJlbmNlJztcbmltcG9ydCB7IGluaXRpYWxpemVHdWlkLCBhc3NlcnQgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7XG4gIENoZWNrTnVtYmVyLFxuICBjaGVjayxcbiAgQ2hlY2tJbnN0YW5jZW9mLFxuICBDaGVja09wdGlvbixcbiAgQ2hlY2tCbG9ja1N5bWJvbFRhYmxlLFxuICBDaGVja0hhbmRsZSxcbiAgQ2hlY2tQcmltaXRpdmUsXG59IGZyb20gJ0BnbGltbWVyL2RlYnVnJztcbmltcG9ydCB7IHN0YWNrQXNzZXJ0IH0gZnJvbSAnLi9hc3NlcnQnO1xuaW1wb3J0IHsgQVBQRU5EX09QQ09ERVMsIFVwZGF0aW5nT3Bjb2RlIH0gZnJvbSAnLi4vLi4vb3Bjb2Rlcyc7XG5pbXBvcnQgeyBQcmltaXRpdmVSZWZlcmVuY2UgfSBmcm9tICcuLi8uLi9yZWZlcmVuY2VzJztcbmltcG9ydCB7IFVwZGF0aW5nVk0gfSBmcm9tICcuLi8uLi92bSc7XG5pbXBvcnQgeyBWTUFyZ3VtZW50c0ltcGwgfSBmcm9tICcuLi8uLi92bS9hcmd1bWVudHMnO1xuaW1wb3J0IHsgQ2hlY2tSZWZlcmVuY2UsIENoZWNrU2NvcGUgfSBmcm9tICcuLy1kZWJ1Zy1zdHJpcCc7XG5pbXBvcnQgeyBDT05TVEFOVFMgfSBmcm9tICcuLi8uLi9zeW1ib2xzJztcbmltcG9ydCB7IEludGVybmFsSml0Vk0gfSBmcm9tICcuLi8uLi92bS9hcHBlbmQnO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQ2hpbGRTY29wZSwgdm0gPT4gdm0ucHVzaENoaWxkU2NvcGUoKSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5Qb3BTY29wZSwgdm0gPT4gdm0ucG9wU2NvcGUoKSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5QdXNoRHluYW1pY1Njb3BlLCB2bSA9PiB2bS5wdXNoRHluYW1pY1Njb3BlKCkpO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUG9wRHluYW1pY1Njb3BlLCB2bSA9PiB2bS5wb3BEeW5hbWljU2NvcGUoKSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5Db25zdGFudCwgKHZtLCB7IG9wMTogb3RoZXIgfSkgPT4ge1xuICB2bS5zdGFjay5wdXNoKHZtW0NPTlNUQU5UU10uZ2V0T3RoZXIob3RoZXIpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUHJpbWl0aXZlLCAodm0sIHsgb3AxOiBwcmltaXRpdmUgfSkgPT4ge1xuICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgbGV0IGZsYWcgPSBwcmltaXRpdmUgJiA3OyAvLyAxMTFcbiAgbGV0IHZhbHVlID0gcHJpbWl0aXZlID4+IDM7XG5cbiAgc3dpdGNoIChmbGFnKSB7XG4gICAgY2FzZSBQcmltaXRpdmVUeXBlLk5VTUJFUjpcbiAgICAgIHN0YWNrLnB1c2godmFsdWUpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBQcmltaXRpdmVUeXBlLkZMT0FUOlxuICAgICAgc3RhY2sucHVzaCh2bVtDT05TVEFOVFNdLmdldE51bWJlcih2YWx1ZSkpO1xuICAgICAgYnJlYWs7XG4gICAgY2FzZSBQcmltaXRpdmVUeXBlLlNUUklORzpcbiAgICAgIHN0YWNrLnB1c2godm1bQ09OU1RBTlRTXS5nZXRTdHJpbmcodmFsdWUpKTtcbiAgICAgIGJyZWFrO1xuICAgIGNhc2UgUHJpbWl0aXZlVHlwZS5CT09MRUFOX09SX1ZPSUQ6XG4gICAgICBzdGFjay5wdXNoUmF3KHByaW1pdGl2ZSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIFByaW1pdGl2ZVR5cGUuTkVHQVRJVkU6XG4gICAgICBzdGFjay5wdXNoKHZtW0NPTlNUQU5UU10uZ2V0TnVtYmVyKHZhbHVlKSk7XG4gICAgICBicmVhaztcbiAgICBjYXNlIFByaW1pdGl2ZVR5cGUuQklHX05VTTpcbiAgICAgIHN0YWNrLnB1c2godm1bQ09OU1RBTlRTXS5nZXROdW1iZXIodmFsdWUpKTtcbiAgICAgIGJyZWFrO1xuICB9XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlByaW1pdGl2ZVJlZmVyZW5jZSwgdm0gPT4ge1xuICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgc3RhY2sucHVzaChQcmltaXRpdmVSZWZlcmVuY2UuY3JlYXRlKGNoZWNrKHN0YWNrLnBvcCgpLCBDaGVja1ByaW1pdGl2ZSkpKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUmVpZnlVMzIsIHZtID0+IHtcbiAgbGV0IHN0YWNrID0gdm0uc3RhY2s7XG4gIHN0YWNrLnB1c2goY2hlY2soc3RhY2sucGVlaygpLCBDaGVja1JlZmVyZW5jZSkudmFsdWUoKSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkR1cCwgKHZtLCB7IG9wMTogcmVnaXN0ZXIsIG9wMjogb2Zmc2V0IH0pID0+IHtcbiAgbGV0IHBvc2l0aW9uID0gY2hlY2sodm0uZmV0Y2hWYWx1ZShyZWdpc3RlciksIENoZWNrTnVtYmVyKSAtIG9mZnNldDtcbiAgdm0uc3RhY2suZHVwKHBvc2l0aW9uKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuUG9wLCAodm0sIHsgb3AxOiBjb3VudCB9KSA9PiB7XG4gIHZtLnN0YWNrLnBvcChjb3VudCk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkxvYWQsICh2bSwgeyBvcDE6IHJlZ2lzdGVyIH0pID0+IHtcbiAgdm0ubG9hZChyZWdpc3Rlcik7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkZldGNoLCAodm0sIHsgb3AxOiByZWdpc3RlciB9KSA9PiB7XG4gIHZtLmZldGNoKHJlZ2lzdGVyKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuQmluZER5bmFtaWNTY29wZSwgKHZtLCB7IG9wMTogX25hbWVzIH0pID0+IHtcbiAgbGV0IG5hbWVzID0gdm1bQ09OU1RBTlRTXS5nZXRBcnJheShfbmFtZXMpO1xuICB2bS5iaW5kRHluYW1pY1Njb3BlKG5hbWVzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuRW50ZXIsICh2bSwgeyBvcDE6IGFyZ3MgfSkgPT4ge1xuICB2bS5lbnRlcihhcmdzKTtcbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuRXhpdCwgdm0gPT4ge1xuICB2bS5leGl0KCk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlB1c2hTeW1ib2xUYWJsZSwgKHZtLCB7IG9wMTogX3RhYmxlIH0pID0+IHtcbiAgbGV0IHN0YWNrID0gdm0uc3RhY2s7XG4gIHN0YWNrLnB1c2godm1bQ09OU1RBTlRTXS5nZXRUZW1wbGF0ZU1ldGEoX3RhYmxlKSk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLlB1c2hCbG9ja1Njb3BlLCB2bSA9PiB7XG4gIGxldCBzdGFjayA9IHZtLnN0YWNrO1xuICBzdGFjay5wdXNoKHZtLnNjb3BlKCkpO1xufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChcbiAgT3AuQ29tcGlsZUJsb2NrLFxuICAodm06IEludGVybmFsSml0Vk0pID0+IHtcbiAgICBsZXQgc3RhY2sgPSB2bS5zdGFjaztcbiAgICBsZXQgYmxvY2sgPSBzdGFjay5wb3A8T3B0aW9uPENvbXBpbGFibGVUZW1wbGF0ZT4gfCAwPigpO1xuXG4gICAgaWYgKGJsb2NrKSB7XG4gICAgICBzdGFjay5wdXNoKHZtLmNvbXBpbGUoYmxvY2spKTtcbiAgICB9IGVsc2Uge1xuICAgICAgc3RhY2sucHVzaChudWxsKTtcbiAgICB9XG5cbiAgICBjaGVjayh2bS5zdGFjay5wZWVrKCksIENoZWNrT3B0aW9uKENoZWNrTnVtYmVyKSk7XG4gIH0sXG4gICdqaXQnXG4pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuSW52b2tlWWllbGQsIHZtID0+IHtcbiAgbGV0IHsgc3RhY2sgfSA9IHZtO1xuXG4gIGxldCBoYW5kbGUgPSBjaGVjayhzdGFjay5wb3AoKSwgQ2hlY2tPcHRpb24oQ2hlY2tIYW5kbGUpKTtcbiAgbGV0IHNjb3BlID0gY2hlY2soc3RhY2sucG9wKCksIENoZWNrT3B0aW9uKENoZWNrU2NvcGUpKTtcbiAgbGV0IHRhYmxlID0gY2hlY2soc3RhY2sucG9wKCksIENoZWNrT3B0aW9uKENoZWNrQmxvY2tTeW1ib2xUYWJsZSkpO1xuXG4gIGFzc2VydChcbiAgICB0YWJsZSA9PT0gbnVsbCB8fCAodGFibGUgJiYgdHlwZW9mIHRhYmxlID09PSAnb2JqZWN0JyAmJiBBcnJheS5pc0FycmF5KHRhYmxlLnBhcmFtZXRlcnMpKSxcbiAgICBzdGFja0Fzc2VydCgnT3B0aW9uPEJsb2NrU3ltYm9sVGFibGU+JywgdGFibGUpXG4gICk7XG5cbiAgbGV0IGFyZ3MgPSBjaGVjayhzdGFjay5wb3AoKSwgQ2hlY2tJbnN0YW5jZW9mKFZNQXJndW1lbnRzSW1wbCkpO1xuXG4gIGlmICh0YWJsZSA9PT0gbnVsbCkge1xuICAgIC8vIFRvIGJhbGFuY2UgdGhlIHBvcHtGcmFtZSxTY29wZX1cbiAgICB2bS5wdXNoRnJhbWUoKTtcbiAgICB2bS5wdXNoU2NvcGUoc2NvcGUhKTsgLy8gQ291bGQgYmUgbnVsbCBidXQgaXQgZG9lc250IG1hdHRlciBhcyBpdCBpcyBpbW1lZGlhdGVsbHkgcG9wcGVkLlxuICAgIHJldHVybjtcbiAgfVxuXG4gIGxldCBpbnZva2luZ1Njb3BlID0gc2NvcGUhO1xuXG4gIC8vIElmIG5lY2Vzc2FyeSwgY3JlYXRlIGEgY2hpbGQgc2NvcGVcbiAge1xuICAgIGxldCBsb2NhbHMgPSB0YWJsZS5wYXJhbWV0ZXJzO1xuICAgIGxldCBsb2NhbHNDb3VudCA9IGxvY2Fscy5sZW5ndGg7XG5cbiAgICBpZiAobG9jYWxzQ291bnQgPiAwKSB7XG4gICAgICBpbnZva2luZ1Njb3BlID0gaW52b2tpbmdTY29wZS5jaGlsZCgpO1xuXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IGxvY2Fsc0NvdW50OyBpKyspIHtcbiAgICAgICAgaW52b2tpbmdTY29wZS5iaW5kU3ltYm9sKGxvY2FscyFbaV0sIGFyZ3MuYXQoaSkpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHZtLnB1c2hGcmFtZSgpO1xuICB2bS5wdXNoU2NvcGUoaW52b2tpbmdTY29wZSk7XG4gIHZtLmNhbGwoaGFuZGxlISk7XG59KTtcblxuQVBQRU5EX09QQ09ERVMuYWRkKE9wLkp1bXBJZiwgKHZtLCB7IG9wMTogdGFyZ2V0IH0pID0+IHtcbiAgbGV0IHJlZmVyZW5jZSA9IGNoZWNrKHZtLnN0YWNrLnBvcCgpLCBDaGVja1JlZmVyZW5jZSk7XG5cbiAgaWYgKGlzQ29uc3QocmVmZXJlbmNlKSkge1xuICAgIGlmIChyZWZlcmVuY2UudmFsdWUoKSkge1xuICAgICAgdm0uZ290byh0YXJnZXQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsZXQgY2FjaGUgPSBuZXcgUmVmZXJlbmNlQ2FjaGUocmVmZXJlbmNlKTtcblxuICAgIGlmIChjYWNoZS5wZWVrKCkpIHtcbiAgICAgIHZtLmdvdG8odGFyZ2V0KTtcbiAgICB9XG5cbiAgICB2bS51cGRhdGVXaXRoKG5ldyBBc3NlcnQoY2FjaGUpKTtcbiAgfVxufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5KdW1wVW5sZXNzLCAodm0sIHsgb3AxOiB0YXJnZXQgfSkgPT4ge1xuICBsZXQgcmVmZXJlbmNlID0gY2hlY2sodm0uc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBpZiAoaXNDb25zdChyZWZlcmVuY2UpKSB7XG4gICAgaWYgKCFyZWZlcmVuY2UudmFsdWUoKSkge1xuICAgICAgdm0uZ290byh0YXJnZXQpO1xuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBsZXQgY2FjaGUgPSBuZXcgUmVmZXJlbmNlQ2FjaGUocmVmZXJlbmNlKTtcblxuICAgIGlmICghY2FjaGUucGVlaygpKSB7XG4gICAgICB2bS5nb3RvKHRhcmdldCk7XG4gICAgfVxuXG4gICAgdm0udXBkYXRlV2l0aChuZXcgQXNzZXJ0KGNhY2hlKSk7XG4gIH1cbn0pO1xuXG5BUFBFTkRfT1BDT0RFUy5hZGQoT3AuSnVtcEVxLCAodm0sIHsgb3AxOiB0YXJnZXQsIG9wMjogY29tcGFyaXNvbiB9KSA9PiB7XG4gIGxldCBvdGhlciA9IGNoZWNrKHZtLnN0YWNrLnBlZWsoKSwgQ2hlY2tOdW1iZXIpO1xuXG4gIGlmIChvdGhlciA9PT0gY29tcGFyaXNvbikge1xuICAgIHZtLmdvdG8odGFyZ2V0KTtcbiAgfVxufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5Bc3NlcnRTYW1lLCB2bSA9PiB7XG4gIGxldCByZWZlcmVuY2UgPSBjaGVjayh2bS5zdGFjay5wZWVrKCksIENoZWNrUmVmZXJlbmNlKTtcblxuICBpZiAoIWlzQ29uc3QocmVmZXJlbmNlKSkge1xuICAgIHZtLnVwZGF0ZVdpdGgoQXNzZXJ0LmluaXRpYWxpemUobmV3IFJlZmVyZW5jZUNhY2hlKHJlZmVyZW5jZSkpKTtcbiAgfVxufSk7XG5cbkFQUEVORF9PUENPREVTLmFkZChPcC5Ub0Jvb2xlYW4sIHZtID0+IHtcbiAgbGV0IHsgZW52LCBzdGFjayB9ID0gdm07XG4gIHN0YWNrLnB1c2goZW52LnRvQ29uZGl0aW9uYWxSZWZlcmVuY2UoY2hlY2soc3RhY2sucG9wKCksIENoZWNrUmVmZXJlbmNlKSkpO1xufSk7XG5cbmV4cG9ydCBjbGFzcyBBc3NlcnQgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHN0YXRpYyBpbml0aWFsaXplKGNhY2hlOiBSZWZlcmVuY2VDYWNoZTx1bmtub3duPik6IEFzc2VydCB7XG4gICAgbGV0IGFzc2VydCA9IG5ldyBBc3NlcnQoY2FjaGUpO1xuICAgIGNhY2hlLnBlZWsoKTtcbiAgICByZXR1cm4gYXNzZXJ0O1xuICB9XG5cbiAgcHVibGljIHR5cGUgPSAnYXNzZXJ0JztcblxuICBwdWJsaWMgdGFnOiBUYWc7XG5cbiAgcHJpdmF0ZSBjYWNoZTogUmVmZXJlbmNlQ2FjaGU8dW5rbm93bj47XG5cbiAgY29uc3RydWN0b3IoY2FjaGU6IFJlZmVyZW5jZUNhY2hlPHVua25vd24+KSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRhZyA9IGNhY2hlLnRhZztcbiAgICB0aGlzLmNhY2hlID0gY2FjaGU7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIGxldCB7IGNhY2hlIH0gPSB0aGlzO1xuXG4gICAgaWYgKGlzTW9kaWZpZWQoY2FjaGUucmV2YWxpZGF0ZSgpKSkge1xuICAgICAgdm0udGhyb3coKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEp1bXBJZk5vdE1vZGlmaWVkT3Bjb2RlIGV4dGVuZHMgVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdHlwZSA9ICdqdW1wLWlmLW5vdC1tb2RpZmllZCc7XG5cbiAgcHVibGljIHRhZzogVGFnO1xuXG4gIHByaXZhdGUgbGFzdFJldmlzaW9uOiBSZXZpc2lvbjtcblxuICBjb25zdHJ1Y3Rvcih0YWc6IFRhZywgcHJpdmF0ZSB0YXJnZXQ6IExhYmVsT3Bjb2RlKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLnRhZyA9IHRhZztcbiAgICB0aGlzLmxhc3RSZXZpc2lvbiA9IHZhbHVlKHRhZyk7XG4gIH1cblxuICBldmFsdWF0ZSh2bTogVXBkYXRpbmdWTSkge1xuICAgIGxldCB7IHRhZywgdGFyZ2V0LCBsYXN0UmV2aXNpb24gfSA9IHRoaXM7XG5cbiAgICBpZiAoIXZtLmFsd2F5c1JldmFsaWRhdGUgJiYgdmFsaWRhdGUodGFnLCBsYXN0UmV2aXNpb24pKSB7XG4gICAgICB2bS5nb3RvKHRhcmdldCk7XG4gICAgfVxuICB9XG5cbiAgZGlkTW9kaWZ5KCkge1xuICAgIHRoaXMubGFzdFJldmlzaW9uID0gdmFsdWUodGhpcy50YWcpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBEaWRNb2RpZnlPcGNvZGUgZXh0ZW5kcyBVcGRhdGluZ09wY29kZSB7XG4gIHB1YmxpYyB0eXBlID0gJ2RpZC1tb2RpZnknO1xuXG4gIHB1YmxpYyB0YWc6IFRhZztcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHRhcmdldDogSnVtcElmTm90TW9kaWZpZWRPcGNvZGUpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMudGFnID0gQ09OU1RBTlRfVEFHO1xuICB9XG5cbiAgZXZhbHVhdGUoKSB7XG4gICAgdGhpcy50YXJnZXQuZGlkTW9kaWZ5KCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIExhYmVsT3Bjb2RlIGltcGxlbWVudHMgVXBkYXRpbmdPcGNvZGUge1xuICBwdWJsaWMgdGFnOiBUYWcgPSBDT05TVEFOVF9UQUc7XG4gIHB1YmxpYyB0eXBlID0gJ2xhYmVsJztcbiAgcHVibGljIGxhYmVsOiBPcHRpb248c3RyaW5nPiA9IG51bGw7XG4gIHB1YmxpYyBfZ3VpZCE6IG51bWJlcjsgLy8gU2V0IGJ5IGluaXRpYWxpemVHdWlkKCkgaW4gdGhlIGNvbnN0cnVjdG9yXG5cbiAgcHJldjogYW55ID0gbnVsbDtcbiAgbmV4dDogYW55ID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcihsYWJlbDogc3RyaW5nKSB7XG4gICAgaW5pdGlhbGl6ZUd1aWQodGhpcyk7XG4gICAgdGhpcy5sYWJlbCA9IGxhYmVsO1xuICB9XG5cbiAgZXZhbHVhdGUoKSB7fVxuXG4gIGluc3BlY3QoKTogc3RyaW5nIHtcbiAgICByZXR1cm4gYCR7dGhpcy5sYWJlbH0gWyR7dGhpcy5fZ3VpZH1dYDtcbiAgfVxufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==