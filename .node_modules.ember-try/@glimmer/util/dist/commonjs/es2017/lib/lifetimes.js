'use strict';

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.ListContentsDestructor = exports.DESTRUCTORS = exports.CHILDREN = exports.DROP = exports.LINKED = undefined;
exports.isDrop = isDrop;
exports.associate = associate;
exports.associateDestructor = associateDestructor;
exports.takeAssociated = takeAssociated;
exports.destroyAssociated = destroyAssociated;
exports.destructor = destructor;
exports.snapshot = snapshot;
exports.debugDropTree = debugDropTree;
exports.printDropTree = printDropTree;
exports.printDrop = printDrop;

var _destroy = require('./destroy');

const LINKED = exports.LINKED = new WeakMap();
const DROP = exports.DROP = 'DROP [94d46cf3-3974-435d-b278-3e60d1155290]';
const CHILDREN = exports.CHILDREN = 'CHILDREN [7142e52a-8600-4e01-a773-42055b96630d]';
const DESTRUCTORS = exports.DESTRUCTORS = new WeakMap();
function isDrop(value) {
    if (value === null || typeof value !== 'object') return false;
    return DROP in value;
}
function associate(parent, child) {
    associateDestructor(parent, destructor(child));
}
function associateDestructor(parent, child) {
    let associated = LINKED.get(parent);
    if (!associated) {
        associated = new Set();
        LINKED.set(parent, associated);
    }
    associated.add(child);
}
function takeAssociated(parent) {
    let linked = LINKED.get(parent);
    if (linked && linked.size > 0) {
        LINKED.delete(parent);
        return linked;
    } else {
        return null;
    }
}
function destroyAssociated(parent) {
    let associated = LINKED.get(parent);
    if (associated) {
        associated.forEach(item => {
            item[DROP]();
            associated.delete(item);
        });
    }
}
function destructor(value) {
    let d = DESTRUCTORS.get(value);
    if (!d) {
        if ((0, _destroy.isDestroyable)(value)) {
            d = new DestroyableDestructor(value);
        } else if ((0, _destroy.isStringDestroyable)(value)) {
            d = new StringDestroyableDestructor(value);
        } else {
            d = new SimpleDestructor(value);
        }
        DESTRUCTORS.set(value, d);
    }
    return d;
}
function snapshot(values) {
    return new SnapshotDestructor(values);
}
class SnapshotDestructor {
    constructor(destructors) {
        this.destructors = destructors;
    }
    [DROP]() {
        this.destructors.forEach(item => item[DROP]());
    }
    get [CHILDREN]() {
        return this.destructors;
    }
    toString() {
        return 'SnapshotDestructor';
    }
}
class DestroyableDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [DROP]() {
        this.inner[_destroy.DESTROY]();
        destroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'DestroyableDestructor';
    }
}
class StringDestroyableDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [DROP]() {
        this.inner.destroy();
        destroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'StringDestroyableDestructor';
    }
}
class SimpleDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [DROP]() {
        destroyAssociated(this.inner);
    }
    get [CHILDREN]() {
        return LINKED.get(this.inner) || [];
    }
    toString() {
        return 'SimpleDestructor';
    }
}
class ListContentsDestructor {
    constructor(inner) {
        this.inner = inner;
    }
    [DROP]() {
        this.inner.forEachNode(d => destructor(d)[DROP]());
    }
    get [CHILDREN]() {
        let out = [];
        this.inner.forEachNode(d => out.push(...destructor(d)[CHILDREN]));
        return out;
    }
    toString() {
        return 'ListContentsDestructor';
    }
}
exports.ListContentsDestructor = ListContentsDestructor;
function debugDropTree(inner) {
    let hasDrop = isDrop(inner);
    let rawChildren = LINKED.get(inner) || null;
    let children = null;
    if (rawChildren) {
        children = [];
        for (let child of rawChildren) {
            children.push(debugDropTree(child));
        }
    }
    let obj = Object.create(null);
    obj.inner = inner;
    if (children) {
        obj.children = children;
    }
    obj.hasDrop = hasDrop;
    return obj;
}
function printDropTree(inner) {
    printDrop(destructor(inner));
}
function printDrop(inner) {
    console.group(String(inner));
    console.log(inner);
    let children = inner[CHILDREN] || null;
    if (children) {
        for (let child of children) {
            printDrop(child);
        }
    }
    console.groupEnd();
}
if (false && typeof window !== 'undefined') {
    window.PRINT_DROP = printDropTree;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3V0aWwvbGliL2xpZmV0aW1lcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7Ozs7UUFpQk0sTSxHQUFBLE07UUFLQSxTLEdBQUEsUztRQUlBLG1CLEdBQUEsbUI7UUFXQSxjLEdBQUEsYztRQVdBLGlCLEdBQUEsaUI7UUFXQSxVLEdBQUEsVTtRQWtCQSxRLEdBQUEsUTtRQThGQSxhLEdBQUEsYTtRQXFCQSxhLEdBQUEsYTtRQUlBLFMsR0FBQSxTOzs7O0FBeExDLE1BQU0sMEJBQXFDLElBQTNDLE9BQTJDLEVBQTNDO0FBQ0EsTUFBTSxzQkFBTiw2Q0FBQTtBQUNBLE1BQU0sOEJBQU4saURBQUE7QUFDQSxNQUFNLG9DQUFjLElBQXBCLE9BQW9CLEVBQXBCO0FBRUQsU0FBQSxNQUFBLENBQUEsS0FBQSxFQUErQjtBQUNuQyxRQUFJLFVBQUEsSUFBQSxJQUFrQixPQUFBLEtBQUEsS0FBdEIsUUFBQSxFQUFpRCxPQUFBLEtBQUE7QUFDakQsV0FBTyxRQUFQLEtBQUE7QUFDRDtBQUVLLFNBQUEsU0FBQSxDQUFBLE1BQUEsRUFBQSxLQUFBLEVBQWlEO0FBQ3JELHdCQUFBLE1BQUEsRUFBNEIsV0FBNUIsS0FBNEIsQ0FBNUI7QUFDRDtBQUVLLFNBQUEsbUJBQUEsQ0FBQSxNQUFBLEVBQUEsS0FBQSxFQUF5RDtBQUM3RCxRQUFJLGFBQWEsT0FBQSxHQUFBLENBQWpCLE1BQWlCLENBQWpCO0FBRUEsUUFBSSxDQUFKLFVBQUEsRUFBaUI7QUFDZixxQkFBYSxJQUFiLEdBQWEsRUFBYjtBQUNBLGVBQUEsR0FBQSxDQUFBLE1BQUEsRUFBQSxVQUFBO0FBQ0Q7QUFFRCxlQUFBLEdBQUEsQ0FBQSxLQUFBO0FBQ0Q7QUFFSyxTQUFBLGNBQUEsQ0FBQSxNQUFBLEVBQXVDO0FBQzNDLFFBQUksU0FBUyxPQUFBLEdBQUEsQ0FBYixNQUFhLENBQWI7QUFFQSxRQUFJLFVBQVUsT0FBQSxJQUFBLEdBQWQsQ0FBQSxFQUEr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SyxJQUFMLEtBQUEsSUFBQSxRQUFBLEVBQTRCO0FBQzFCLHNCQUFBLEtBQUE7QUFDRDtBQUNGO0FBRUQsWUFBQSxRQUFBO0FBQ0Q7QUFFRCxJQUFJLFNBQVcsT0FBQSxNQUFBLEtBQWYsV0FBQSxFQUE4QztBQUMzQyxXQUFBLFVBQUEsR0FBQSxhQUFBO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBpc0Rlc3Ryb3lhYmxlLCBpc1N0cmluZ0Rlc3Ryb3lhYmxlLCBERVNUUk9ZIH0gZnJvbSAnLi9kZXN0cm95JztcbmltcG9ydCB7XG4gIE9wdGlvbixcbiAgU3ltYm9sRGVzdHJveWFibGUsXG4gIERlc3Ryb3lhYmxlLFxuICBEcm9wLFxuICBEcm9wU3ltYm9sLFxuICBDaGlsZHJlblN5bWJvbCxcbn0gZnJvbSAnQGdsaW1tZXIvaW50ZXJmYWNlcyc7XG5pbXBvcnQgeyBMaW5rZWRMaXN0LCBMaW5rZWRMaXN0Tm9kZSB9IGZyb20gJy4vbGlzdC11dGlscyc7XG5pbXBvcnQgeyBERVZNT0RFIH0gZnJvbSAnQGdsaW1tZXIvbG9jYWwtZGVidWctZmxhZ3MnO1xuXG5leHBvcnQgY29uc3QgTElOS0VEOiBXZWFrTWFwPG9iamVjdCwgU2V0PERyb3A+PiA9IG5ldyBXZWFrTWFwKCk7XG5leHBvcnQgY29uc3QgRFJPUDogRHJvcFN5bWJvbCA9ICdEUk9QIFs5NGQ0NmNmMy0zOTc0LTQzNWQtYjI3OC0zZTYwZDExNTUyOTBdJztcbmV4cG9ydCBjb25zdCBDSElMRFJFTjogQ2hpbGRyZW5TeW1ib2wgPSAnQ0hJTERSRU4gWzcxNDJlNTJhLTg2MDAtNGUwMS1hNzczLTQyMDU1Yjk2NjMwZF0nO1xuZXhwb3J0IGNvbnN0IERFU1RSVUNUT1JTID0gbmV3IFdlYWtNYXAoKTtcblxuZXhwb3J0IGZ1bmN0aW9uIGlzRHJvcCh2YWx1ZTogdW5rbm93bik6IHZhbHVlIGlzIERyb3Age1xuICBpZiAodmFsdWUgPT09IG51bGwgfHwgdHlwZW9mIHZhbHVlICE9PSAnb2JqZWN0JykgcmV0dXJuIGZhbHNlO1xuICByZXR1cm4gRFJPUCBpbiAodmFsdWUgYXMgb2JqZWN0KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFzc29jaWF0ZShwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IG9iamVjdCkge1xuICBhc3NvY2lhdGVEZXN0cnVjdG9yKHBhcmVudCwgZGVzdHJ1Y3RvcihjaGlsZCkpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYXNzb2NpYXRlRGVzdHJ1Y3RvcihwYXJlbnQ6IG9iamVjdCwgY2hpbGQ6IERyb3ApOiB2b2lkIHtcbiAgbGV0IGFzc29jaWF0ZWQgPSBMSU5LRUQuZ2V0KHBhcmVudCk7XG5cbiAgaWYgKCFhc3NvY2lhdGVkKSB7XG4gICAgYXNzb2NpYXRlZCA9IG5ldyBTZXQoKTtcbiAgICBMSU5LRUQuc2V0KHBhcmVudCwgYXNzb2NpYXRlZCk7XG4gIH1cblxuICBhc3NvY2lhdGVkLmFkZChjaGlsZCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB0YWtlQXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCk6IE9wdGlvbjxTZXQ8RHJvcD4+IHtcbiAgbGV0IGxpbmtlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAobGlua2VkICYmIGxpbmtlZC5zaXplID4gMCkge1xuICAgIExJTktFRC5kZWxldGUocGFyZW50KTtcbiAgICByZXR1cm4gbGlua2VkO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBudWxsO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBkZXN0cm95QXNzb2NpYXRlZChwYXJlbnQ6IG9iamVjdCkge1xuICBsZXQgYXNzb2NpYXRlZCA9IExJTktFRC5nZXQocGFyZW50KTtcblxuICBpZiAoYXNzb2NpYXRlZCkge1xuICAgIGFzc29jaWF0ZWQuZm9yRWFjaChpdGVtID0+IHtcbiAgICAgIGl0ZW1bRFJPUF0oKTtcbiAgICAgIGFzc29jaWF0ZWQhLmRlbGV0ZShpdGVtKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gZGVzdHJ1Y3Rvcih2YWx1ZTogb2JqZWN0KTogRHJvcCB7XG4gIGxldCBkID0gREVTVFJVQ1RPUlMuZ2V0KHZhbHVlKTtcblxuICBpZiAoIWQpIHtcbiAgICBpZiAoaXNEZXN0cm95YWJsZSh2YWx1ZSkpIHtcbiAgICAgIGQgPSBuZXcgRGVzdHJveWFibGVEZXN0cnVjdG9yKHZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKGlzU3RyaW5nRGVzdHJveWFibGUodmFsdWUpKSB7XG4gICAgICBkID0gbmV3IFN0cmluZ0Rlc3Ryb3lhYmxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGQgPSBuZXcgU2ltcGxlRGVzdHJ1Y3Rvcih2YWx1ZSk7XG4gICAgfVxuXG4gICAgREVTVFJVQ1RPUlMuc2V0KHZhbHVlLCBkKTtcbiAgfVxuXG4gIHJldHVybiBkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc25hcHNob3QodmFsdWVzOiBTZXQ8RHJvcD4pOiBEcm9wIHtcbiAgcmV0dXJuIG5ldyBTbmFwc2hvdERlc3RydWN0b3IodmFsdWVzKTtcbn1cblxuY2xhc3MgU25hcHNob3REZXN0cnVjdG9yIGltcGxlbWVudHMgRHJvcCB7XG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgZGVzdHJ1Y3RvcnM6IFNldDxEcm9wPikge31cblxuICBbRFJPUF0oKSB7XG4gICAgdGhpcy5kZXN0cnVjdG9ycy5mb3JFYWNoKGl0ZW0gPT4gaXRlbVtEUk9QXSgpKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gdGhpcy5kZXN0cnVjdG9ycztcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU25hcHNob3REZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogU3ltYm9sRGVzdHJveWFibGUpIHt9XG5cbiAgW0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXJbREVTVFJPWV0oKTtcbiAgICBkZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnRGVzdHJveWFibGVEZXN0cnVjdG9yJztcbiAgfVxufVxuXG5jbGFzcyBTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogRGVzdHJveWFibGUpIHt9XG5cbiAgW0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZGVzdHJveSgpO1xuICAgIGRlc3Ryb3lBc3NvY2lhdGVkKHRoaXMuaW5uZXIpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIHJldHVybiBMSU5LRUQuZ2V0KHRoaXMuaW5uZXIpIHx8IFtdO1xuICB9XG5cbiAgdG9TdHJpbmcoKSB7XG4gICAgcmV0dXJuICdTdHJpbmdEZXN0cm95YWJsZURlc3RydWN0b3InO1xuICB9XG59XG5cbmNsYXNzIFNpbXBsZURlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogb2JqZWN0KSB7fVxuXG4gIFtEUk9QXSgpIHtcbiAgICBkZXN0cm95QXNzb2NpYXRlZCh0aGlzLmlubmVyKTtcbiAgfVxuXG4gIGdldCBbQ0hJTERSRU5dKCk6IEl0ZXJhYmxlPERyb3A+IHtcbiAgICByZXR1cm4gTElOS0VELmdldCh0aGlzLmlubmVyKSB8fCBbXTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiAnU2ltcGxlRGVzdHJ1Y3Rvcic7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIExpc3RDb250ZW50c0Rlc3RydWN0b3IgaW1wbGVtZW50cyBEcm9wIHtcbiAgY29uc3RydWN0b3IocHJpdmF0ZSBpbm5lcjogTGlua2VkTGlzdDxMaW5rZWRMaXN0Tm9kZT4pIHt9XG5cbiAgW0RST1BdKCkge1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBkZXN0cnVjdG9yKGQpW0RST1BdKCkpO1xuICB9XG5cbiAgZ2V0IFtDSElMRFJFTl0oKTogSXRlcmFibGU8RHJvcD4ge1xuICAgIGxldCBvdXQ6IERyb3BbXSA9IFtdO1xuICAgIHRoaXMuaW5uZXIuZm9yRWFjaE5vZGUoZCA9PiBvdXQucHVzaCguLi5kZXN0cnVjdG9yKGQpW0NISUxEUkVOXSkpO1xuICAgIHJldHVybiBvdXQ7XG4gIH1cblxuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gJ0xpc3RDb250ZW50c0Rlc3RydWN0b3InO1xuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRGVidWdOb2RlIHtcbiAgaW5uZXI6IG9iamVjdDtcbiAgY2hpbGRyZW46IERlYnVnTm9kZVtdIHwgbnVsbDtcbiAgaGFzRHJvcDogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGRlYnVnRHJvcFRyZWUoaW5uZXI6IG9iamVjdCk6IERlYnVnTm9kZSB7XG4gIGxldCBoYXNEcm9wID0gaXNEcm9wKGlubmVyKTtcbiAgbGV0IHJhd0NoaWxkcmVuID0gTElOS0VELmdldChpbm5lcikgfHwgbnVsbDtcbiAgbGV0IGNoaWxkcmVuOiBEZWJ1Z05vZGVbXSB8IG51bGwgPSBudWxsO1xuXG4gIGlmIChyYXdDaGlsZHJlbikge1xuICAgIGNoaWxkcmVuID0gW107XG4gICAgZm9yIChsZXQgY2hpbGQgb2YgcmF3Q2hpbGRyZW4pIHtcbiAgICAgIGNoaWxkcmVuLnB1c2goZGVidWdEcm9wVHJlZShjaGlsZCkpO1xuICAgIH1cbiAgfVxuXG4gIGxldCBvYmogPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuICBvYmouaW5uZXIgPSBpbm5lcjtcbiAgaWYgKGNoaWxkcmVuKSB7XG4gICAgb2JqLmNoaWxkcmVuID0gY2hpbGRyZW47XG4gIH1cbiAgb2JqLmhhc0Ryb3AgPSBoYXNEcm9wO1xuICByZXR1cm4gb2JqO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcHJpbnREcm9wVHJlZShpbm5lcjogb2JqZWN0KSB7XG4gIHByaW50RHJvcChkZXN0cnVjdG9yKGlubmVyKSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwcmludERyb3AoaW5uZXI6IERyb3ApIHtcbiAgY29uc29sZS5ncm91cChTdHJpbmcoaW5uZXIpKTtcblxuICBjb25zb2xlLmxvZyhpbm5lcik7XG5cbiAgbGV0IGNoaWxkcmVuID0gaW5uZXJbQ0hJTERSRU5dIHx8IG51bGw7XG4gIGlmIChjaGlsZHJlbikge1xuICAgIGZvciAobGV0IGNoaWxkIG9mIGNoaWxkcmVuKSB7XG4gICAgICBwcmludERyb3AoY2hpbGQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUuZ3JvdXBFbmQoKTtcbn1cblxuaWYgKERFVk1PREUgJiYgdHlwZW9mIHdpbmRvdyAhPT0gJ3VuZGVmaW5lZCcpIHtcbiAgKHdpbmRvdyBhcyBhbnkpLlBSSU5UX0RST1AgPSBwcmludERyb3BUcmVlO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==