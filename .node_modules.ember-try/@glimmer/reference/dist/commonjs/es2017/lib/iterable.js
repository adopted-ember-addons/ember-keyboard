"use strict";

Object.defineProperty(exports, "__esModule", {
    value: true
});
exports.IteratorSynchronizer = exports.END = exports.ReferenceIterator = exports.IterationArtifacts = exports.ListItem = undefined;

var _util = require("@glimmer/util");

class ListItem extends _util.ListNode {
    constructor(iterable, result) {
        super(iterable.valueReferenceFor(result));
        this.retained = false;
        this.seen = false;
        this.key = result.key;
        this.iterable = iterable;
        this.memo = iterable.memoReferenceFor(result);
    }
    update(item) {
        this.retained = true;
        this.iterable.updateValueReference(this.value, item);
        this.iterable.updateMemoReference(this.memo, item);
    }
    shouldRemove() {
        return !this.retained;
    }
    reset() {
        this.retained = false;
        this.seen = false;
    }
}
exports.ListItem = ListItem;
class IterationArtifacts {
    constructor(iterable) {
        this.iterator = null;
        this.map = new Map();
        this.list = new _util.LinkedList();
        this.tag = iterable.tag;
        this.iterable = iterable;
    }
    isEmpty() {
        let iterator = this.iterator = this.iterable.iterate();
        return iterator.isEmpty();
    }
    iterate() {
        let iterator;
        if (this.iterator === null) {
            iterator = this.iterable.iterate();
        } else {
            iterator = this.iterator;
        }
        this.iterator = null;
        return iterator;
    }
    advanceToKey(key, current) {
        let seek = current;
        while (seek !== null && seek.key !== key) {
            seek = this.advanceNode(seek);
        }
        return seek;
    }
    has(key) {
        return this.map.has(key);
    }
    get(key) {
        return this.map.get(key);
    }
    wasSeen(key) {
        let node = this.map.get(key);
        return node !== undefined && node.seen;
    }
    update(item) {
        let found = this.get(item.key);
        found.update(item);
        return found;
    }
    append(item) {
        let { map, list, iterable } = this;
        let node = new ListItem(iterable, item);
        map.set(item.key, node);
        list.append(node);
        return node;
    }
    insertBefore(item, reference) {
        let { map, list, iterable } = this;
        let node = new ListItem(iterable, item);
        map.set(item.key, node);
        node.retained = true;
        list.insertBefore(node, reference);
        return node;
    }
    move(item, reference) {
        let { list } = this;
        item.retained = true;
        list.remove(item);
        list.insertBefore(item, reference);
    }
    remove(item) {
        let { list } = this;
        list.remove(item);
        this.map.delete(item.key);
    }
    nextNode(item) {
        return this.list.nextNode(item);
    }
    advanceNode(item) {
        item.seen = true;
        return this.list.nextNode(item);
    }
    head() {
        return this.list.head();
    }
}
exports.IterationArtifacts = IterationArtifacts;
class ReferenceIterator {
    // if anyone needs to construct this object with something other than
    // an iterable, let @wycats know.
    constructor(iterable) {
        this.iterator = null;
        let artifacts = new IterationArtifacts(iterable);
        this.artifacts = artifacts;
    }
    next() {
        let { artifacts } = this;
        let iterator = this.iterator = this.iterator || artifacts.iterate();
        let item = iterator.next();
        if (item === null) return null;
        return artifacts.append(item);
    }
}
exports.ReferenceIterator = ReferenceIterator;
var Phase;
(function (Phase) {
    Phase[Phase["Append"] = 0] = "Append";
    Phase[Phase["Prune"] = 1] = "Prune";
    Phase[Phase["Done"] = 2] = "Done";
})(Phase || (Phase = {}));
const END = exports.END = 'END [2600abdf-889f-4406-b059-b44ecbafa5c5]';
class IteratorSynchronizer {
    constructor({ target, artifacts, env }) {
        this.target = target;
        this.artifacts = artifacts;
        this.iterator = artifacts.iterate();
        this.current = artifacts.head();
        this.env = env;
    }
    sync() {
        let phase = Phase.Append;
        while (true) {
            switch (phase) {
                case Phase.Append:
                    phase = this.nextAppend();
                    break;
                case Phase.Prune:
                    phase = this.nextPrune();
                    break;
                case Phase.Done:
                    this.nextDone();
                    return;
            }
        }
    }
    advanceToKey(key) {
        let { current, artifacts } = this;
        if (current === null) return;
        let next = artifacts.advanceNode(current);
        if (next.key === key) {
            this.current = artifacts.advanceNode(next);
            return;
        }
        let seek = artifacts.advanceToKey(key, current);
        if (seek) {
            this.move(seek, current);
            this.current = artifacts.nextNode(current);
        }
    }
    move(item, reference) {
        if (item.next !== reference) {
            this.artifacts.move(item, reference);
            this.target.move(this.env, item.key, item.value, item.memo, reference ? reference.key : END);
        }
    }
    nextAppend() {
        let { iterator, current, artifacts } = this;
        let item = iterator.next();
        if (item === null) {
            return this.startPrune();
        }
        let { key } = item;
        if (current !== null && current.key === key) {
            this.nextRetain(item, current);
        } else if (artifacts.has(key)) {
            this.nextMove(item);
        } else {
            this.nextInsert(item);
        }
        return Phase.Append;
    }
    nextRetain(item, current) {
        let { artifacts } = this;
        // current = expect(current, 'BUG: current is empty');
        current.update(item);
        this.current = artifacts.nextNode(current);
        this.target.retain(this.env, item.key, current.value, current.memo);
    }
    nextMove(item) {
        let { current, artifacts } = this;
        let { key } = item;
        let found = artifacts.update(item);
        if (artifacts.wasSeen(key)) {
            this.move(found, current);
        } else {
            this.advanceToKey(key);
        }
    }
    nextInsert(item) {
        let { artifacts, target, current } = this;
        let node = artifacts.insertBefore(item, current);
        target.insert(this.env, node.key, node.value, node.memo, current ? current.key : null);
    }
    startPrune() {
        this.current = this.artifacts.head();
        return Phase.Prune;
    }
    nextPrune() {
        let { artifacts, target, current } = this;
        if (current === null) {
            return Phase.Done;
        }
        let node = current;
        this.current = artifacts.nextNode(node);
        if (node.shouldRemove()) {
            artifacts.remove(node);
            target.delete(this.env, node.key);
        } else {
            node.reset();
        }
        return Phase.Prune;
    }
    nextDone() {
        this.target.done(this.env);
    }
}
exports.IteratorSynchronizer = IteratorSynchronizer;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3JlZmVyZW5jZS9saWIvaXRlcmFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBd0RNLE1BQUEsUUFBQSxTQUFBLGNBQUEsQ0FBcUQ7QUFPekQsZ0JBQUEsUUFBQSxFQUFBLE1BQUEsRUFBaUU7QUFDL0QsY0FBTSxTQUFBLGlCQUFBLENBQU4sTUFBTSxDQUFOO0FBTEssYUFBQSxRQUFBLEdBQUEsS0FBQTtBQUNBLGFBQUEsSUFBQSxHQUFBLEtBQUE7QUFLTCxhQUFBLEdBQUEsR0FBVyxPQUFYLEdBQUE7QUFDQSxhQUFBLFFBQUEsR0FBQSxRQUFBO0FBQ0EsYUFBQSxJQUFBLEdBQVksU0FBQSxnQkFBQSxDQUFaLE1BQVksQ0FBWjtBQUNEO0FBRUQsV0FBQSxJQUFBLEVBQWdDO0FBQzlCLGFBQUEsUUFBQSxHQUFBLElBQUE7QUFDQSxhQUFBLFFBQUEsQ0FBQSxvQkFBQSxDQUFtQyxLQUFuQyxLQUFBLEVBQUEsSUFBQTtBQUNBLGFBQUEsUUFBQSxDQUFBLG1CQUFBLENBQWtDLEtBQWxDLElBQUEsRUFBQSxJQUFBO0FBQ0Q7QUFFRCxtQkFBWTtBQUNWLGVBQU8sQ0FBQyxLQUFSLFFBQUE7QUFDRDtBQUVELFlBQUs7QUFDSCxhQUFBLFFBQUEsR0FBQSxLQUFBO0FBQ0EsYUFBQSxJQUFBLEdBQUEsS0FBQTtBQUNEO0FBM0J3RDtRQUFyRCxRLEdBQUEsUTtBQThCQSxNQUFBLGtCQUFBLENBQXlCO0FBUTdCLGdCQUFBLFFBQUEsRUFBb0M7QUFKNUIsYUFBQSxRQUFBLEdBQUEsSUFBQTtBQUNBLGFBQUEsR0FBQSxHQUFNLElBQU4sR0FBTSxFQUFOO0FBQ0EsYUFBQSxJQUFBLEdBQU8sSUFBUCxnQkFBTyxFQUFQO0FBR04sYUFBQSxHQUFBLEdBQVcsU0FBWCxHQUFBO0FBQ0EsYUFBQSxRQUFBLEdBQUEsUUFBQTtBQUNEO0FBRUQsY0FBTztBQUNMLFlBQUksV0FBWSxLQUFBLFFBQUEsR0FB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QUFXLENBQVg7QUFDQSxlQUFBLE1BQUEsQ0FBYyxLQUFkLEdBQUEsRUFBd0IsS0FBeEIsR0FBQSxFQUFrQyxLQUFsQyxLQUFBLEVBQThDLEtBQTlDLElBQUEsRUFBeUQsVUFBVSxRQUFWLEdBQUEsR0FBekQsSUFBQTtBQUNEO0FBRU8saUJBQVU7QUFDaEIsYUFBQSxPQUFBLEdBQWUsS0FBQSxTQUFBLENBQWYsSUFBZSxFQUFmO0FBQ0EsZUFBTyxNQUFQLEtBQUE7QUFDRDtBQUVPLGdCQUFTO0FBQ2YsWUFBSSxFQUFBLFNBQUEsRUFBQSxNQUFBLEVBQUEsT0FBQSxLQUFKLElBQUE7QUFFQSxZQUFJLFlBQUosSUFBQSxFQUFzQjtBQUNwQixtQkFBTyxNQUFQLElBQUE7QUFDRDtBQUVELFlBQUksT0FBSixPQUFBO0FBQ0EsYUFBQSxPQUFBLEdBQWUsVUFBQSxRQUFBLENBQWYsSUFBZSxDQUFmO0FBRUEsWUFBSSxLQUFKLFlBQUksRUFBSixFQUF5QjtBQUN2QixzQkFBQSxNQUFBLENBQUEsSUFBQTtBQUNBLG1CQUFBLE1BQUEsQ0FBYyxLQUFkLEdBQUEsRUFBd0IsS0FBeEIsR0FBQTtBQUZGLFNBQUEsTUFHTztBQUNMLGlCQUFBLEtBQUE7QUFDRDtBQUVELGVBQU8sTUFBUCxLQUFBO0FBQ0Q7QUFFTyxlQUFRO0FBQ2QsYUFBQSxNQUFBLENBQUEsSUFBQSxDQUFpQixLQUFqQixHQUFBO0FBQ0Q7QUEzSThCO1FBQTNCLG9CLEdBQUEsb0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBMaW5rZWRMaXN0LCBMaXN0Tm9kZSwgT3B0aW9uIH0gZnJvbSAnQGdsaW1tZXIvdXRpbCc7XG5pbXBvcnQgeyBUYWcgfSBmcm9tICcuL3ZhbGlkYXRvcnMnO1xuaW1wb3J0IHsgVmVyc2lvbmVkUGF0aFJlZmVyZW5jZSBhcyBQYXRoUmVmZXJlbmNlIH0gZnJvbSAnLi9yZWZlcmVuY2UnO1xuXG5leHBvcnQgaW50ZXJmYWNlIEl0ZXJhdGlvbkl0ZW08VCwgVT4ge1xuICBrZXk6IHVua25vd247XG4gIHZhbHVlOiBUO1xuICBtZW1vOiBVO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEFic3RyYWN0SXRlcmF0b3I8VCwgVSwgViBleHRlbmRzIEl0ZXJhdGlvbkl0ZW08VCwgVT4+IHtcbiAgaXNFbXB0eSgpOiBib29sZWFuO1xuICBuZXh0KCk6IE9wdGlvbjxWPjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBYnN0cmFjdEl0ZXJhYmxlPFxuICBULFxuICBVLFxuICBJdGVtVHlwZSBleHRlbmRzIEl0ZXJhdGlvbkl0ZW08VCwgVT4sXG4gIFZhbHVlUmVmZXJlbmNlVHlwZSBleHRlbmRzIFBhdGhSZWZlcmVuY2U8VD4sXG4gIE1lbW9SZWZlcmVuY2VUeXBlIGV4dGVuZHMgUGF0aFJlZmVyZW5jZTxVPlxuPiB7XG4gIHRhZzogVGFnO1xuICBpdGVyYXRlKCk6IEFic3RyYWN0SXRlcmF0b3I8VCwgVSwgSXRlbVR5cGU+O1xuXG4gIHZhbHVlUmVmZXJlbmNlRm9yKGl0ZW06IEl0ZW1UeXBlKTogVmFsdWVSZWZlcmVuY2VUeXBlO1xuICB1cGRhdGVWYWx1ZVJlZmVyZW5jZShyZWZlcmVuY2U6IFZhbHVlUmVmZXJlbmNlVHlwZSwgaXRlbTogSXRlbVR5cGUpOiB2b2lkO1xuXG4gIG1lbW9SZWZlcmVuY2VGb3IoaXRlbTogSXRlbVR5cGUpOiBNZW1vUmVmZXJlbmNlVHlwZTtcbiAgdXBkYXRlTWVtb1JlZmVyZW5jZShyZWZlcmVuY2U6IE1lbW9SZWZlcmVuY2VUeXBlLCBpdGVtOiBJdGVtVHlwZSk6IHZvaWQ7XG59XG5cbmV4cG9ydCB0eXBlIEl0ZXJhdG9yPFQsIFU+ID0gQWJzdHJhY3RJdGVyYXRvcjxULCBVLCBJdGVyYXRpb25JdGVtPFQsIFU+PjtcbmV4cG9ydCB0eXBlIEl0ZXJhYmxlPFQsIFU+ID0gQWJzdHJhY3RJdGVyYWJsZTxcbiAgVCxcbiAgVSxcbiAgSXRlcmF0aW9uSXRlbTxULCBVPixcbiAgUGF0aFJlZmVyZW5jZTxUPixcbiAgUGF0aFJlZmVyZW5jZTxVPlxuPjtcblxuZXhwb3J0IHR5cGUgT3BhcXVlSXRlcmF0aW9uSXRlbSA9IEl0ZXJhdGlvbkl0ZW08dW5rbm93biwgdW5rbm93bj47XG5leHBvcnQgdHlwZSBPcGFxdWVJdGVyYXRvciA9IEFic3RyYWN0SXRlcmF0b3I8dW5rbm93biwgdW5rbm93biwgT3BhcXVlSXRlcmF0aW9uSXRlbT47XG5leHBvcnQgdHlwZSBPcGFxdWVQYXRoUmVmZXJlbmNlID0gUGF0aFJlZmVyZW5jZTx1bmtub3duPjtcbmV4cG9ydCB0eXBlIE9wYXF1ZUl0ZXJhYmxlID0gQWJzdHJhY3RJdGVyYWJsZTxcbiAgdW5rbm93bixcbiAgdW5rbm93bixcbiAgT3BhcXVlSXRlcmF0aW9uSXRlbSxcbiAgT3BhcXVlUGF0aFJlZmVyZW5jZSxcbiAgT3BhcXVlUGF0aFJlZmVyZW5jZVxuPjtcbmV4cG9ydCB0eXBlIE9wYXF1ZVBhdGhSZWZlcmVuY2VJdGVyYXRpb25JdGVtID0gSXRlcmF0aW9uSXRlbTxcbiAgT3BhcXVlUGF0aFJlZmVyZW5jZSxcbiAgT3BhcXVlUGF0aFJlZmVyZW5jZVxuPjtcblxuZXhwb3J0IGNsYXNzIExpc3RJdGVtIGV4dGVuZHMgTGlzdE5vZGU8T3BhcXVlUGF0aFJlZmVyZW5jZT4gaW1wbGVtZW50cyBPcGFxdWVJdGVyYXRpb25JdGVtIHtcbiAgcHVibGljIGtleTogdW5rbm93bjtcbiAgcHVibGljIG1lbW86IE9wYXF1ZVBhdGhSZWZlcmVuY2U7XG4gIHB1YmxpYyByZXRhaW5lZCA9IGZhbHNlO1xuICBwdWJsaWMgc2VlbiA9IGZhbHNlO1xuICBwcml2YXRlIGl0ZXJhYmxlOiBPcGFxdWVJdGVyYWJsZTtcblxuICBjb25zdHJ1Y3RvcihpdGVyYWJsZTogT3BhcXVlSXRlcmFibGUsIHJlc3VsdDogT3BhcXVlSXRlcmF0aW9uSXRlbSkge1xuICAgIHN1cGVyKGl0ZXJhYmxlLnZhbHVlUmVmZXJlbmNlRm9yKHJlc3VsdCkpO1xuICAgIHRoaXMua2V5ID0gcmVzdWx0LmtleTtcbiAgICB0aGlzLml0ZXJhYmxlID0gaXRlcmFibGU7XG4gICAgdGhpcy5tZW1vID0gaXRlcmFibGUubWVtb1JlZmVyZW5jZUZvcihyZXN1bHQpO1xuICB9XG5cbiAgdXBkYXRlKGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0pIHtcbiAgICB0aGlzLnJldGFpbmVkID0gdHJ1ZTtcbiAgICB0aGlzLml0ZXJhYmxlLnVwZGF0ZVZhbHVlUmVmZXJlbmNlKHRoaXMudmFsdWUsIGl0ZW0pO1xuICAgIHRoaXMuaXRlcmFibGUudXBkYXRlTWVtb1JlZmVyZW5jZSh0aGlzLm1lbW8sIGl0ZW0pO1xuICB9XG5cbiAgc2hvdWxkUmVtb3ZlKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhdGhpcy5yZXRhaW5lZDtcbiAgfVxuXG4gIHJlc2V0KCkge1xuICAgIHRoaXMucmV0YWluZWQgPSBmYWxzZTtcbiAgICB0aGlzLnNlZW4gPSBmYWxzZTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgSXRlcmF0aW9uQXJ0aWZhY3RzIHtcbiAgcHVibGljIHRhZzogVGFnO1xuXG4gIHByaXZhdGUgaXRlcmFibGU6IE9wYXF1ZUl0ZXJhYmxlO1xuICBwcml2YXRlIGl0ZXJhdG9yOiBPcHRpb248T3BhcXVlSXRlcmF0b3I+ID0gbnVsbDtcbiAgcHJpdmF0ZSBtYXAgPSBuZXcgTWFwPHVua25vd24sIExpc3RJdGVtPigpO1xuICBwcml2YXRlIGxpc3QgPSBuZXcgTGlua2VkTGlzdDxMaXN0SXRlbT4oKTtcblxuICBjb25zdHJ1Y3RvcihpdGVyYWJsZTogT3BhcXVlSXRlcmFibGUpIHtcbiAgICB0aGlzLnRhZyA9IGl0ZXJhYmxlLnRhZztcbiAgICB0aGlzLml0ZXJhYmxlID0gaXRlcmFibGU7XG4gIH1cblxuICBpc0VtcHR5KCk6IGJvb2xlYW4ge1xuICAgIGxldCBpdGVyYXRvciA9ICh0aGlzLml0ZXJhdG9yID0gdGhpcy5pdGVyYWJsZS5pdGVyYXRlKCkpO1xuICAgIHJldHVybiBpdGVyYXRvci5pc0VtcHR5KCk7XG4gIH1cblxuICBpdGVyYXRlKCk6IE9wYXF1ZUl0ZXJhdG9yIHtcbiAgICBsZXQgaXRlcmF0b3I6IE9wYXF1ZUl0ZXJhdG9yO1xuXG4gICAgaWYgKHRoaXMuaXRlcmF0b3IgPT09IG51bGwpIHtcbiAgICAgIGl0ZXJhdG9yID0gdGhpcy5pdGVyYWJsZS5pdGVyYXRlKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGl0ZXJhdG9yID0gdGhpcy5pdGVyYXRvcjtcbiAgICB9XG5cbiAgICB0aGlzLml0ZXJhdG9yID0gbnVsbDtcblxuICAgIHJldHVybiBpdGVyYXRvcjtcbiAgfVxuXG4gIGFkdmFuY2VUb0tleShrZXk6IHVua25vd24sIGN1cnJlbnQ6IExpc3RJdGVtKTogT3B0aW9uPExpc3RJdGVtPiB7XG4gICAgbGV0IHNlZWsgPSBjdXJyZW50O1xuXG4gICAgd2hpbGUgKHNlZWsgIT09IG51bGwgJiYgc2Vlay5rZXkgIT09IGtleSkge1xuICAgICAgc2VlayA9IHRoaXMuYWR2YW5jZU5vZGUoc2Vlayk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHNlZWs7XG4gIH1cblxuICBoYXMoa2V5OiB1bmtub3duKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubWFwLmhhcyhrZXkpO1xuICB9XG5cbiAgZ2V0KGtleTogdW5rbm93bik6IExpc3RJdGVtIHtcbiAgICByZXR1cm4gdGhpcy5tYXAuZ2V0KGtleSkhO1xuICB9XG5cbiAgd2FzU2VlbihrZXk6IHVua25vd24pOiBib29sZWFuIHtcbiAgICBsZXQgbm9kZSA9IHRoaXMubWFwLmdldChrZXkpO1xuICAgIHJldHVybiBub2RlICE9PSB1bmRlZmluZWQgJiYgbm9kZS5zZWVuO1xuICB9XG5cbiAgdXBkYXRlKGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0pOiBMaXN0SXRlbSB7XG4gICAgbGV0IGZvdW5kID0gdGhpcy5nZXQoaXRlbS5rZXkpO1xuICAgIGZvdW5kLnVwZGF0ZShpdGVtKTtcbiAgICByZXR1cm4gZm91bmQ7XG4gIH1cblxuICBhcHBlbmQoaXRlbTogT3BhcXVlSXRlcmF0aW9uSXRlbSk6IExpc3RJdGVtIHtcbiAgICBsZXQgeyBtYXAsIGxpc3QsIGl0ZXJhYmxlIH0gPSB0aGlzO1xuXG4gICAgbGV0IG5vZGUgPSBuZXcgTGlzdEl0ZW0oaXRlcmFibGUsIGl0ZW0pO1xuICAgIG1hcC5zZXQoaXRlbS5rZXksIG5vZGUpO1xuXG4gICAgbGlzdC5hcHBlbmQobm9kZSk7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICBpbnNlcnRCZWZvcmUoaXRlbTogT3BhcXVlSXRlcmF0aW9uSXRlbSwgcmVmZXJlbmNlOiBPcHRpb248TGlzdEl0ZW0+KTogTGlzdEl0ZW0ge1xuICAgIGxldCB7IG1hcCwgbGlzdCwgaXRlcmFibGUgfSA9IHRoaXM7XG5cbiAgICBsZXQgbm9kZSA9IG5ldyBMaXN0SXRlbShpdGVyYWJsZSwgaXRlbSk7XG4gICAgbWFwLnNldChpdGVtLmtleSwgbm9kZSk7XG4gICAgbm9kZS5yZXRhaW5lZCA9IHRydWU7XG4gICAgbGlzdC5pbnNlcnRCZWZvcmUobm9kZSwgcmVmZXJlbmNlKTtcbiAgICByZXR1cm4gbm9kZTtcbiAgfVxuXG4gIG1vdmUoaXRlbTogTGlzdEl0ZW0sIHJlZmVyZW5jZTogT3B0aW9uPExpc3RJdGVtPik6IHZvaWQge1xuICAgIGxldCB7IGxpc3QgfSA9IHRoaXM7XG4gICAgaXRlbS5yZXRhaW5lZCA9IHRydWU7XG4gICAgbGlzdC5yZW1vdmUoaXRlbSk7XG4gICAgbGlzdC5pbnNlcnRCZWZvcmUoaXRlbSwgcmVmZXJlbmNlKTtcbiAgfVxuXG4gIHJlbW92ZShpdGVtOiBMaXN0SXRlbSk6IHZvaWQge1xuICAgIGxldCB7IGxpc3QgfSA9IHRoaXM7XG5cbiAgICBsaXN0LnJlbW92ZShpdGVtKTtcbiAgICB0aGlzLm1hcC5kZWxldGUoaXRlbS5rZXkpO1xuICB9XG5cbiAgbmV4dE5vZGUoaXRlbTogTGlzdEl0ZW0pOiBMaXN0SXRlbSB7XG4gICAgcmV0dXJuIHRoaXMubGlzdC5uZXh0Tm9kZShpdGVtKTtcbiAgfVxuXG4gIGFkdmFuY2VOb2RlKGl0ZW06IExpc3RJdGVtKTogTGlzdEl0ZW0ge1xuICAgIGl0ZW0uc2VlbiA9IHRydWU7XG4gICAgcmV0dXJuIHRoaXMubGlzdC5uZXh0Tm9kZShpdGVtKTtcbiAgfVxuXG4gIGhlYWQoKTogT3B0aW9uPExpc3RJdGVtPiB7XG4gICAgcmV0dXJuIHRoaXMubGlzdC5oZWFkKCk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFJlZmVyZW5jZUl0ZXJhdG9yIHtcbiAgcHVibGljIGFydGlmYWN0czogSXRlcmF0aW9uQXJ0aWZhY3RzO1xuICBwcml2YXRlIGl0ZXJhdG9yOiBPcHRpb248T3BhcXVlSXRlcmF0b3I+ID0gbnVsbDtcblxuICAvLyBpZiBhbnlvbmUgbmVlZHMgdG8gY29uc3RydWN0IHRoaXMgb2JqZWN0IHdpdGggc29tZXRoaW5nIG90aGVyIHRoYW5cbiAgLy8gYW4gaXRlcmFibGUsIGxldCBAd3ljYXRzIGtub3cuXG4gIGNvbnN0cnVjdG9yKGl0ZXJhYmxlOiBPcGFxdWVJdGVyYWJsZSkge1xuICAgIGxldCBhcnRpZmFjdHMgPSBuZXcgSXRlcmF0aW9uQXJ0aWZhY3RzKGl0ZXJhYmxlKTtcbiAgICB0aGlzLmFydGlmYWN0cyA9IGFydGlmYWN0cztcbiAgfVxuXG4gIG5leHQoKTogT3B0aW9uPExpc3RJdGVtPiB7XG4gICAgbGV0IHsgYXJ0aWZhY3RzIH0gPSB0aGlzO1xuXG4gICAgbGV0IGl0ZXJhdG9yID0gKHRoaXMuaXRlcmF0b3IgPSB0aGlzLml0ZXJhdG9yIHx8IGFydGlmYWN0cy5pdGVyYXRlKCkpO1xuXG4gICAgbGV0IGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7XG5cbiAgICBpZiAoaXRlbSA9PT0gbnVsbCkgcmV0dXJuIG51bGw7XG5cbiAgICByZXR1cm4gYXJ0aWZhY3RzLmFwcGVuZChpdGVtKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEl0ZXJhdG9yU3luY2hyb25pemVyRGVsZWdhdGU8RW52PiB7XG4gIHJldGFpbihlbnY6IEVudiwga2V5OiB1bmtub3duLCBpdGVtOiBQYXRoUmVmZXJlbmNlPHVua25vd24+LCBtZW1vOiBQYXRoUmVmZXJlbmNlPHVua25vd24+KTogdm9pZDtcbiAgaW5zZXJ0KFxuICAgIGVudjogRW52LFxuICAgIGtleTogdW5rbm93bixcbiAgICBpdGVtOiBQYXRoUmVmZXJlbmNlPHVua25vd24+LFxuICAgIG1lbW86IFBhdGhSZWZlcmVuY2U8dW5rbm93bj4sXG4gICAgYmVmb3JlOiBPcHRpb248dW5rbm93bj5cbiAgKTogdm9pZDtcbiAgbW92ZShcbiAgICBlbnY6IEVudixcbiAgICBrZXk6IHVua25vd24sXG4gICAgaXRlbTogUGF0aFJlZmVyZW5jZTx1bmtub3duPixcbiAgICBtZW1vOiBQYXRoUmVmZXJlbmNlPHVua25vd24+LFxuICAgIGJlZm9yZTogT3B0aW9uPHVua25vd24+XG4gICk6IHZvaWQ7XG4gIGRlbGV0ZShlbnY6IEVudiwga2V5OiB1bmtub3duKTogdm9pZDtcbiAgZG9uZShlbnY6IEVudik6IHZvaWQ7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgSXRlcmF0b3JTeW5jaHJvbml6ZXJPcHRpb25zPEVudj4ge1xuICB0YXJnZXQ6IEl0ZXJhdG9yU3luY2hyb25pemVyRGVsZWdhdGU8RW52PjtcbiAgYXJ0aWZhY3RzOiBJdGVyYXRpb25BcnRpZmFjdHM7XG4gIGVudjogRW52O1xufVxuXG5lbnVtIFBoYXNlIHtcbiAgQXBwZW5kLFxuICBQcnVuZSxcbiAgRG9uZSxcbn1cblxuZXhwb3J0IGNvbnN0IEVORCA9ICdFTkQgWzI2MDBhYmRmLTg4OWYtNDQwNi1iMDU5LWI0NGVjYmFmYTVjNV0nO1xuXG5leHBvcnQgY2xhc3MgSXRlcmF0b3JTeW5jaHJvbml6ZXI8RW52PiB7XG4gIHByaXZhdGUgdGFyZ2V0OiBJdGVyYXRvclN5bmNocm9uaXplckRlbGVnYXRlPEVudj47XG4gIHByaXZhdGUgaXRlcmF0b3I6IE9wYXF1ZUl0ZXJhdG9yO1xuICBwcml2YXRlIGN1cnJlbnQ6IE9wdGlvbjxMaXN0SXRlbT47XG4gIHByaXZhdGUgYXJ0aWZhY3RzOiBJdGVyYXRpb25BcnRpZmFjdHM7XG4gIHByaXZhdGUgZW52OiBFbnY7XG5cbiAgY29uc3RydWN0b3IoeyB0YXJnZXQsIGFydGlmYWN0cywgZW52IH06IEl0ZXJhdG9yU3luY2hyb25pemVyT3B0aW9uczxFbnY+KSB7XG4gICAgdGhpcy50YXJnZXQgPSB0YXJnZXQ7XG4gICAgdGhpcy5hcnRpZmFjdHMgPSBhcnRpZmFjdHM7XG4gICAgdGhpcy5pdGVyYXRvciA9IGFydGlmYWN0cy5pdGVyYXRlKCk7XG4gICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLmhlYWQoKTtcbiAgICB0aGlzLmVudiA9IGVudjtcbiAgfVxuXG4gIHN5bmMoKSB7XG4gICAgbGV0IHBoYXNlOiBQaGFzZSA9IFBoYXNlLkFwcGVuZDtcblxuICAgIHdoaWxlICh0cnVlKSB7XG4gICAgICBzd2l0Y2ggKHBoYXNlKSB7XG4gICAgICAgIGNhc2UgUGhhc2UuQXBwZW5kOlxuICAgICAgICAgIHBoYXNlID0gdGhpcy5uZXh0QXBwZW5kKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgUGhhc2UuUHJ1bmU6XG4gICAgICAgICAgcGhhc2UgPSB0aGlzLm5leHRQcnVuZSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFBoYXNlLkRvbmU6XG4gICAgICAgICAgdGhpcy5uZXh0RG9uZSgpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBwcml2YXRlIGFkdmFuY2VUb0tleShrZXk6IHVua25vd24pIHtcbiAgICBsZXQgeyBjdXJyZW50LCBhcnRpZmFjdHMgfSA9IHRoaXM7XG5cbiAgICBpZiAoY3VycmVudCA9PT0gbnVsbCkgcmV0dXJuO1xuXG4gICAgbGV0IG5leHQgPSBhcnRpZmFjdHMuYWR2YW5jZU5vZGUoY3VycmVudCk7XG5cbiAgICBpZiAobmV4dC5rZXkgPT09IGtleSkge1xuICAgICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLmFkdmFuY2VOb2RlKG5leHQpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGxldCBzZWVrID0gYXJ0aWZhY3RzLmFkdmFuY2VUb0tleShrZXksIGN1cnJlbnQpO1xuXG4gICAgaWYgKHNlZWspIHtcbiAgICAgIHRoaXMubW92ZShzZWVrLCBjdXJyZW50KTtcbiAgICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5uZXh0Tm9kZShjdXJyZW50KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG1vdmUoaXRlbTogTGlzdEl0ZW0sIHJlZmVyZW5jZTogT3B0aW9uPExpc3RJdGVtPikge1xuICAgIGlmIChpdGVtLm5leHQgIT09IHJlZmVyZW5jZSkge1xuICAgICAgdGhpcy5hcnRpZmFjdHMubW92ZShpdGVtLCByZWZlcmVuY2UpO1xuICAgICAgdGhpcy50YXJnZXQubW92ZSh0aGlzLmVudiwgaXRlbS5rZXksIGl0ZW0udmFsdWUsIGl0ZW0ubWVtbywgcmVmZXJlbmNlID8gcmVmZXJlbmNlLmtleSA6IEVORCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBuZXh0QXBwZW5kKCk6IFBoYXNlIHtcbiAgICBsZXQgeyBpdGVyYXRvciwgY3VycmVudCwgYXJ0aWZhY3RzIH0gPSB0aGlzO1xuXG4gICAgbGV0IGl0ZW0gPSBpdGVyYXRvci5uZXh0KCk7XG5cbiAgICBpZiAoaXRlbSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3RhcnRQcnVuZSgpO1xuICAgIH1cblxuICAgIGxldCB7IGtleSB9ID0gaXRlbTtcblxuICAgIGlmIChjdXJyZW50ICE9PSBudWxsICYmIGN1cnJlbnQua2V5ID09PSBrZXkpIHtcbiAgICAgIHRoaXMubmV4dFJldGFpbihpdGVtLCBjdXJyZW50KTtcbiAgICB9IGVsc2UgaWYgKGFydGlmYWN0cy5oYXMoa2V5KSkge1xuICAgICAgdGhpcy5uZXh0TW92ZShpdGVtKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5uZXh0SW5zZXJ0KGl0ZW0pO1xuICAgIH1cblxuICAgIHJldHVybiBQaGFzZS5BcHBlbmQ7XG4gIH1cblxuICBwcml2YXRlIG5leHRSZXRhaW4oaXRlbTogT3BhcXVlSXRlcmF0aW9uSXRlbSwgY3VycmVudDogTGlzdEl0ZW0pIHtcbiAgICBsZXQgeyBhcnRpZmFjdHMgfSA9IHRoaXM7XG5cbiAgICAvLyBjdXJyZW50ID0gZXhwZWN0KGN1cnJlbnQsICdCVUc6IGN1cnJlbnQgaXMgZW1wdHknKTtcblxuICAgIGN1cnJlbnQudXBkYXRlKGl0ZW0pO1xuICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5uZXh0Tm9kZShjdXJyZW50KTtcbiAgICB0aGlzLnRhcmdldC5yZXRhaW4odGhpcy5lbnYsIGl0ZW0ua2V5LCBjdXJyZW50LnZhbHVlLCBjdXJyZW50Lm1lbW8pO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXh0TW92ZShpdGVtOiBPcGFxdWVJdGVyYXRpb25JdGVtKSB7XG4gICAgbGV0IHsgY3VycmVudCwgYXJ0aWZhY3RzIH0gPSB0aGlzO1xuICAgIGxldCB7IGtleSB9ID0gaXRlbTtcblxuICAgIGxldCBmb3VuZCA9IGFydGlmYWN0cy51cGRhdGUoaXRlbSk7XG5cbiAgICBpZiAoYXJ0aWZhY3RzLndhc1NlZW4oa2V5KSkge1xuICAgICAgdGhpcy5tb3ZlKGZvdW5kLCBjdXJyZW50KTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5hZHZhbmNlVG9LZXkoa2V5KTtcbiAgICB9XG4gIH1cblxuICBwcml2YXRlIG5leHRJbnNlcnQoaXRlbTogT3BhcXVlSXRlcmF0aW9uSXRlbSkge1xuICAgIGxldCB7IGFydGlmYWN0cywgdGFyZ2V0LCBjdXJyZW50IH0gPSB0aGlzO1xuXG4gICAgbGV0IG5vZGUgPSBhcnRpZmFjdHMuaW5zZXJ0QmVmb3JlKGl0ZW0sIGN1cnJlbnQpO1xuICAgIHRhcmdldC5pbnNlcnQodGhpcy5lbnYsIG5vZGUua2V5LCBub2RlLnZhbHVlLCBub2RlLm1lbW8sIGN1cnJlbnQgPyBjdXJyZW50LmtleSA6IG51bGwpO1xuICB9XG5cbiAgcHJpdmF0ZSBzdGFydFBydW5lKCk6IFBoYXNlIHtcbiAgICB0aGlzLmN1cnJlbnQgPSB0aGlzLmFydGlmYWN0cy5oZWFkKCk7XG4gICAgcmV0dXJuIFBoYXNlLlBydW5lO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXh0UHJ1bmUoKTogUGhhc2Uge1xuICAgIGxldCB7IGFydGlmYWN0cywgdGFyZ2V0LCBjdXJyZW50IH0gPSB0aGlzO1xuXG4gICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHtcbiAgICAgIHJldHVybiBQaGFzZS5Eb25lO1xuICAgIH1cblxuICAgIGxldCBub2RlID0gY3VycmVudDtcbiAgICB0aGlzLmN1cnJlbnQgPSBhcnRpZmFjdHMubmV4dE5vZGUobm9kZSk7XG5cbiAgICBpZiAobm9kZS5zaG91bGRSZW1vdmUoKSkge1xuICAgICAgYXJ0aWZhY3RzLnJlbW92ZShub2RlKTtcbiAgICAgIHRhcmdldC5kZWxldGUodGhpcy5lbnYsIG5vZGUua2V5KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbm9kZS5yZXNldCgpO1xuICAgIH1cblxuICAgIHJldHVybiBQaGFzZS5QcnVuZTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dERvbmUoKSB7XG4gICAgdGhpcy50YXJnZXQuZG9uZSh0aGlzLmVudik7XG4gIH1cbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=