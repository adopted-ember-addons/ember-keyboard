import { LinkedList, ListNode } from '@glimmer/util';
export class ListItem extends ListNode {
    constructor(iterable, result) {
        super(iterable.valueReferenceFor(result));
        this.retained = false;
        this.seen = false;
        this.key = result.key;
        this.iterable = iterable;
        this.memo = iterable.memoReferenceFor(result);
    }
    update(item) {
        this.retained = true;
        this.iterable.updateValueReference(this.value, item);
        this.iterable.updateMemoReference(this.memo, item);
    }
    shouldRemove() {
        return !this.retained;
    }
    reset() {
        this.retained = false;
        this.seen = false;
    }
}
export class IterationArtifacts {
    constructor(iterable) {
        this.iterator = null;
        this.map = new Map();
        this.list = new LinkedList();
        this.tag = iterable.tag;
        this.iterable = iterable;
    }
    isEmpty() {
        let iterator = this.iterator = this.iterable.iterate();
        return iterator.isEmpty();
    }
    iterate() {
        let iterator;
        if (this.iterator === null) {
            iterator = this.iterable.iterate();
        } else {
            iterator = this.iterator;
        }
        this.iterator = null;
        return iterator;
    }
    advanceToKey(key, current) {
        let seek = current;
        while (seek !== null && seek.key !== key) {
            seek = this.advanceNode(seek);
        }
        return seek;
    }
    has(key) {
        return this.map.has(key);
    }
    get(key) {
        return this.map.get(key);
    }
    wasSeen(key) {
        let node = this.map.get(key);
        return node !== undefined && node.seen;
    }
    update(item) {
        let found = this.get(item.key);
        found.update(item);
        return found;
    }
    append(item) {
        let { map, list, iterable } = this;
        let node = new ListItem(iterable, item);
        map.set(item.key, node);
        list.append(node);
        return node;
    }
    insertBefore(item, reference) {
        let { map, list, iterable } = this;
        let node = new ListItem(iterable, item);
        map.set(item.key, node);
        node.retained = true;
        list.insertBefore(node, reference);
        return node;
    }
    move(item, reference) {
        let { list } = this;
        item.retained = true;
        list.remove(item);
        list.insertBefore(item, reference);
    }
    remove(item) {
        let { list } = this;
        list.remove(item);
        this.map.delete(item.key);
    }
    nextNode(item) {
        return this.list.nextNode(item);
    }
    advanceNode(item) {
        item.seen = true;
        return this.list.nextNode(item);
    }
    head() {
        return this.list.head();
    }
}
export class ReferenceIterator {
    // if anyone needs to construct this object with something other than
    // an iterable, let @wycats know.
    constructor(iterable) {
        this.iterator = null;
        let artifacts = new IterationArtifacts(iterable);
        this.artifacts = artifacts;
    }
    next() {
        let { artifacts } = this;
        let iterator = this.iterator = this.iterator || artifacts.iterate();
        let item = iterator.next();
        if (item === null) return null;
        return artifacts.append(item);
    }
}
var Phase;
(function (Phase) {
    Phase[Phase["Append"] = 0] = "Append";
    Phase[Phase["Prune"] = 1] = "Prune";
    Phase[Phase["Done"] = 2] = "Done";
})(Phase || (Phase = {}));
export const END = 'END [2600abdf-889f-4406-b059-b44ecbafa5c5]';
export class IteratorSynchronizer {
    constructor({ target, artifacts, env }) {
        this.target = target;
        this.artifacts = artifacts;
        this.iterator = artifacts.iterate();
        this.current = artifacts.head();
        this.env = env;
    }
    sync() {
        let phase = Phase.Append;
        while (true) {
            switch (phase) {
                case Phase.Append:
                    phase = this.nextAppend();
                    break;
                case Phase.Prune:
                    phase = this.nextPrune();
                    break;
                case Phase.Done:
                    this.nextDone();
                    return;
            }
        }
    }
    advanceToKey(key) {
        let { current, artifacts } = this;
        if (current === null) return;
        let next = artifacts.advanceNode(current);
        if (next.key === key) {
            this.current = artifacts.advanceNode(next);
            return;
        }
        let seek = artifacts.advanceToKey(key, current);
        if (seek) {
            this.move(seek, current);
            this.current = artifacts.nextNode(current);
        }
    }
    move(item, reference) {
        if (item.next !== reference) {
            this.artifacts.move(item, reference);
            this.target.move(this.env, item.key, item.value, item.memo, reference ? reference.key : END);
        }
    }
    nextAppend() {
        let { iterator, current, artifacts } = this;
        let item = iterator.next();
        if (item === null) {
            return this.startPrune();
        }
        let { key } = item;
        if (current !== null && current.key === key) {
            this.nextRetain(item, current);
        } else if (artifacts.has(key)) {
            this.nextMove(item);
        } else {
            this.nextInsert(item);
        }
        return Phase.Append;
    }
    nextRetain(item, current) {
        let { artifacts } = this;
        // current = expect(current, 'BUG: current is empty');
        current.update(item);
        this.current = artifacts.nextNode(current);
        this.target.retain(this.env, item.key, current.value, current.memo);
    }
    nextMove(item) {
        let { current, artifacts } = this;
        let { key } = item;
        let found = artifacts.update(item);
        if (artifacts.wasSeen(key)) {
            this.move(found, current);
        } else {
            this.advanceToKey(key);
        }
    }
    nextInsert(item) {
        let { artifacts, target, current } = this;
        let node = artifacts.insertBefore(item, current);
        target.insert(this.env, node.key, node.value, node.memo, current ? current.key : null);
    }
    startPrune() {
        this.current = this.artifacts.head();
        return Phase.Prune;
    }
    nextPrune() {
        let { artifacts, target, current } = this;
        if (current === null) {
            return Phase.Done;
        }
        let node = current;
        this.current = artifacts.nextNode(node);
        if (node.shouldRemove()) {
            artifacts.remove(node);
            target.delete(this.env, node.key);
        } else {
            node.reset();
        }
        return Phase.Prune;
    }
    nextDone() {
        this.target.done(this.env);
    }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3JlZmVyZW5jZS9saWIvaXRlcmFibGUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsU0FBUyxVQUFULEVBQXFCLFFBQXJCLFFBQTZDLGVBQTdDO0FBd0RBLE9BQU0sTUFBTyxRQUFQLFNBQXdCLFFBQXhCLENBQXFEO0FBT3pELGdCQUFZLFFBQVosRUFBc0MsTUFBdEMsRUFBaUU7QUFDL0QsY0FBTSxTQUFTLGlCQUFULENBQTJCLE1BQTNCLENBQU47QUFMSyxhQUFBLFFBQUEsR0FBVyxLQUFYO0FBQ0EsYUFBQSxJQUFBLEdBQU8sS0FBUDtBQUtMLGFBQUssR0FBTCxHQUFXLE9BQU8sR0FBbEI7QUFDQSxhQUFLLFFBQUwsR0FBZ0IsUUFBaEI7QUFDQSxhQUFLLElBQUwsR0FBWSxTQUFTLGdCQUFULENBQTBCLE1BQTFCLENBQVo7QUFDRDtBQUVELFdBQU8sSUFBUCxFQUFnQztBQUM5QixhQUFLLFFBQUwsR0FBZ0IsSUFBaEI7QUFDQSxhQUFLLFFBQUwsQ0FBYyxvQkFBZCxDQUFtQyxLQUFLLEtBQXhDLEVBQStDLElBQS9DO0FBQ0EsYUFBSyxRQUFMLENBQWMsbUJBQWQsQ0FBa0MsS0FBSyxJQUF2QyxFQUE2QyxJQUE3QztBQUNEO0FBRUQsbUJBQVk7QUFDVixlQUFPLENBQUMsS0FBSyxRQUFiO0FBQ0Q7QUFFRCxZQUFLO0FBQ0gsYUFBSyxRQUFMLEdBQWdCLEtBQWhCO0FBQ0EsYUFBSyxJQUFMLEdBQVksS0FBWjtBQUNEO0FBM0J3RDtBQThCM0QsT0FBTSxNQUFPLGtCQUFQLENBQXlCO0FBUTdCLGdCQUFZLFFBQVosRUFBb0M7QUFKNUIsYUFBQSxRQUFBLEdBQW1DLElBQW5DO0FBQ0EsYUFBQSxHQUFBLEdBQU0sSUFBSSxHQUFKLEVBQU47QUFDQSxhQUFBLElBQUEsR0FBTyxJQUFJLFVBQUosRUFBUDtBQUdOLGFBQUssR0FBTCxHQUFXLFNBQVMsR0FBcEI7QUFDQSxhQUFLLFFBQUwsR0FBZ0Is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R0FBbEI7QUFDRDtBQUNGO0FBRU8sZUFBVyxJQUFYLEVBQW9DO0FBQzFDLFlBQUksRUFBRSxTQUFGLEVBQWEsTUFBYixFQUFxQixPQUFyQixLQUFpQyxJQUFyQztBQUVBLFlBQUksT0FBTyxVQUFVLFlBQVYsQ0FBdUIsSUFBdkIsRUFBNkIsT0FBN0IsQ0FBWDtBQUNBLGVBQU8sTUFBUCxDQUFjLEtBQUssR0FBbkIsRUFBd0IsS0FBSyxHQUE3QixFQUFrQyxLQUFLLEtBQXZDLEVBQThDLEtBQUssSUFBbkQsRUFBeUQsVUFBVSxRQUFRLEdBQWxCLEdBQXdCLElBQWpGO0FBQ0Q7QUFFTyxpQkFBVTtBQUNoQixhQUFLLE9BQUwsR0FBZSxLQUFLLFNBQUwsQ0FBZSxJQUFmLEVBQWY7QUFDQSxlQUFPLE1BQU0sS0FBYjtBQUNEO0FBRU8sZ0JBQVM7QUFDZixZQUFJLEVBQUUsU0FBRixFQUFhLE1BQWIsRUFBcUIsT0FBckIsS0FBaUMsSUFBckM7QUFFQSxZQUFJLFlBQVksSUFBaEIsRUFBc0I7QUFDcEIsbUJBQU8sTUFBTSxJQUFiO0FBQ0Q7QUFFRCxZQUFJLE9BQU8sT0FBWDtBQUNBLGFBQUssT0FBTCxHQUFlLFVBQVUsUUFBVixDQUFtQixJQUFuQixDQUFmO0FBRUEsWUFBSSxLQUFLLFlBQUwsRUFBSixFQUF5QjtBQUN2QixzQkFBVSxNQUFWLENBQWlCLElBQWpCO0FBQ0EsbUJBQU8sTUFBUCxDQUFjLEtBQUssR0FBbkIsRUFBd0IsS0FBSyxHQUE3QjtBQUNELFNBSEQsTUFHTztBQUNMLGlCQUFLLEtBQUw7QUFDRDtBQUVELGVBQU8sTUFBTSxLQUFiO0FBQ0Q7QUFFTyxlQUFRO0FBQ2QsYUFBSyxNQUFMLENBQVksSUFBWixDQUFpQixLQUFLLEdBQXRCO0FBQ0Q7QUEzSThCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgTGlua2VkTGlzdCwgTGlzdE5vZGUsIE9wdGlvbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgVGFnIH0gZnJvbSAnLi92YWxpZGF0b3JzJztcbmltcG9ydCB7IFZlcnNpb25lZFBhdGhSZWZlcmVuY2UgYXMgUGF0aFJlZmVyZW5jZSB9IGZyb20gJy4vcmVmZXJlbmNlJztcblxuZXhwb3J0IGludGVyZmFjZSBJdGVyYXRpb25JdGVtPFQsIFU+IHtcbiAga2V5OiB1bmtub3duO1xuICB2YWx1ZTogVDtcbiAgbWVtbzogVTtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBYnN0cmFjdEl0ZXJhdG9yPFQsIFUsIFYgZXh0ZW5kcyBJdGVyYXRpb25JdGVtPFQsIFU+PiB7XG4gIGlzRW1wdHkoKTogYm9vbGVhbjtcbiAgbmV4dCgpOiBPcHRpb248Vj47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQWJzdHJhY3RJdGVyYWJsZTxcbiAgVCxcbiAgVSxcbiAgSXRlbVR5cGUgZXh0ZW5kcyBJdGVyYXRpb25JdGVtPFQsIFU+LFxuICBWYWx1ZVJlZmVyZW5jZVR5cGUgZXh0ZW5kcyBQYXRoUmVmZXJlbmNlPFQ+LFxuICBNZW1vUmVmZXJlbmNlVHlwZSBleHRlbmRzIFBhdGhSZWZlcmVuY2U8VT5cbj4ge1xuICB0YWc6IFRhZztcbiAgaXRlcmF0ZSgpOiBBYnN0cmFjdEl0ZXJhdG9yPFQsIFUsIEl0ZW1UeXBlPjtcblxuICB2YWx1ZVJlZmVyZW5jZUZvcihpdGVtOiBJdGVtVHlwZSk6IFZhbHVlUmVmZXJlbmNlVHlwZTtcbiAgdXBkYXRlVmFsdWVSZWZlcmVuY2UocmVmZXJlbmNlOiBWYWx1ZVJlZmVyZW5jZVR5cGUsIGl0ZW06IEl0ZW1UeXBlKTogdm9pZDtcblxuICBtZW1vUmVmZXJlbmNlRm9yKGl0ZW06IEl0ZW1UeXBlKTogTWVtb1JlZmVyZW5jZVR5cGU7XG4gIHVwZGF0ZU1lbW9SZWZlcmVuY2UocmVmZXJlbmNlOiBNZW1vUmVmZXJlbmNlVHlwZSwgaXRlbTogSXRlbVR5cGUpOiB2b2lkO1xufVxuXG5leHBvcnQgdHlwZSBJdGVyYXRvcjxULCBVPiA9IEFic3RyYWN0SXRlcmF0b3I8VCwgVSwgSXRlcmF0aW9uSXRlbTxULCBVPj47XG5leHBvcnQgdHlwZSBJdGVyYWJsZTxULCBVPiA9IEFic3RyYWN0SXRlcmFibGU8XG4gIFQsXG4gIFUsXG4gIEl0ZXJhdGlvbkl0ZW08VCwgVT4sXG4gIFBhdGhSZWZlcmVuY2U8VD4sXG4gIFBhdGhSZWZlcmVuY2U8VT5cbj47XG5cbmV4cG9ydCB0eXBlIE9wYXF1ZUl0ZXJhdGlvbkl0ZW0gPSBJdGVyYXRpb25JdGVtPHVua25vd24sIHVua25vd24+O1xuZXhwb3J0IHR5cGUgT3BhcXVlSXRlcmF0b3IgPSBBYnN0cmFjdEl0ZXJhdG9yPHVua25vd24sIHVua25vd24sIE9wYXF1ZUl0ZXJhdGlvbkl0ZW0+O1xuZXhwb3J0IHR5cGUgT3BhcXVlUGF0aFJlZmVyZW5jZSA9IFBhdGhSZWZlcmVuY2U8dW5rbm93bj47XG5leHBvcnQgdHlwZSBPcGFxdWVJdGVyYWJsZSA9IEFic3RyYWN0SXRlcmFibGU8XG4gIHVua25vd24sXG4gIHVua25vd24sXG4gIE9wYXF1ZUl0ZXJhdGlvbkl0ZW0sXG4gIE9wYXF1ZVBhdGhSZWZlcmVuY2UsXG4gIE9wYXF1ZVBhdGhSZWZlcmVuY2Vcbj47XG5leHBvcnQgdHlwZSBPcGFxdWVQYXRoUmVmZXJlbmNlSXRlcmF0aW9uSXRlbSA9IEl0ZXJhdGlvbkl0ZW08XG4gIE9wYXF1ZVBhdGhSZWZlcmVuY2UsXG4gIE9wYXF1ZVBhdGhSZWZlcmVuY2Vcbj47XG5cbmV4cG9ydCBjbGFzcyBMaXN0SXRlbSBleHRlbmRzIExpc3ROb2RlPE9wYXF1ZVBhdGhSZWZlcmVuY2U+IGltcGxlbWVudHMgT3BhcXVlSXRlcmF0aW9uSXRlbSB7XG4gIHB1YmxpYyBrZXk6IHVua25vd247XG4gIHB1YmxpYyBtZW1vOiBPcGFxdWVQYXRoUmVmZXJlbmNlO1xuICBwdWJsaWMgcmV0YWluZWQgPSBmYWxzZTtcbiAgcHVibGljIHNlZW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBpdGVyYWJsZTogT3BhcXVlSXRlcmFibGU7XG5cbiAgY29uc3RydWN0b3IoaXRlcmFibGU6IE9wYXF1ZUl0ZXJhYmxlLCByZXN1bHQ6IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0pIHtcbiAgICBzdXBlcihpdGVyYWJsZS52YWx1ZVJlZmVyZW5jZUZvcihyZXN1bHQpKTtcbiAgICB0aGlzLmtleSA9IHJlc3VsdC5rZXk7XG4gICAgdGhpcy5pdGVyYWJsZSA9IGl0ZXJhYmxlO1xuICAgIHRoaXMubWVtbyA9IGl0ZXJhYmxlLm1lbW9SZWZlcmVuY2VGb3IocmVzdWx0KTtcbiAgfVxuXG4gIHVwZGF0ZShpdGVtOiBPcGFxdWVJdGVyYXRpb25JdGVtKSB7XG4gICAgdGhpcy5yZXRhaW5lZCA9IHRydWU7XG4gICAgdGhpcy5pdGVyYWJsZS51cGRhdGVWYWx1ZVJlZmVyZW5jZSh0aGlzLnZhbHVlLCBpdGVtKTtcbiAgICB0aGlzLml0ZXJhYmxlLnVwZGF0ZU1lbW9SZWZlcmVuY2UodGhpcy5tZW1vLCBpdGVtKTtcbiAgfVxuXG4gIHNob3VsZFJlbW92ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gIXRoaXMucmV0YWluZWQ7XG4gIH1cblxuICByZXNldCgpIHtcbiAgICB0aGlzLnJldGFpbmVkID0gZmFsc2U7XG4gICAgdGhpcy5zZWVuID0gZmFsc2U7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEl0ZXJhdGlvbkFydGlmYWN0cyB7XG4gIHB1YmxpYyB0YWc6IFRhZztcblxuICBwcml2YXRlIGl0ZXJhYmxlOiBPcGFxdWVJdGVyYWJsZTtcbiAgcHJpdmF0ZSBpdGVyYXRvcjogT3B0aW9uPE9wYXF1ZUl0ZXJhdG9yPiA9IG51bGw7XG4gIHByaXZhdGUgbWFwID0gbmV3IE1hcDx1bmtub3duLCBMaXN0SXRlbT4oKTtcbiAgcHJpdmF0ZSBsaXN0ID0gbmV3IExpbmtlZExpc3Q8TGlzdEl0ZW0+KCk7XG5cbiAgY29uc3RydWN0b3IoaXRlcmFibGU6IE9wYXF1ZUl0ZXJhYmxlKSB7XG4gICAgdGhpcy50YWcgPSBpdGVyYWJsZS50YWc7XG4gICAgdGhpcy5pdGVyYWJsZSA9IGl0ZXJhYmxlO1xuICB9XG5cbiAgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICBsZXQgaXRlcmF0b3IgPSAodGhpcy5pdGVyYXRvciA9IHRoaXMuaXRlcmFibGUuaXRlcmF0ZSgpKTtcbiAgICByZXR1cm4gaXRlcmF0b3IuaXNFbXB0eSgpO1xuICB9XG5cbiAgaXRlcmF0ZSgpOiBPcGFxdWVJdGVyYXRvciB7XG4gICAgbGV0IGl0ZXJhdG9yOiBPcGFxdWVJdGVyYXRvcjtcblxuICAgIGlmICh0aGlzLml0ZXJhdG9yID09PSBudWxsKSB7XG4gICAgICBpdGVyYXRvciA9IHRoaXMuaXRlcmFibGUuaXRlcmF0ZSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpdGVyYXRvciA9IHRoaXMuaXRlcmF0b3I7XG4gICAgfVxuXG4gICAgdGhpcy5pdGVyYXRvciA9IG51bGw7XG5cbiAgICByZXR1cm4gaXRlcmF0b3I7XG4gIH1cblxuICBhZHZhbmNlVG9LZXkoa2V5OiB1bmtub3duLCBjdXJyZW50OiBMaXN0SXRlbSk6IE9wdGlvbjxMaXN0SXRlbT4ge1xuICAgIGxldCBzZWVrID0gY3VycmVudDtcblxuICAgIHdoaWxlIChzZWVrICE9PSBudWxsICYmIHNlZWsua2V5ICE9PSBrZXkpIHtcbiAgICAgIHNlZWsgPSB0aGlzLmFkdmFuY2VOb2RlKHNlZWspO1xuICAgIH1cblxuICAgIHJldHVybiBzZWVrO1xuICB9XG5cbiAgaGFzKGtleTogdW5rbm93bik6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLm1hcC5oYXMoa2V5KTtcbiAgfVxuXG4gIGdldChrZXk6IHVua25vd24pOiBMaXN0SXRlbSB7XG4gICAgcmV0dXJuIHRoaXMubWFwLmdldChrZXkpITtcbiAgfVxuXG4gIHdhc1NlZW4oa2V5OiB1bmtub3duKTogYm9vbGVhbiB7XG4gICAgbGV0IG5vZGUgPSB0aGlzLm1hcC5nZXQoa2V5KTtcbiAgICByZXR1cm4gbm9kZSAhPT0gdW5kZWZpbmVkICYmIG5vZGUuc2VlbjtcbiAgfVxuXG4gIHVwZGF0ZShpdGVtOiBPcGFxdWVJdGVyYXRpb25JdGVtKTogTGlzdEl0ZW0ge1xuICAgIGxldCBmb3VuZCA9IHRoaXMuZ2V0KGl0ZW0ua2V5KTtcbiAgICBmb3VuZC51cGRhdGUoaXRlbSk7XG4gICAgcmV0dXJuIGZvdW5kO1xuICB9XG5cbiAgYXBwZW5kKGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0pOiBMaXN0SXRlbSB7XG4gICAgbGV0IHsgbWFwLCBsaXN0LCBpdGVyYWJsZSB9ID0gdGhpcztcblxuICAgIGxldCBub2RlID0gbmV3IExpc3RJdGVtKGl0ZXJhYmxlLCBpdGVtKTtcbiAgICBtYXAuc2V0KGl0ZW0ua2V5LCBub2RlKTtcblxuICAgIGxpc3QuYXBwZW5kKG5vZGUpO1xuICAgIHJldHVybiBub2RlO1xuICB9XG5cbiAgaW5zZXJ0QmVmb3JlKGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0sIHJlZmVyZW5jZTogT3B0aW9uPExpc3RJdGVtPik6IExpc3RJdGVtIHtcbiAgICBsZXQgeyBtYXAsIGxpc3QsIGl0ZXJhYmxlIH0gPSB0aGlzO1xuXG4gICAgbGV0IG5vZGUgPSBuZXcgTGlzdEl0ZW0oaXRlcmFibGUsIGl0ZW0pO1xuICAgIG1hcC5zZXQoaXRlbS5rZXksIG5vZGUpO1xuICAgIG5vZGUucmV0YWluZWQgPSB0cnVlO1xuICAgIGxpc3QuaW5zZXJ0QmVmb3JlKG5vZGUsIHJlZmVyZW5jZSk7XG4gICAgcmV0dXJuIG5vZGU7XG4gIH1cblxuICBtb3ZlKGl0ZW06IExpc3RJdGVtLCByZWZlcmVuY2U6IE9wdGlvbjxMaXN0SXRlbT4pOiB2b2lkIHtcbiAgICBsZXQgeyBsaXN0IH0gPSB0aGlzO1xuICAgIGl0ZW0ucmV0YWluZWQgPSB0cnVlO1xuICAgIGxpc3QucmVtb3ZlKGl0ZW0pO1xuICAgIGxpc3QuaW5zZXJ0QmVmb3JlKGl0ZW0sIHJlZmVyZW5jZSk7XG4gIH1cblxuICByZW1vdmUoaXRlbTogTGlzdEl0ZW0pOiB2b2lkIHtcbiAgICBsZXQgeyBsaXN0IH0gPSB0aGlzO1xuXG4gICAgbGlzdC5yZW1vdmUoaXRlbSk7XG4gICAgdGhpcy5tYXAuZGVsZXRlKGl0ZW0ua2V5KTtcbiAgfVxuXG4gIG5leHROb2RlKGl0ZW06IExpc3RJdGVtKTogTGlzdEl0ZW0ge1xuICAgIHJldHVybiB0aGlzLmxpc3QubmV4dE5vZGUoaXRlbSk7XG4gIH1cblxuICBhZHZhbmNlTm9kZShpdGVtOiBMaXN0SXRlbSk6IExpc3RJdGVtIHtcbiAgICBpdGVtLnNlZW4gPSB0cnVlO1xuICAgIHJldHVybiB0aGlzLmxpc3QubmV4dE5vZGUoaXRlbSk7XG4gIH1cblxuICBoZWFkKCk6IE9wdGlvbjxMaXN0SXRlbT4ge1xuICAgIHJldHVybiB0aGlzLmxpc3QuaGVhZCgpO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBSZWZlcmVuY2VJdGVyYXRvciB7XG4gIHB1YmxpYyBhcnRpZmFjdHM6IEl0ZXJhdGlvbkFydGlmYWN0cztcbiAgcHJpdmF0ZSBpdGVyYXRvcjogT3B0aW9uPE9wYXF1ZUl0ZXJhdG9yPiA9IG51bGw7XG5cbiAgLy8gaWYgYW55b25lIG5lZWRzIHRvIGNvbnN0cnVjdCB0aGlzIG9iamVjdCB3aXRoIHNvbWV0aGluZyBvdGhlciB0aGFuXG4gIC8vIGFuIGl0ZXJhYmxlLCBsZXQgQHd5Y2F0cyBrbm93LlxuICBjb25zdHJ1Y3RvcihpdGVyYWJsZTogT3BhcXVlSXRlcmFibGUpIHtcbiAgICBsZXQgYXJ0aWZhY3RzID0gbmV3IEl0ZXJhdGlvbkFydGlmYWN0cyhpdGVyYWJsZSk7XG4gICAgdGhpcy5hcnRpZmFjdHMgPSBhcnRpZmFjdHM7XG4gIH1cblxuICBuZXh0KCk6IE9wdGlvbjxMaXN0SXRlbT4ge1xuICAgIGxldCB7IGFydGlmYWN0cyB9ID0gdGhpcztcblxuICAgIGxldCBpdGVyYXRvciA9ICh0aGlzLml0ZXJhdG9yID0gdGhpcy5pdGVyYXRvciB8fCBhcnRpZmFjdHMuaXRlcmF0ZSgpKTtcblxuICAgIGxldCBpdGVtID0gaXRlcmF0b3IubmV4dCgpO1xuXG4gICAgaWYgKGl0ZW0gPT09IG51bGwpIHJldHVybiBudWxsO1xuXG4gICAgcmV0dXJuIGFydGlmYWN0cy5hcHBlbmQoaXRlbSk7XG4gIH1cbn1cblxuZXhwb3J0IGludGVyZmFjZSBJdGVyYXRvclN5bmNocm9uaXplckRlbGVnYXRlPEVudj4ge1xuICByZXRhaW4oZW52OiBFbnYsIGtleTogdW5rbm93biwgaXRlbTogUGF0aFJlZmVyZW5jZTx1bmtub3duPiwgbWVtbzogUGF0aFJlZmVyZW5jZTx1bmtub3duPik6IHZvaWQ7XG4gIGluc2VydChcbiAgICBlbnY6IEVudixcbiAgICBrZXk6IHVua25vd24sXG4gICAgaXRlbTogUGF0aFJlZmVyZW5jZTx1bmtub3duPixcbiAgICBtZW1vOiBQYXRoUmVmZXJlbmNlPHVua25vd24+LFxuICAgIGJlZm9yZTogT3B0aW9uPHVua25vd24+XG4gICk6IHZvaWQ7XG4gIG1vdmUoXG4gICAgZW52OiBFbnYsXG4gICAga2V5OiB1bmtub3duLFxuICAgIGl0ZW06IFBhdGhSZWZlcmVuY2U8dW5rbm93bj4sXG4gICAgbWVtbzogUGF0aFJlZmVyZW5jZTx1bmtub3duPixcbiAgICBiZWZvcmU6IE9wdGlvbjx1bmtub3duPlxuICApOiB2b2lkO1xuICBkZWxldGUoZW52OiBFbnYsIGtleTogdW5rbm93bik6IHZvaWQ7XG4gIGRvbmUoZW52OiBFbnYpOiB2b2lkO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEl0ZXJhdG9yU3luY2hyb25pemVyT3B0aW9uczxFbnY+IHtcbiAgdGFyZ2V0OiBJdGVyYXRvclN5bmNocm9uaXplckRlbGVnYXRlPEVudj47XG4gIGFydGlmYWN0czogSXRlcmF0aW9uQXJ0aWZhY3RzO1xuICBlbnY6IEVudjtcbn1cblxuZW51bSBQaGFzZSB7XG4gIEFwcGVuZCxcbiAgUHJ1bmUsXG4gIERvbmUsXG59XG5cbmV4cG9ydCBjb25zdCBFTkQgPSAnRU5EIFsyNjAwYWJkZi04ODlmLTQ0MDYtYjA1OS1iNDRlY2JhZmE1YzVdJztcblxuZXhwb3J0IGNsYXNzIEl0ZXJhdG9yU3luY2hyb25pemVyPEVudj4ge1xuICBwcml2YXRlIHRhcmdldDogSXRlcmF0b3JTeW5jaHJvbml6ZXJEZWxlZ2F0ZTxFbnY+O1xuICBwcml2YXRlIGl0ZXJhdG9yOiBPcGFxdWVJdGVyYXRvcjtcbiAgcHJpdmF0ZSBjdXJyZW50OiBPcHRpb248TGlzdEl0ZW0+O1xuICBwcml2YXRlIGFydGlmYWN0czogSXRlcmF0aW9uQXJ0aWZhY3RzO1xuICBwcml2YXRlIGVudjogRW52O1xuXG4gIGNvbnN0cnVjdG9yKHsgdGFyZ2V0LCBhcnRpZmFjdHMsIGVudiB9OiBJdGVyYXRvclN5bmNocm9uaXplck9wdGlvbnM8RW52Pikge1xuICAgIHRoaXMudGFyZ2V0ID0gdGFyZ2V0O1xuICAgIHRoaXMuYXJ0aWZhY3RzID0gYXJ0aWZhY3RzO1xuICAgIHRoaXMuaXRlcmF0b3IgPSBhcnRpZmFjdHMuaXRlcmF0ZSgpO1xuICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5oZWFkKCk7XG4gICAgdGhpcy5lbnYgPSBlbnY7XG4gIH1cblxuICBzeW5jKCkge1xuICAgIGxldCBwaGFzZTogUGhhc2UgPSBQaGFzZS5BcHBlbmQ7XG5cbiAgICB3aGlsZSAodHJ1ZSkge1xuICAgICAgc3dpdGNoIChwaGFzZSkge1xuICAgICAgICBjYXNlIFBoYXNlLkFwcGVuZDpcbiAgICAgICAgICBwaGFzZSA9IHRoaXMubmV4dEFwcGVuZCgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFBoYXNlLlBydW5lOlxuICAgICAgICAgIHBoYXNlID0gdGhpcy5uZXh0UHJ1bmUoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBQaGFzZS5Eb25lOlxuICAgICAgICAgIHRoaXMubmV4dERvbmUoKTtcbiAgICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhZHZhbmNlVG9LZXkoa2V5OiB1bmtub3duKSB7XG4gICAgbGV0IHsgY3VycmVudCwgYXJ0aWZhY3RzIH0gPSB0aGlzO1xuXG4gICAgaWYgKGN1cnJlbnQgPT09IG51bGwpIHJldHVybjtcblxuICAgIGxldCBuZXh0ID0gYXJ0aWZhY3RzLmFkdmFuY2VOb2RlKGN1cnJlbnQpO1xuXG4gICAgaWYgKG5leHQua2V5ID09PSBrZXkpIHtcbiAgICAgIHRoaXMuY3VycmVudCA9IGFydGlmYWN0cy5hZHZhbmNlTm9kZShuZXh0KTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsZXQgc2VlayA9IGFydGlmYWN0cy5hZHZhbmNlVG9LZXkoa2V5LCBjdXJyZW50KTtcblxuICAgIGlmIChzZWVrKSB7XG4gICAgICB0aGlzLm1vdmUoc2VlaywgY3VycmVudCk7XG4gICAgICB0aGlzLmN1cnJlbnQgPSBhcnRpZmFjdHMubmV4dE5vZGUoY3VycmVudCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBtb3ZlKGl0ZW06IExpc3RJdGVtLCByZWZlcmVuY2U6IE9wdGlvbjxMaXN0SXRlbT4pIHtcbiAgICBpZiAoaXRlbS5uZXh0ICE9PSByZWZlcmVuY2UpIHtcbiAgICAgIHRoaXMuYXJ0aWZhY3RzLm1vdmUoaXRlbSwgcmVmZXJlbmNlKTtcbiAgICAgIHRoaXMudGFyZ2V0Lm1vdmUodGhpcy5lbnYsIGl0ZW0ua2V5LCBpdGVtLnZhbHVlLCBpdGVtLm1lbW8sIHJlZmVyZW5jZSA/IHJlZmVyZW5jZS5rZXkgOiBFTkQpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgbmV4dEFwcGVuZCgpOiBQaGFzZSB7XG4gICAgbGV0IHsgaXRlcmF0b3IsIGN1cnJlbnQsIGFydGlmYWN0cyB9ID0gdGhpcztcblxuICAgIGxldCBpdGVtID0gaXRlcmF0b3IubmV4dCgpO1xuXG4gICAgaWYgKGl0ZW0gPT09IG51bGwpIHtcbiAgICAgIHJldHVybiB0aGlzLnN0YXJ0UHJ1bmUoKTtcbiAgICB9XG5cbiAgICBsZXQgeyBrZXkgfSA9IGl0ZW07XG5cbiAgICBpZiAoY3VycmVudCAhPT0gbnVsbCAmJiBjdXJyZW50LmtleSA9PT0ga2V5KSB7XG4gICAgICB0aGlzLm5leHRSZXRhaW4oaXRlbSwgY3VycmVudCk7XG4gICAgfSBlbHNlIGlmIChhcnRpZmFjdHMuaGFzKGtleSkpIHtcbiAgICAgIHRoaXMubmV4dE1vdmUoaXRlbSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubmV4dEluc2VydChpdGVtKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUGhhc2UuQXBwZW5kO1xuICB9XG5cbiAgcHJpdmF0ZSBuZXh0UmV0YWluKGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0sIGN1cnJlbnQ6IExpc3RJdGVtKSB7XG4gICAgbGV0IHsgYXJ0aWZhY3RzIH0gPSB0aGlzO1xuXG4gICAgLy8gY3VycmVudCA9IGV4cGVjdChjdXJyZW50LCAnQlVHOiBjdXJyZW50IGlzIGVtcHR5Jyk7XG5cbiAgICBjdXJyZW50LnVwZGF0ZShpdGVtKTtcbiAgICB0aGlzLmN1cnJlbnQgPSBhcnRpZmFjdHMubmV4dE5vZGUoY3VycmVudCk7XG4gICAgdGhpcy50YXJnZXQucmV0YWluKHRoaXMuZW52LCBpdGVtLmtleSwgY3VycmVudC52YWx1ZSwgY3VycmVudC5tZW1vKTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dE1vdmUoaXRlbTogT3BhcXVlSXRlcmF0aW9uSXRlbSkge1xuICAgIGxldCB7IGN1cnJlbnQsIGFydGlmYWN0cyB9ID0gdGhpcztcbiAgICBsZXQgeyBrZXkgfSA9IGl0ZW07XG5cbiAgICBsZXQgZm91bmQgPSBhcnRpZmFjdHMudXBkYXRlKGl0ZW0pO1xuXG4gICAgaWYgKGFydGlmYWN0cy53YXNTZWVuKGtleSkpIHtcbiAgICAgIHRoaXMubW92ZShmb3VuZCwgY3VycmVudCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuYWR2YW5jZVRvS2V5KGtleSk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBuZXh0SW5zZXJ0KGl0ZW06IE9wYXF1ZUl0ZXJhdGlvbkl0ZW0pIHtcbiAgICBsZXQgeyBhcnRpZmFjdHMsIHRhcmdldCwgY3VycmVudCB9ID0gdGhpcztcblxuICAgIGxldCBub2RlID0gYXJ0aWZhY3RzLmluc2VydEJlZm9yZShpdGVtLCBjdXJyZW50KTtcbiAgICB0YXJnZXQuaW5zZXJ0KHRoaXMuZW52LCBub2RlLmtleSwgbm9kZS52YWx1ZSwgbm9kZS5tZW1vLCBjdXJyZW50ID8gY3VycmVudC5rZXkgOiBudWxsKTtcbiAgfVxuXG4gIHByaXZhdGUgc3RhcnRQcnVuZSgpOiBQaGFzZSB7XG4gICAgdGhpcy5jdXJyZW50ID0gdGhpcy5hcnRpZmFjdHMuaGVhZCgpO1xuICAgIHJldHVybiBQaGFzZS5QcnVuZTtcbiAgfVxuXG4gIHByaXZhdGUgbmV4dFBydW5lKCk6IFBoYXNlIHtcbiAgICBsZXQgeyBhcnRpZmFjdHMsIHRhcmdldCwgY3VycmVudCB9ID0gdGhpcztcblxuICAgIGlmIChjdXJyZW50ID09PSBudWxsKSB7XG4gICAgICByZXR1cm4gUGhhc2UuRG9uZTtcbiAgICB9XG5cbiAgICBsZXQgbm9kZSA9IGN1cnJlbnQ7XG4gICAgdGhpcy5jdXJyZW50ID0gYXJ0aWZhY3RzLm5leHROb2RlKG5vZGUpO1xuXG4gICAgaWYgKG5vZGUuc2hvdWxkUmVtb3ZlKCkpIHtcbiAgICAgIGFydGlmYWN0cy5yZW1vdmUobm9kZSk7XG4gICAgICB0YXJnZXQuZGVsZXRlKHRoaXMuZW52LCBub2RlLmtleSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIG5vZGUucmVzZXQoKTtcbiAgICB9XG5cbiAgICByZXR1cm4gUGhhc2UuUHJ1bmU7XG4gIH1cblxuICBwcml2YXRlIG5leHREb25lKCkge1xuICAgIHRoaXMudGFyZ2V0LmRvbmUodGhpcy5lbnYpO1xuICB9XG59XG4iXSwic291cmNlUm9vdCI6IiJ9