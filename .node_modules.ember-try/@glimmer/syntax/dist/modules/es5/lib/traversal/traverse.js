import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
import { deprecate } from '@glimmer/util';
import Path from './path';

function getEnterFunction(handler) {
  if (typeof handler === 'function') {
    return handler;
  } else {
    return handler.enter;
  }
}

function getExitFunction(handler) {
  if (typeof handler === 'function') {
    return undefined;
  } else {
    return handler.exit;
  }
}

function getKeyHandler(handler, key) {
  var keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
  if (keyVisitor === undefined) return;
  var keyHandler = keyVisitor[key];

  if (keyHandler !== undefined) {
    return keyHandler;
  }

  return keyVisitor.All;
}

function getNodeHandler(visitor, nodeType) {
  if (nodeType === 'Template' || nodeType === 'Block') {
    if (visitor.Program) {
      if (false
      /* LOCAL_DEBUG */
      ) {
          false && !false && deprecate("TODO");
        }

      return visitor.Program;
    }
  }

  var handler = visitor[nodeType];

  if (handler !== undefined) {
    return handler;
  }

  return visitor.All;
}

function visitNode(visitor, path) {
  var node = path.node,
      parent = path.parent,
      parentKey = path.parentKey;
  var handler = getNodeHandler(visitor, node.type);
  var enter;
  var exit;

  if (handler !== undefined) {
    enter = getEnterFunction(handler);
    exit = getExitFunction(handler);
  }

  var result;

  if (enter !== undefined) {
    result = enter(node, path);
  }

  if (result !== undefined && result !== null) {
    if (JSON.stringify(node) === JSON.stringify(result)) {
      result = undefined;
    } else if (Array.isArray(result)) {
      visitArray(visitor, result, parent, parentKey);
      return result;
    } else {
      var _path = new Path(result, parent, parentKey);

      return visitNode(visitor, _path) || result;
    }
  }

  if (result === undefined) {
    var keys = visitorKeys[node.type];

    for (var i = 0; i < keys.length; i++) {
      var key = keys[i]; // we know if it has child keys we can widen to a ParentNode

      visitKey(visitor, handler, path, key);
    }

    if (exit !== undefined) {
      result = exit(node, path);
    }
  }

  return result;
}

function get(node, key) {
  return node[key];
}

function set(node, key, value) {
  node[key] = value;
}

function visitKey(visitor, handler, path, key) {
  var node = path.node;
  var value = get(node, key);

  if (!value) {
    return;
  }

  var keyEnter;
  var keyExit;

  if (handler !== undefined) {
    var keyHandler = getKeyHandler(handler, key);

    if (keyHandler !== undefined) {
      keyEnter = getEnterFunction(keyHandler);
      keyExit = getExitFunction(keyHandler);
    }
  }

  if (keyEnter !== undefined) {
    if (keyEnter(node, key) !== undefined) {
      throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
    }
  }

  if (Array.isArray(value)) {
    visitArray(visitor, value, path, key);
  } else {
    var keyPath = new Path(value, path, key);
    var result = visitNode(visitor, keyPath);

    if (result !== undefined) {
      // TODO: dynamically check the results by having a table of
      // expected node types in value space, not just type space
      assignKey(node, key, value, result);
    }
  }

  if (keyExit !== undefined) {
    if (keyExit(node, key) !== undefined) {
      throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
    }
  }
}

function visitArray(visitor, array, parent, parentKey) {
  for (var i = 0; i < array.length; i++) {
    var node = array[i];
    var path = new Path(node, parent, parentKey);
    var result = visitNode(visitor, path);

    if (result !== undefined) {
      i += spliceArray(array, i, result) - 1;
    }
  }
}

function assignKey(node, key, value, result) {
  if (result === null) {
    throw cannotRemoveNode(value, node, key);
  } else if (Array.isArray(result)) {
    if (result.length === 1) {
      set(node, key, result[0]);
    } else {
      if (result.length === 0) {
        throw cannotRemoveNode(value, node, key);
      } else {
        throw cannotReplaceNode(value, node, key);
      }
    }
  } else {
    set(node, key, result);
  }
}

function spliceArray(array, index, result) {
  if (result === null) {
    array.splice(index, 1);
    return 0;
  } else if (Array.isArray(result)) {
    array.splice.apply(array, [index, 1].concat(result));
    return result.length;
  } else {
    array.splice(index, 1, result);
    return 1;
  }
}

export default function traverse(node, visitor) {
  var path = new Path(node);
  visitNode(visitor, path);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQUEsV0FBQSxNQUFBLHVCQUFBO0FBQ0EsU0FBQSxnQkFBQSxFQUFBLGlCQUFBLEVBQUEsb0NBQUEsUUFBQSxVQUFBO0FBTUEsU0FBQSxTQUFBLFFBQUEsZUFBQTtBQUdBLE9BQUEsSUFBQSxNQUFBLFFBQUE7O0FBUUEsU0FBQSxnQkFBQSxDQUFBLE9BQUEsRUFDZ0Q7QUFFOUMsTUFBSSxPQUFBLE9BQUEsS0FBSixVQUFBLEVBQW1DO0FBQ2pDLFdBQUEsT0FBQTtBQURGLEdBQUEsTUFFTztBQUNMLFdBQU8sT0FBTyxDQUFkLEtBQUE7QUFDRDtBQUNGOztBQU1ELFNBQUEsZUFBQSxDQUFBLE9BQUEsRUFDZ0Q7QUFFOUMsTUFBSSxPQUFBLE9BQUEsS0FBSixVQUFBLEVBQW1DO0FBQ2pDLFdBQUEsU0FBQTtBQURGLEdBQUEsTUFFTztBQUNMLFdBQU8sT0FBTyxDQUFkLElBQUE7QUFDRDtBQUNGOztBQUVELFNBQUEsYUFBQSxDQUFBLE9BQUEsRUFBQSxHQUFBLEVBRVE7QUFFTixNQUFJLFVBQVUsR0FBRyxPQUFBLE9BQUEsS0FBQSxVQUFBLEdBQWdDLE9BQU8sQ0FBdkMsSUFBQSxHQUFqQixTQUFBO0FBQ0EsTUFBSSxVQUFVLEtBQWQsU0FBQSxFQUE4QjtBQUU5QixNQUFJLFVBQVUsR0FBRyxVQUFVLENBQTNCLEdBQTJCLENBQTNCOztBQUNBLE1BQUksVUFBVSxLQUFkLFNBQUEsRUFBOEI7QUFDNUIsV0FBQSxVQUFBO0FBQ0Q7O0FBQ0QsU0FBTyxVQUFVLENBQWpCLEdBQUE7QUFDRDs7QUFPRCxTQUFBLGNBQUEsQ0FBQSxPQUFBLEVBQUEsUUFBQSxFQUVxQjtBQUVuQixNQUFJLFFBQVEsS0FBUixVQUFBLElBQTJCLFFBQVEsS0FBdkMsT0FBQSxFQUFxRDtBQUNuRCxRQUFJLE9BQU8sQ0FB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TUFBQSxLQUFKLENBQUEsRUFBeUI7QUFDdkIsY0FBTSxnQkFBZ0IsQ0FBQSxLQUFBLEVBQUEsSUFBQSxFQUF0QixHQUFzQixDQUF0QjtBQURGLE9BQUEsTUFFTztBQUNMLGNBQU0saUJBQWlCLENBQUEsS0FBQSxFQUFBLElBQUEsRUFBdkIsR0FBdUIsQ0FBdkI7QUFDRDtBQUNGO0FBVEksR0FBQSxNQVVBO0FBQ0wsSUFBQSxHQUFHLENBQUEsSUFBQSxFQUFBLEdBQUEsRUFBSCxNQUFHLENBQUg7QUFDRDtBQUNGOztBQUVELFNBQUEsV0FBQSxDQUFBLEtBQUEsRUFBQSxLQUFBLEVBQUEsTUFBQSxFQUEyRjtBQUN6RixNQUFJLE1BQU0sS0FBVixJQUFBLEVBQXFCO0FBQ25CLElBQUEsS0FBSyxDQUFMLE1BQUEsQ0FBQSxLQUFBLEVBQUEsQ0FBQTtBQUNBLFdBQUEsQ0FBQTtBQUZGLEdBQUEsTUFHTyxJQUFJLEtBQUssQ0FBTCxPQUFBLENBQUosTUFBSSxDQUFKLEVBQTJCO0FBQ2hDLElBQUEsS0FBSyxDQUFMLE1BQUEsT0FBQSxLQUFLLEdBQUwsS0FBSyxFQUFMLENBQUssU0FBTCxNQUFLLEVBQUw7QUFDQSxXQUFPLE1BQU0sQ0FBYixNQUFBO0FBRkssR0FBQSxNQUdBO0FBQ0wsSUFBQSxLQUFLLENBQUwsTUFBQSxDQUFBLEtBQUEsRUFBQSxDQUFBLEVBQUEsTUFBQTtBQUNBLFdBQUEsQ0FBQTtBQUNEO0FBQ0Y7O0FBRUQsZUFBYyxTQUFBLFFBQUEsQ0FBQSxJQUFBLEVBQUEsT0FBQSxFQUF1RDtBQUNuRSxNQUFJLElBQUksR0FBRyxJQUFBLElBQUEsQ0FBWCxJQUFXLENBQVg7QUFDQSxFQUFBLFNBQVMsQ0FBQSxPQUFBLEVBQVQsSUFBUyxDQUFUO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgdmlzaXRvcktleXMsIHsgVmlzaXRvcktleXMsIFZpc2l0b3JLZXkgfSBmcm9tICcuLi90eXBlcy92aXNpdG9yLWtleXMnO1xuaW1wb3J0IHtcbiAgY2Fubm90UmVtb3ZlTm9kZSxcbiAgY2Fubm90UmVwbGFjZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldCxcbn0gZnJvbSAnLi9lcnJvcnMnO1xuaW1wb3J0ICogYXMgQVNUIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCB7IGRlcHJlY2F0ZSB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgTE9DQUxfREVCVUcgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBOb2RlSGFuZGxlciwgTm9kZVZpc2l0b3IsIEtleUhhbmRsZXIsIE5vZGVUcmF2ZXJzYWwsIEtleVRyYXZlcnNhbCB9IGZyb20gJy4vdmlzaXRvcic7XG5pbXBvcnQgUGF0aCBmcm9tICcuL3BhdGgnO1xuXG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj5cbik6IE5vZGVIYW5kbGVyPE4+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RW50ZXJGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPiB8IEtleVRyYXZlcnNhbDxOLCBLPlxuKTogTm9kZUhhbmRsZXI8Tj4gfCBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkIHtcbiAgaWYgKHR5cGVvZiBoYW5kbGVyID09PSAnZnVuY3Rpb24nKSB7XG4gICAgcmV0dXJuIGhhbmRsZXI7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGhhbmRsZXIuZW50ZXIgYXMgTm9kZUhhbmRsZXI8Tj4gfCBLZXlIYW5kbGVyPE4sIEs+O1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGU+KGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4pOiBOb2RlSGFuZGxlcjxOPiB8IHVuZGVmaW5lZDtcbmZ1bmN0aW9uIGdldEV4aXRGdW5jdGlvbjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBLZXlIYW5kbGVyPE4sIEs+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+IHwgS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9IGVsc2Uge1xuICAgIHJldHVybiBoYW5kbGVyLmV4aXQgYXMgTm9kZUhhbmRsZXI8Tj4gfCBLZXlIYW5kbGVyPE4sIEs+O1xuICB9XG59XG5cbmZ1bmN0aW9uIGdldEtleUhhbmRsZXI8TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4sXG4gIGtleTogS1xuKTogS2V5VHJhdmVyc2FsPE4sIEs+IHwgS2V5VHJhdmVyc2FsPE4sIFZpc2l0b3JLZXk8Tj4+IHwgdW5kZWZpbmVkIHtcbiAgbGV0IGtleVZpc2l0b3IgPSB0eXBlb2YgaGFuZGxlciAhPT0gJ2Z1bmN0aW9uJyA/IGhhbmRsZXIua2V5cyA6IHVuZGVmaW5lZDtcbiAgaWYgKGtleVZpc2l0b3IgPT09IHVuZGVmaW5lZCkgcmV0dXJuO1xuXG4gIGxldCBrZXlIYW5kbGVyID0ga2V5VmlzaXRvcltrZXldO1xuICBpZiAoa2V5SGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIGtleUhhbmRsZXIgYXMgS2V5VHJhdmVyc2FsPE4sIEs+O1xuICB9XG4gIHJldHVybiBrZXlWaXNpdG9yLkFsbDtcbn1cblxuZnVuY3Rpb24gZ2V0Tm9kZUhhbmRsZXI8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIG5vZGVUeXBlOiBOWyd0eXBlJ11cbik6IE5vZGVUcmF2ZXJzYWw8Tj47XG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcih2aXNpdG9yOiBOb2RlVmlzaXRvciwgbm9kZVR5cGU6ICdBbGwnKTogTm9kZVRyYXZlcnNhbDxBU1QuTm9kZT47XG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcjxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICB2aXNpdG9yOiBOb2RlVmlzaXRvcixcbiAgbm9kZVR5cGU6IE5bJ3R5cGUnXVxuKTogTm9kZVRyYXZlcnNhbDxOPiB8IE5vZGVUcmF2ZXJzYWw8QVNULk5vZGU+IHwgdW5kZWZpbmVkIHtcbiAgaWYgKG5vZGVUeXBlID09PSAnVGVtcGxhdGUnIHx8IG5vZGVUeXBlID09PSAnQmxvY2snKSB7XG4gICAgaWYgKHZpc2l0b3IuUHJvZ3JhbSkge1xuICAgICAgaWYgKExPQ0FMX0RFQlVHKSB7XG4gICAgICAgIGRlcHJlY2F0ZShgVE9ET2ApO1xuICAgICAgfVxuXG4gICAgICByZXR1cm4gdmlzaXRvci5Qcm9ncmFtIGFzIGFueTtcbiAgICB9XG4gIH1cblxuICBsZXQgaGFuZGxlciA9IHZpc2l0b3Jbbm9kZVR5cGVdO1xuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmV0dXJuIChoYW5kbGVyIGFzIHVua25vd24pIGFzIE5vZGVUcmF2ZXJzYWw8Tj47XG4gIH1cbiAgcmV0dXJuIHZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiB2aXNpdE5vZGU8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIHBhdGg6IFBhdGg8Tj5cbik6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkIHtcbiAgbGV0IHsgbm9kZSwgcGFyZW50LCBwYXJlbnRLZXkgfSA9IHBhdGg7XG5cbiAgbGV0IGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gPSBnZXROb2RlSGFuZGxlcih2aXNpdG9yLCBub2RlLnR5cGUpO1xuICBsZXQgZW50ZXI7XG4gIGxldCBleGl0O1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBlbnRlciA9IGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcik7XG4gICAgZXhpdCA9IGdldEV4aXRGdW5jdGlvbihoYW5kbGVyKTtcbiAgfVxuXG4gIGxldCByZXN1bHQ6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkO1xuICBpZiAoZW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlc3VsdCA9IGVudGVyKG5vZGUsIHBhdGgpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCwgcGFyZW50LCBwYXJlbnRLZXkpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGVsc2Uge1xuICAgICAgbGV0IHBhdGggPSBuZXcgUGF0aChyZXN1bHQsIHBhcmVudCwgcGFyZW50S2V5KTtcbiAgICAgIHJldHVybiB2aXNpdE5vZGUodmlzaXRvciwgcGF0aCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGtleSA9IGtleXNbaV0gYXMgVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE47XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIHBhdGgsIGtleSk7XG4gICAgfVxuXG4gICAgaWYgKGV4aXQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgcmVzdWx0ID0gZXhpdChub2RlLCBwYXRoKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcmVzdWx0O1xufVxuXG5mdW5jdGlvbiBnZXQ8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgbm9kZTogTixcbiAga2V5OiBWaXNpdG9yS2V5c1tOWyd0eXBlJ11dICYga2V5b2YgTlxuKTogQVNULk5vZGUgfCBBU1QuTm9kZVtdIHtcbiAgcmV0dXJuIChub2RlW2tleV0gYXMgdW5rbm93bikgYXMgQVNULk5vZGUgfCBBU1QuTm9kZVtdO1xufVxuXG5mdW5jdGlvbiBzZXQ8TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMga2V5b2YgTj4obm9kZTogTiwga2V5OiBLLCB2YWx1ZTogTltLXSk6IHZvaWQge1xuICBub2RlW2tleV0gPSB2YWx1ZTtcbn1cblxuZnVuY3Rpb24gdmlzaXRLZXk8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4sXG4gIHBhdGg6IFBhdGg8Tj4sXG4gIGtleTogVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE5cbikge1xuICBsZXQgeyBub2RlIH0gPSBwYXRoO1xuXG4gIGxldCB2YWx1ZSA9IGdldChub2RlLCBrZXkpO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGtleUVudGVyO1xuICBsZXQga2V5RXhpdDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleUhhbmRsZXIgPSBnZXRLZXlIYW5kbGVyKGhhbmRsZXIsIGtleSk7XG4gICAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAga2V5RW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgICAga2V5RXhpdCA9IGdldEV4aXRGdW5jdGlvbihrZXlIYW5kbGVyKTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChrZXlFbnRlcihub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUsIHBhdGgsIGtleSk7XG4gIH0gZWxzZSB7XG4gICAgbGV0IGtleVBhdGggPSBuZXcgUGF0aCh2YWx1ZSwgcGF0aCwga2V5KTtcbiAgICBsZXQgcmVzdWx0ID0gdmlzaXROb2RlKHZpc2l0b3IsIGtleVBhdGgpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gVE9ETzogZHluYW1pY2FsbHkgY2hlY2sgdGhlIHJlc3VsdHMgYnkgaGF2aW5nIGEgdGFibGUgb2ZcbiAgICAgIC8vIGV4cGVjdGVkIG5vZGUgdHlwZXMgaW4gdmFsdWUgc3BhY2UsIG5vdCBqdXN0IHR5cGUgc3BhY2VcbiAgICAgIGFzc2lnbktleShub2RlLCBrZXksIHZhbHVlLCByZXN1bHQgYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUV4aXQobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheShcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIGFycmF5OiBBU1QuTm9kZVtdLFxuICBwYXJlbnQ6IFBhdGg8QVNULk5vZGU+IHwgbnVsbCxcbiAgcGFyZW50S2V5OiBzdHJpbmcgfCBudWxsXG4pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCBub2RlID0gYXJyYXlbaV07XG4gICAgbGV0IHBhdGggPSBuZXcgUGF0aChub2RlLCBwYXJlbnQsIHBhcmVudEtleSk7XG4gICAgbGV0IHJlc3VsdCA9IHZpc2l0Tm9kZSh2aXNpdG9yLCBwYXRoKTtcbiAgICBpZiAocmVzdWx0ICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGkgKz0gc3BsaWNlQXJyYXkoYXJyYXksIGksIHJlc3VsdCkgLSAxO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NpZ25LZXk8TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIG5vZGU6IE4sXG4gIGtleTogSyxcbiAgdmFsdWU6IEFTVC5Ob2RlLFxuICByZXN1bHQ6IE5bS10gfCBbTltLXV0gfCBudWxsXG4pIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUodmFsdWUsIG5vZGUsIGtleSk7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDEpIHtcbiAgICAgIHNldChub2RlLCBrZXksIHJlc3VsdFswXSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmIChyZXN1bHQubGVuZ3RoID09PSAwKSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlbW92ZU5vZGUodmFsdWUsIG5vZGUsIGtleSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgICAgIH1cbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgc2V0KG5vZGUsIGtleSwgcmVzdWx0KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpY2VBcnJheShhcnJheTogQVNULk5vZGVbXSwgaW5kZXg6IG51bWJlciwgcmVzdWx0OiBBU1QuTm9kZSB8IEFTVC5Ob2RlW10gfCBudWxsKSB7XG4gIGlmIChyZXN1bHQgPT09IG51bGwpIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEpO1xuICAgIHJldHVybiAwO1xuICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocmVzdWx0KSkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgLi4ucmVzdWx0KTtcbiAgICByZXR1cm4gcmVzdWx0Lmxlbmd0aDtcbiAgfSBlbHNlIHtcbiAgICBhcnJheS5zcGxpY2UoaW5kZXgsIDEsIHJlc3VsdCk7XG4gICAgcmV0dXJuIDE7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gdHJhdmVyc2Uobm9kZTogQVNULk5vZGUsIHZpc2l0b3I6IE5vZGVWaXNpdG9yKSB7XG4gIGxldCBwYXRoID0gbmV3IFBhdGgobm9kZSk7XG4gIHZpc2l0Tm9kZSh2aXNpdG9yLCBwYXRoKTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=