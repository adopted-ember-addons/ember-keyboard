import b, { SYNTHETIC } from '../builders';
import { appendChild, parseElementBlockParams } from '../utils';
import { HandlebarsNodeVisitors } from './handlebars-node-visitors';
import SyntaxError from '../errors/syntax-error';
import builders from '../builders';
import traverse from '../traversal/traverse';
import print from '../generation/print';
import Walker from '../traversal/walker';
import { parse, parseWithoutProcessing } from '@handlebars/parser';
import { assign } from '@glimmer/util';
import { EntityParser } from 'simple-html-tokenizer';
export const voidMap = Object.create(null);
let voidTagNames = 'area base br col command embed hr img input keygen link meta param source track wbr';
voidTagNames.split(' ').forEach(tagName => {
  voidMap[tagName] = true;
});
export class TokenizerEventHandlers extends HandlebarsNodeVisitors {
  constructor() {
    super(...arguments);
    this.tagOpenLine = 0;
    this.tagOpenColumn = 0;
  }

  reset() {
    this.currentNode = null;
  } // Comment


  beginComment() {
    this.currentNode = b.comment('');
    this.currentNode.loc = {
      source: null,
      start: b.pos(this.tagOpenLine, this.tagOpenColumn),
      end: null
    };
  }

  appendToCommentData(char) {
    this.currentComment.value += char;
  }

  finishComment() {
    this.currentComment.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
    appendChild(this.currentElement(), this.currentComment);
  } // Data


  beginData() {
    this.currentNode = b.text();
    this.currentNode.loc = {
      source: null,
      start: b.pos(this.tokenizer.line, this.tokenizer.column),
      end: null
    };
  }

  appendToData(char) {
    this.currentData.chars += char;
  }

  finishData() {
    this.currentData.loc.end = b.pos(this.tokenizer.line, this.tokenizer.column);
    appendChild(this.currentElement(), this.currentData);
  } // Tags - basic


  tagOpen() {
    this.tagOpenLine = this.tokenizer.line;
    this.tagOpenColumn = this.tokenizer.column;
  }

  beginStartTag() {
    this.currentNode = {
      type: 'StartTag',
      name: '',
      attributes: [],
      modifiers: [],
      comments: [],
      selfClosing: false,
      loc: SYNTHETIC
    };
  }

  beginEndTag() {
    this.currentNode = {
      type: 'EndTag',
      name: '',
      attributes: [],
      modifiers: [],
      comments: [],
      selfClosing: false,
      loc: SYNTHETIC
    };
  }

  finishTag() {
    let {
      line,
      column
    } = this.tokenizer;
    let tag = this.currentTag;
    tag.loc = b.loc(this.tagOpenLine, this.tagOpenColumn, line, column);

    if (tag.type === 'StartTag') {
      this.finishStartTag();

      if (voidMap[tag.name] || tag.selfClosing) {
        this.finishEndTag(true);
      }
    } else if (tag.type === 'EndTag') {
      this.finishEndTag(false);
    }
  }

  finishStartTag() {
    let {
      name,
      attributes: attrs,
      modifiers,
      comments,
      selfClosing
    } = this.currentStartTag;
    let loc = b.loc(this.tagOpenLine, this.tagOpenColumn);
    let element = b.element({
      name,
      selfClosing
    }, {
      attrs,
      modifiers,
      comments,
      loc
    });
    this.elementStack.push(element);
  }

  finishEndTag(isVoid) {
    let tag = this.currentTag;
    let element = this.elementStack.pop();
    let parent = this.currentElement();
    validateEndTag(tag, element, isVoid);
    element.loc.end.line = this.tokenizer.line;
    element.loc.end.column = this.tokenizer.column;
    parseElementBlockParams(element);
    appendChild(parent, element);
  }

  markTagAsSelfClosing() {
    this.currentTag.selfClosing = true;
  } // Tags - name


  appendToTagName(char) {
    this.currentTag.name += char;
  } // Tags - attributes


  beginAttribute() {
    let tag = this.currentTag;

    if (tag.type === 'EndTag') {
      throw new SyntaxError(`Invalid end tag: closing tag must not have attributes, ` + `in \`${tag.name}\` (on line ${this.tokenizer.line}).`, tag.loc);
    }

    this.currentAttribute = {
      name: '',
      parts: [],
      isQuoted: false,
      isDynamic: false,
      start: b.pos(this.tokenizer.line, this.tokenizer.column),
      valueStartLine: 0,
      valueStartColumn: 0
    };
  }

  appendToAttributeName(char) {
    this.currentAttr.name += char;
  }

  beginAttributeValue(isQuoted) {
    this.currentAttr.isQuoted = isQuoted;
    this.currentAttr.valueStartLine = this.tokenizer.line;
    this.currentAttr.valueStartColumn = this.tokenizer.column;
  }

  appendToAttributeValue(char) {
    let parts = this.currentAttr.parts;
    let lastPart = parts[parts.length - 1];

    if (lastPart && lastPart.type === 'TextNode') {
      lastPart.chars += char; // update end location for each added char

      lastPart.loc.end.line = this.tokenizer.line;
      lastPart.loc.end.column = this.tokenizer.column;
    } else {
      // initially assume the text node is a single char
      let loc = b.loc(this.tokenizer.line, this.tokenizer.column, this.tokenizer.line, this.tokenizer.column); // the tokenizer line/column have already been advanced, correct location info

      if (char === '\n') {
        loc.start.line -= 1;
        loc.start.column = lastPart ? lastPart.loc.end.column : this.currentAttr.valueStartColumn;
      } else {
        loc.start.column -= 1;
      }

      let text = b.text(char, loc);
      parts.push(text);
    }
  }

  finishAttributeValue() {
    let {
      name,
      parts,
      isQuoted,
      isDynamic,
      valueStartLine,
      valueStartColumn
    } = this.currentAttr;
    let value = assembleAttributeValue(parts, isQuoted, isDynamic, this.tokenizer.line);
    value.loc = b.loc(valueStartLine, valueStartColumn, this.tokenizer.line, this.tokenizer.column);
    let loc = b.loc(this.currentAttr.start.line, this.currentAttr.start.column, this.tokenizer.line, this.tokenizer.column);
    let attribute = b.attr(name, value, loc);
    this.currentStartTag.attributes.push(attribute);
  }

  reportSyntaxError(message) {
    throw new SyntaxError(`Syntax error at line ${this.tokenizer.line} col ${this.tokenizer.column}: ${message}`, b.loc(this.tokenizer.line, this.tokenizer.column));
  }

}

function assembleAttributeValue(parts, isQuoted, isDynamic, line) {
  if (isDynamic) {
    if (isQuoted) {
      return assembleConcatenatedValue(parts);
    } else {
      if (parts.length === 1 || parts.length === 2 && parts[1].type === 'TextNode' && parts[1].chars === '/') {
        return parts[0];
      } else {
        throw new SyntaxError(`An unquoted attribute value must be a string or a mustache, ` + `preceeded by whitespace or a '=' character, and ` + `followed by whitespace, a '>' character, or '/>' (on line ${line})`, b.loc(line, 0));
      }
    }
  } else {
    return parts.length > 0 ? parts[0] : b.text('');
  }
}

function assembleConcatenatedValue(parts) {
  for (let i = 0; i < parts.length; i++) {
    let part = parts[i];

    if (part.type !== 'MustacheStatement' && part.type !== 'TextNode') {
      throw new SyntaxError('Unsupported node in quoted attribute value: ' + part['type'], part.loc);
    }
  }

  return b.concat(parts);
}

function validateEndTag(tag, element, selfClosing) {
  let error;

  if (voidMap[tag.name] && !selfClosing) {
    // EngTag is also called by StartTag for void and self-closing tags (i.e.
    // <input> or <br />, so we need to check for that here. Otherwise, we would
    // throw an error for those cases.
    error = 'Invalid end tag ' + formatEndTagInfo(tag) + ' (void elements cannot have end tags).';
  } else if (element.tag === undefined) {
    error = 'Closing tag ' + formatEndTagInfo(tag) + ' without an open tag.';
  } else if (element.tag !== tag.name) {
    error = 'Closing tag ' + formatEndTagInfo(tag) + ' did not match last open tag `' + element.tag + '` (on line ' + element.loc.start.line + ').';
  }

  if (error) {
    throw new SyntaxError(error, element.loc);
  }
}

function formatEndTagInfo(tag) {
  return '`' + tag.name + '` (on line ' + tag.loc.end.line + ')';
}

const syntax = {
  parse: preprocess,
  builders,
  print,
  traverse,
  Walker
};
export function preprocess(html, options = {}) {
  let mode = options.mode || 'precompile';
  let ast;

  if (typeof html === 'object') {
    ast = html;
  } else if (mode === 'codemod') {
    ast = parseWithoutProcessing(html, options.parseOptions);
  } else {
    ast = parse(html, options.parseOptions);
  }

  let entityParser = undefined;

  if (mode === 'codemod') {
    entityParser = new EntityParser({});
  }

  let program = new TokenizerEventHandlers(html, entityParser, mode).acceptTemplate(ast);

  if (options && options.plugins && options.plugins.ast) {
    for (let i = 0, l = options.plugins.ast.length; i < l; i++) {
      let transform = options.plugins.ast[i];
      let env = assign({}, options, {
        syntax
      }, {
        plugins: undefined
      });
      let pluginResult = transform(env);
      traverse(program, pluginResult.visitor);
    }
  }

  return program;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvcGFyc2VyL3Rva2VuaXplci1ldmVudC1oYW5kbGVycy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLENBQVAsSUFBWSxTQUFaLFFBQTZCLGFBQTdCO0FBQ0EsU0FBUyxXQUFULEVBQXNCLHVCQUF0QixRQUFxRCxVQUFyRDtBQUNBLFNBQVMsc0JBQVQsUUFBdUMsNEJBQXZDO0FBR0EsT0FBTyxXQUFQLE1BQXdCLHdCQUF4QjtBQUVBLE9BQU8sUUFBUCxNQUFxQixhQUFyQjtBQUNBLE9BQU8sUUFBUCxNQUFxQix1QkFBckI7QUFDQSxPQUFPLEtBQVAsTUFBa0IscUJBQWxCO0FBQ0EsT0FBTyxNQUFQLE1BQW1CLHFCQUFuQjtBQUNBLFNBQVMsS0FBVCxFQUFnQixzQkFBaEIsUUFBOEMsb0JBQTlDO0FBQ0EsU0FBUyxNQUFULFFBQXVCLGVBQXZCO0FBRUEsU0FBUyxZQUFULFFBQTZCLHVCQUE3QjtBQUVBLE9BQU8sTUFBTSxPQUFPLEdBRWhCLE1BQU0sQ0FBQyxNQUFQLENBQWMsSUFBZCxDQUZHO0FBSVAsSUFBSSxZQUFZLEdBQ2QscUZBREY7QUFFQSxZQUFZLENBQUMsS0FBYixDQUFtQixHQUFuQixFQUF3QixPQUF4QixDQUFpQyxPQUFELElBQVk7QUFDMUMsRUFBQSxPQUFPLENBQUMsT0FBRCxDQUFQLEdBQW1CLElBQW5CO0FBQ0QsQ0FGRDtBQUlBLE9BQU0sTUFBTyxzQkFBUCxTQUFzQyxzQkFBdEMsQ0FBNEQ7QUFBbEUsRUFBQSxXQUFBLEdBQUE7O0FBQ1UsU0FBQSxXQUFBLEdBQWMsQ0FBZDtBQUNBLFNBQUEsYUFBQSxHQUFnQixDQUFoQjtBQXdOVDs7QUF0TkMsRUFBQSxLQUFLLEdBQUE7QUFDSCxTQUFLLFdBQUwsR0FBbUIsSUFBbkI7QUFDRCxHQU4rRCxDQVFoRTs7O0FBRUEsRUFBQSxZQUFZLEdBQUE7QUFDVixTQUFLLFdBQUwsR0FBbUIsQ0FBQyxD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QyxFQUFxRCxjQUFyRCxDQUFvRSxHQUFwRSxDQUFkOztBQUVBLE1BQUksT0FBTyxJQUFJLE9BQU8sQ0FBQyxPQUFuQixJQUE4QixPQUFPLENBQUMsT0FBUixDQUFnQixHQUFsRCxFQUF1RDtBQUNyRCxTQUFLLElBQUksQ0FBQyxHQUFHLENBQVIsRUFBVyxDQUFDLEdBQUcsT0FBTyxDQUFDLE9BQVIsQ0FBZ0IsR0FBaEIsQ0FBb0IsTUFBeEMsRUFBZ0QsQ0FBQyxHQUFHLENBQXBELEVBQXVELENBQUMsRUFBeEQsRUFBNEQ7QUFDMUQsVUFBSSxTQUFTLEdBQUcsT0FBTyxDQUFDLE9BQVIsQ0FBZ0IsR0FBaEIsQ0FBb0IsQ0FBcEIsQ0FBaEI7QUFDQSxVQUFJLEdBQUcsR0FBeUIsTUFBTSxDQUFDLEVBQUQsRUFBSyxPQUFMLEVBQWM7QUFBRSxRQUFBO0FBQUYsT0FBZCxFQUEwQjtBQUFFLFFBQUEsT0FBTyxFQUFFO0FBQVgsT0FBMUIsQ0FBdEM7QUFFQSxVQUFJLFlBQVksR0FBRyxTQUFTLENBQUMsR0FBRCxDQUE1QjtBQUVBLE1BQUEsUUFBUSxDQUFDLE9BQUQsRUFBVSxZQUFZLENBQUMsT0FBdkIsQ0FBUjtBQUNEO0FBQ0Y7O0FBRUQsU0FBTyxPQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgYiwgeyBTWU5USEVUSUMgfSBmcm9tICcuLi9idWlsZGVycyc7XG5pbXBvcnQgeyBhcHBlbmRDaGlsZCwgcGFyc2VFbGVtZW50QmxvY2tQYXJhbXMgfSBmcm9tICcuLi91dGlscyc7XG5pbXBvcnQgeyBIYW5kbGViYXJzTm9kZVZpc2l0b3JzIH0gZnJvbSAnLi9oYW5kbGViYXJzLW5vZGUtdmlzaXRvcnMnO1xuaW1wb3J0ICogYXMgQVNUIGZyb20gJy4uL3R5cGVzL25vZGVzJztcbmltcG9ydCAqIGFzIEhCUyBmcm9tICcuLi90eXBlcy9oYW5kbGViYXJzLWFzdCc7XG5pbXBvcnQgU3ludGF4RXJyb3IgZnJvbSAnLi4vZXJyb3JzL3N5bnRheC1lcnJvcic7XG5pbXBvcnQgeyBUYWcgfSBmcm9tICcuLi9wYXJzZXInO1xuaW1wb3J0IGJ1aWxkZXJzIGZyb20gJy4uL2J1aWxkZXJzJztcbmltcG9ydCB0cmF2ZXJzZSBmcm9tICcuLi90cmF2ZXJzYWwvdHJhdmVyc2UnO1xuaW1wb3J0IHByaW50IGZyb20gJy4uL2dlbmVyYXRpb24vcHJpbnQnO1xuaW1wb3J0IFdhbGtlciBmcm9tICcuLi90cmF2ZXJzYWwvd2Fsa2VyJztcbmltcG9ydCB7IHBhcnNlLCBwYXJzZVdpdGhvdXRQcm9jZXNzaW5nIH0gZnJvbSAnQGhhbmRsZWJhcnMvcGFyc2VyJztcbmltcG9ydCB7IGFzc2lnbiB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHsgTm9kZVZpc2l0b3IgfSBmcm9tICcuLi90cmF2ZXJzYWwvdmlzaXRvcic7XG5pbXBvcnQgeyBFbnRpdHlQYXJzZXIgfSBmcm9tICdzaW1wbGUtaHRtbC10b2tlbml6ZXInO1xuXG5leHBvcnQgY29uc3Qgdm9pZE1hcDoge1xuICBbdGFnTmFtZTogc3RyaW5nXTogYm9vbGVhbjtcbn0gPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG5sZXQgdm9pZFRhZ05hbWVzID1cbiAgJ2FyZWEgYmFzZSBiciBjb2wgY29tbWFuZCBlbWJlZCBociBpbWcgaW5wdXQga2V5Z2VuIGxpbmsgbWV0YSBwYXJhbSBzb3VyY2UgdHJhY2sgd2JyJztcbnZvaWRUYWdOYW1lcy5zcGxpdCgnICcpLmZvckVhY2goKHRhZ05hbWUpID0+IHtcbiAgdm9pZE1hcFt0YWdOYW1lXSA9IHRydWU7XG59KTtcblxuZXhwb3J0IGNsYXNzIFRva2VuaXplckV2ZW50SGFuZGxlcnMgZXh0ZW5kcyBIYW5kbGViYXJzTm9kZVZpc2l0b3JzIHtcbiAgcHJpdmF0ZSB0YWdPcGVuTGluZSA9IDA7XG4gIHByaXZhdGUgdGFnT3BlbkNvbHVtbiA9IDA7XG5cbiAgcmVzZXQoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IG51bGw7XG4gIH1cblxuICAvLyBDb21tZW50XG5cbiAgYmVnaW5Db21tZW50KCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLmNvbW1lbnQoJycpO1xuICAgIHRoaXMuY3VycmVudE5vZGUubG9jID0ge1xuICAgICAgc291cmNlOiBudWxsLFxuICAgICAgc3RhcnQ6IGIucG9zKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiksXG4gICAgICBlbmQ6IChudWxsIGFzIGFueSkgYXMgQVNULlBvc2l0aW9uLFxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0NvbW1lbnREYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudENvbW1lbnQudmFsdWUgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaENvbW1lbnQoKSB7XG4gICAgdGhpcy5jdXJyZW50Q29tbWVudC5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50Q29tbWVudCk7XG4gIH1cblxuICAvLyBEYXRhXG5cbiAgYmVnaW5EYXRhKCkge1xuICAgIHRoaXMuY3VycmVudE5vZGUgPSBiLnRleHQoKTtcbiAgICB0aGlzLmN1cnJlbnROb2RlLmxvYyA9IHtcbiAgICAgIHNvdXJjZTogbnVsbCxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgZW5kOiAobnVsbCBhcyBhbnkpIGFzIEFTVC5Qb3NpdGlvbixcbiAgICB9O1xuICB9XG5cbiAgYXBwZW5kVG9EYXRhKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudERhdGEuY2hhcnMgKz0gY2hhcjtcbiAgfVxuXG4gIGZpbmlzaERhdGEoKSB7XG4gICAgdGhpcy5jdXJyZW50RGF0YS5sb2MuZW5kID0gYi5wb3ModGhpcy50b2tlbml6ZXIubGluZSwgdGhpcy50b2tlbml6ZXIuY29sdW1uKTtcblxuICAgIGFwcGVuZENoaWxkKHRoaXMuY3VycmVudEVsZW1lbnQoKSwgdGhpcy5jdXJyZW50RGF0YSk7XG4gIH1cblxuICAvLyBUYWdzIC0gYmFzaWNcblxuICB0YWdPcGVuKCkge1xuICAgIHRoaXMudGFnT3BlbkxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMudGFnT3BlbkNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGJlZ2luU3RhcnRUYWcoKSB7XG4gICAgdGhpcy5jdXJyZW50Tm9kZSA9IHtcbiAgICAgIHR5cGU6ICdTdGFydFRhZycsXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDLFxuICAgIH07XG4gIH1cblxuICBiZWdpbkVuZFRhZygpIHtcbiAgICB0aGlzLmN1cnJlbnROb2RlID0ge1xuICAgICAgdHlwZTogJ0VuZFRhZycsXG4gICAgICBuYW1lOiAnJyxcbiAgICAgIGF0dHJpYnV0ZXM6IFtdLFxuICAgICAgbW9kaWZpZXJzOiBbXSxcbiAgICAgIGNvbW1lbnRzOiBbXSxcbiAgICAgIHNlbGZDbG9zaW5nOiBmYWxzZSxcbiAgICAgIGxvYzogU1lOVEhFVElDLFxuICAgIH07XG4gIH1cblxuICBmaW5pc2hUYWcoKSB7XG4gICAgbGV0IHsgbGluZSwgY29sdW1uIH0gPSB0aGlzLnRva2VuaXplcjtcblxuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgdGFnLmxvYyA9IGIubG9jKHRoaXMudGFnT3BlbkxpbmUsIHRoaXMudGFnT3BlbkNvbHVtbiwgbGluZSwgY29sdW1uKTtcblxuICAgIGlmICh0YWcudHlwZSA9PT0gJ1N0YXJ0VGFnJykge1xuICAgICAgdGhpcy5maW5pc2hTdGFydFRhZygpO1xuXG4gICAgICBpZiAodm9pZE1hcFt0YWcubmFtZV0gfHwgdGFnLnNlbGZDbG9zaW5nKSB7XG4gICAgICAgIHRoaXMuZmluaXNoRW5kVGFnKHRydWUpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAodGFnLnR5cGUgPT09ICdFbmRUYWcnKSB7XG4gICAgICB0aGlzLmZpbmlzaEVuZFRhZyhmYWxzZSk7XG4gICAgfVxuICB9XG5cbiAgZmluaXNoU3RhcnRUYWcoKSB7XG4gICAgbGV0IHsgbmFtZSwgYXR0cmlidXRlczogYXR0cnMsIG1vZGlmaWVycywgY29tbWVudHMsIHNlbGZDbG9zaW5nIH0gPSB0aGlzLmN1cnJlbnRTdGFydFRhZztcbiAgICBsZXQgbG9jID0gYi5sb2ModGhpcy50YWdPcGVuTGluZSwgdGhpcy50YWdPcGVuQ29sdW1uKTtcbiAgICBsZXQgZWxlbWVudCA9IGIuZWxlbWVudCh7IG5hbWUsIHNlbGZDbG9zaW5nIH0sIHsgYXR0cnMsIG1vZGlmaWVycywgY29tbWVudHMsIGxvYyB9KTtcbiAgICB0aGlzLmVsZW1lbnRTdGFjay5wdXNoKGVsZW1lbnQpO1xuICB9XG5cbiAgZmluaXNoRW5kVGFnKGlzVm9pZDogYm9vbGVhbikge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG5cbiAgICBsZXQgZWxlbWVudCA9IHRoaXMuZWxlbWVudFN0YWNrLnBvcCgpIGFzIEFTVC5FbGVtZW50Tm9kZTtcbiAgICBsZXQgcGFyZW50ID0gdGhpcy5jdXJyZW50RWxlbWVudCgpO1xuXG4gICAgdmFsaWRhdGVFbmRUYWcodGFnLCBlbGVtZW50LCBpc1ZvaWQpO1xuXG4gICAgZWxlbWVudC5sb2MuZW5kLmxpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIGVsZW1lbnQubG9jLmVuZC5jb2x1bW4gPSB0aGlzLnRva2VuaXplci5jb2x1bW47XG5cbiAgICBwYXJzZUVsZW1lbnRCbG9ja1BhcmFtcyhlbGVtZW50KTtcbiAgICBhcHBlbmRDaGlsZChwYXJlbnQsIGVsZW1lbnQpO1xuICB9XG5cbiAgbWFya1RhZ0FzU2VsZkNsb3NpbmcoKSB7XG4gICAgdGhpcy5jdXJyZW50VGFnLnNlbGZDbG9zaW5nID0gdHJ1ZTtcbiAgfVxuXG4gIC8vIFRhZ3MgLSBuYW1lXG5cbiAgYXBwZW5kVG9UYWdOYW1lKGNoYXI6IHN0cmluZykge1xuICAgIHRoaXMuY3VycmVudFRhZy5uYW1lICs9IGNoYXI7XG4gIH1cblxuICAvLyBUYWdzIC0gYXR0cmlidXRlc1xuXG4gIGJlZ2luQXR0cmlidXRlKCkge1xuICAgIGxldCB0YWcgPSB0aGlzLmN1cnJlbnRUYWc7XG4gICAgaWYgKHRhZy50eXBlID09PSAnRW5kVGFnJykge1xuICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICBgSW52YWxpZCBlbmQgdGFnOiBjbG9zaW5nIHRhZyBtdXN0IG5vdCBoYXZlIGF0dHJpYnV0ZXMsIGAgK1xuICAgICAgICAgIGBpbiBcXGAke3RhZy5uYW1lfVxcYCAob24gbGluZSAke3RoaXMudG9rZW5pemVyLmxpbmV9KS5gLFxuICAgICAgICB0YWcubG9jXG4gICAgICApO1xuICAgIH1cblxuICAgIHRoaXMuY3VycmVudEF0dHJpYnV0ZSA9IHtcbiAgICAgIG5hbWU6ICcnLFxuICAgICAgcGFydHM6IFtdLFxuICAgICAgaXNRdW90ZWQ6IGZhbHNlLFxuICAgICAgaXNEeW5hbWljOiBmYWxzZSxcbiAgICAgIHN0YXJ0OiBiLnBvcyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pLFxuICAgICAgdmFsdWVTdGFydExpbmU6IDAsXG4gICAgICB2YWx1ZVN0YXJ0Q29sdW1uOiAwLFxuICAgIH07XG4gIH1cblxuICBhcHBlbmRUb0F0dHJpYnV0ZU5hbWUoY2hhcjogc3RyaW5nKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5uYW1lICs9IGNoYXI7XG4gIH1cblxuICBiZWdpbkF0dHJpYnV0ZVZhbHVlKGlzUXVvdGVkOiBib29sZWFuKSB7XG4gICAgdGhpcy5jdXJyZW50QXR0ci5pc1F1b3RlZCA9IGlzUXVvdGVkO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydExpbmUgPSB0aGlzLnRva2VuaXplci5saW5lO1xuICAgIHRoaXMuY3VycmVudEF0dHIudmFsdWVTdGFydENvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgfVxuXG4gIGFwcGVuZFRvQXR0cmlidXRlVmFsdWUoY2hhcjogc3RyaW5nKSB7XG4gICAgbGV0IHBhcnRzID0gdGhpcy5jdXJyZW50QXR0ci5wYXJ0cztcbiAgICBsZXQgbGFzdFBhcnQgPSBwYXJ0c1twYXJ0cy5sZW5ndGggLSAxXTtcblxuICAgIGlmIChsYXN0UGFydCAmJiBsYXN0UGFydC50eXBlID09PSAnVGV4dE5vZGUnKSB7XG4gICAgICBsYXN0UGFydC5jaGFycyArPSBjaGFyO1xuXG4gICAgICAvLyB1cGRhdGUgZW5kIGxvY2F0aW9uIGZvciBlYWNoIGFkZGVkIGNoYXJcbiAgICAgIGxhc3RQYXJ0LmxvYy5lbmQubGluZSA9IHRoaXMudG9rZW5pemVyLmxpbmU7XG4gICAgICBsYXN0UGFydC5sb2MuZW5kLmNvbHVtbiA9IHRoaXMudG9rZW5pemVyLmNvbHVtbjtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gaW5pdGlhbGx5IGFzc3VtZSB0aGUgdGV4dCBub2RlIGlzIGEgc2luZ2xlIGNoYXJcbiAgICAgIGxldCBsb2MgPSBiLmxvYyhcbiAgICAgICAgdGhpcy50b2tlbml6ZXIubGluZSxcbiAgICAgICAgdGhpcy50b2tlbml6ZXIuY29sdW1uLFxuICAgICAgICB0aGlzLnRva2VuaXplci5saW5lLFxuICAgICAgICB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICAgICk7XG5cbiAgICAgIC8vIHRoZSB0b2tlbml6ZXIgbGluZS9jb2x1bW4gaGF2ZSBhbHJlYWR5IGJlZW4gYWR2YW5jZWQsIGNvcnJlY3QgbG9jYXRpb24gaW5mb1xuICAgICAgaWYgKGNoYXIgPT09ICdcXG4nKSB7XG4gICAgICAgIGxvYy5zdGFydC5saW5lIC09IDE7XG4gICAgICAgIGxvYy5zdGFydC5jb2x1bW4gPSBsYXN0UGFydCA/IGxhc3RQYXJ0LmxvYy5lbmQuY29sdW1uIDogdGhpcy5jdXJyZW50QXR0ci52YWx1ZVN0YXJ0Q29sdW1uO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9jLnN0YXJ0LmNvbHVtbiAtPSAxO1xuICAgICAgfVxuXG4gICAgICBsZXQgdGV4dCA9IGIudGV4dChjaGFyLCBsb2MpO1xuICAgICAgcGFydHMucHVzaCh0ZXh0KTtcbiAgICB9XG4gIH1cblxuICBmaW5pc2hBdHRyaWJ1dGVWYWx1ZSgpIHtcbiAgICBsZXQgeyBuYW1lLCBwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4gfSA9IHRoaXMuY3VycmVudEF0dHI7XG4gICAgbGV0IHZhbHVlID0gYXNzZW1ibGVBdHRyaWJ1dGVWYWx1ZShwYXJ0cywgaXNRdW90ZWQsIGlzRHluYW1pYywgdGhpcy50b2tlbml6ZXIubGluZSk7XG4gICAgdmFsdWUubG9jID0gYi5sb2ModmFsdWVTdGFydExpbmUsIHZhbHVlU3RhcnRDb2x1bW4sIHRoaXMudG9rZW5pemVyLmxpbmUsIHRoaXMudG9rZW5pemVyLmNvbHVtbik7XG5cbiAgICBsZXQgbG9jID0gYi5sb2MoXG4gICAgICB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmxpbmUsXG4gICAgICB0aGlzLmN1cnJlbnRBdHRyLnN0YXJ0LmNvbHVtbixcbiAgICAgIHRoaXMudG9rZW5pemVyLmxpbmUsXG4gICAgICB0aGlzLnRva2VuaXplci5jb2x1bW5cbiAgICApO1xuXG4gICAgbGV0IGF0dHJpYnV0ZSA9IGIuYXR0cihuYW1lLCB2YWx1ZSwgbG9jKTtcblxuICAgIHRoaXMuY3VycmVudFN0YXJ0VGFnLmF0dHJpYnV0ZXMucHVzaChhdHRyaWJ1dGUpO1xuICB9XG5cbiAgcmVwb3J0U3ludGF4RXJyb3IobWVzc2FnZTogc3RyaW5nKSB7XG4gICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgYFN5bnRheCBlcnJvciBhdCBsaW5lICR7dGhpcy50b2tlbml6ZXIubGluZX0gY29sICR7dGhpcy50b2tlbml6ZXIuY29sdW1ufTogJHttZXNzYWdlfWAsXG4gICAgICBiLmxvYyh0aGlzLnRva2VuaXplci5saW5lLCB0aGlzLnRva2VuaXplci5jb2x1bW4pXG4gICAgKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhc3NlbWJsZUF0dHJpYnV0ZVZhbHVlKFxuICBwYXJ0czogKEFTVC5NdXN0YWNoZVN0YXRlbWVudCB8IEFTVC5UZXh0Tm9kZSlbXSxcbiAgaXNRdW90ZWQ6IGJvb2xlYW4sXG4gIGlzRHluYW1pYzogYm9vbGVhbixcbiAgbGluZTogbnVtYmVyXG4pIHtcbiAgaWYgKGlzRHluYW1pYykge1xuICAgIGlmIChpc1F1b3RlZCkge1xuICAgICAgcmV0dXJuIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHMpO1xuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoXG4gICAgICAgIHBhcnRzLmxlbmd0aCA9PT0gMSB8fFxuICAgICAgICAocGFydHMubGVuZ3RoID09PSAyICYmXG4gICAgICAgICAgcGFydHNbMV0udHlwZSA9PT0gJ1RleHROb2RlJyAmJlxuICAgICAgICAgIChwYXJ0c1sxXSBhcyBBU1QuVGV4dE5vZGUpLmNoYXJzID09PSAnLycpXG4gICAgICApIHtcbiAgICAgICAgcmV0dXJuIHBhcnRzWzBdO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IFN5bnRheEVycm9yKFxuICAgICAgICAgIGBBbiB1bnF1b3RlZCBhdHRyaWJ1dGUgdmFsdWUgbXVzdCBiZSBhIHN0cmluZyBvciBhIG11c3RhY2hlLCBgICtcbiAgICAgICAgICAgIGBwcmVjZWVkZWQgYnkgd2hpdGVzcGFjZSBvciBhICc9JyBjaGFyYWN0ZXIsIGFuZCBgICtcbiAgICAgICAgICAgIGBmb2xsb3dlZCBieSB3aGl0ZXNwYWNlLCBhICc+JyBjaGFyYWN0ZXIsIG9yICcvPicgKG9uIGxpbmUgJHtsaW5lfSlgLFxuICAgICAgICAgIGIubG9jKGxpbmUsIDApXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHJldHVybiBwYXJ0cy5sZW5ndGggPiAwID8gcGFydHNbMF0gOiBiLnRleHQoJycpO1xuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2VtYmxlQ29uY2F0ZW5hdGVkVmFsdWUocGFydHM6IChBU1QuTXVzdGFjaGVTdGF0ZW1lbnQgfCBBU1QuVGV4dE5vZGUpW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBwYXJ0cy5sZW5ndGg7IGkrKykge1xuICAgIGxldCBwYXJ0OiBBU1QuQmFzZU5vZGUgPSBwYXJ0c1tpXTtcblxuICAgIGlmIChwYXJ0LnR5cGUgIT09ICdNdXN0YWNoZVN0YXRlbWVudCcgJiYgcGFydC50eXBlICE9PSAnVGV4dE5vZGUnKSB7XG4gICAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoXG4gICAgICAgICdVbnN1cHBvcnRlZCBub2RlIGluIHF1b3RlZCBhdHRyaWJ1dGUgdmFsdWU6ICcgKyBwYXJ0Wyd0eXBlJ10sXG4gICAgICAgIHBhcnQubG9jXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBiLmNvbmNhdChwYXJ0cyk7XG59XG5cbmZ1bmN0aW9uIHZhbGlkYXRlRW5kVGFnKFxuICB0YWc6IFRhZzwnU3RhcnRUYWcnIHwgJ0VuZFRhZyc+LFxuICBlbGVtZW50OiBBU1QuRWxlbWVudE5vZGUsXG4gIHNlbGZDbG9zaW5nOiBib29sZWFuXG4pIHtcbiAgbGV0IGVycm9yO1xuXG4gIGlmICh2b2lkTWFwW3RhZy5uYW1lXSAmJiAhc2VsZkNsb3NpbmcpIHtcbiAgICAvLyBFbmdUYWcgaXMgYWxzbyBjYWxsZWQgYnkgU3RhcnRUYWcgZm9yIHZvaWQgYW5kIHNlbGYtY2xvc2luZyB0YWdzIChpLmUuXG4gICAgLy8gPGlucHV0PiBvciA8YnIgLz4sIHNvIHdlIG5lZWQgdG8gY2hlY2sgZm9yIHRoYXQgaGVyZS4gT3RoZXJ3aXNlLCB3ZSB3b3VsZFxuICAgIC8vIHRocm93IGFuIGVycm9yIGZvciB0aG9zZSBjYXNlcy5cbiAgICBlcnJvciA9ICdJbnZhbGlkIGVuZCB0YWcgJyArIGZvcm1hdEVuZFRhZ0luZm8odGFnKSArICcgKHZvaWQgZWxlbWVudHMgY2Fubm90IGhhdmUgZW5kIHRhZ3MpLic7XG4gIH0gZWxzZSBpZiAoZWxlbWVudC50YWcgPT09IHVuZGVmaW5lZCkge1xuICAgIGVycm9yID0gJ0Nsb3NpbmcgdGFnICcgKyBmb3JtYXRFbmRUYWdJbmZvKHRhZykgKyAnIHdpdGhvdXQgYW4gb3BlbiB0YWcuJztcbiAgfSBlbHNlIGlmIChlbGVtZW50LnRhZyAhPT0gdGFnLm5hbWUpIHtcbiAgICBlcnJvciA9XG4gICAgICAnQ2xvc2luZyB0YWcgJyArXG4gICAgICBmb3JtYXRFbmRUYWdJbmZvKHRhZykgK1xuICAgICAgJyBkaWQgbm90IG1hdGNoIGxhc3Qgb3BlbiB0YWcgYCcgK1xuICAgICAgZWxlbWVudC50YWcgK1xuICAgICAgJ2AgKG9uIGxpbmUgJyArXG4gICAgICBlbGVtZW50LmxvYy5zdGFydC5saW5lICtcbiAgICAgICcpLic7XG4gIH1cblxuICBpZiAoZXJyb3IpIHtcbiAgICB0aHJvdyBuZXcgU3ludGF4RXJyb3IoZXJyb3IsIGVsZW1lbnQubG9jKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBmb3JtYXRFbmRUYWdJbmZvKHRhZzogVGFnPCdTdGFydFRhZycgfCAnRW5kVGFnJz4pIHtcbiAgcmV0dXJuICdgJyArIHRhZy5uYW1lICsgJ2AgKG9uIGxpbmUgJyArIHRhZy5sb2MuZW5kLmxpbmUgKyAnKSc7XG59XG5cbi8qKlxuICBBU1RQbHVnaW5zIGNhbiBtYWtlIGNoYW5nZXMgdG8gdGhlIEdsaW1tZXIgdGVtcGxhdGUgQVNUIGJlZm9yZVxuICBjb21waWxhdGlvbiBiZWdpbnMuXG4qL1xuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW5CdWlsZGVyIHtcbiAgKGVudjogQVNUUGx1Z2luRW52aXJvbm1lbnQpOiBBU1RQbHVnaW47XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgQVNUUGx1Z2luIHtcbiAgbmFtZTogc3RyaW5nO1xuICB2aXNpdG9yOiBOb2RlVmlzaXRvcjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBBU1RQbHVnaW5FbnZpcm9ubWVudCB7XG4gIG1ldGE/OiBvYmplY3Q7XG4gIHN5bnRheDogU3ludGF4O1xufVxuaW50ZXJmYWNlIEhhbmRsZWJhcnNQYXJzZU9wdGlvbnMge1xuICBzcmNOYW1lPzogc3RyaW5nO1xuICBpZ25vcmVTdGFuZGFsb25lPzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IGludGVyZmFjZSBQcmVwcm9jZXNzT3B0aW9ucyB7XG4gIG1ldGE/OiB7XG4gICAgbW9kdWxlTmFtZT86IHN0cmluZztcbiAgfTtcbiAgcGx1Z2lucz86IHtcbiAgICBhc3Q/OiBBU1RQbHVnaW5CdWlsZGVyW107XG4gIH07XG4gIHBhcnNlT3B0aW9ucz86IEhhbmRsZWJhcnNQYXJzZU9wdGlvbnM7XG5cbiAgLyoqXG4gICAgVXNlZnVsIGZvciBzcGVjaWZ5aW5nIGEgZ3JvdXAgb2Ygb3B0aW9ucyB0b2dldGhlci5cblxuICAgIFdoZW4gYCdjb2RlbW9kJ2Agd2UgZGlzYWJsZSBhbGwgd2hpdGVzcGFjZSBjb250cm9sIGluIGhhbmRsZWJhcnNcbiAgICAodG8gcHJlc2VydmUgYXMgbXVjaCBhcyBwb3NzaWJsZSkgYW5kIHdlIGFsc28gYXZvaWQgYW55XG4gICAgZXNjYXBpbmcvdW5lc2NhcGluZyBvZiBIVE1MIGVudGl0eSBjb2Rlcy5cbiAgICovXG4gIG1vZGU/OiAnY29kZW1vZCcgfCAncHJlY29tcGlsZSc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgU3ludGF4IHtcbiAgcGFyc2U6IHR5cGVvZiBwcmVwcm9jZXNzO1xuICBidWlsZGVyczogdHlwZW9mIGJ1aWxkZXJzO1xuICBwcmludDogdHlwZW9mIHByaW50O1xuICB0cmF2ZXJzZTogdHlwZW9mIHRyYXZlcnNlO1xuICBXYWxrZXI6IHR5cGVvZiBXYWxrZXI7XG59XG5cbmNvbnN0IHN5bnRheDogU3ludGF4ID0ge1xuICBwYXJzZTogcHJlcHJvY2VzcyxcbiAgYnVpbGRlcnMsXG4gIHByaW50LFxuICB0cmF2ZXJzZSxcbiAgV2Fsa2VyLFxufTtcblxuZXhwb3J0IGZ1bmN0aW9uIHByZXByb2Nlc3MoaHRtbDogc3RyaW5nLCBvcHRpb25zOiBQcmVwcm9jZXNzT3B0aW9ucyA9IHt9KTogQVNULlRlbXBsYXRlIHtcbiAgbGV0IG1vZGUgPSBvcHRpb25zLm1vZGUgfHwgJ3ByZWNvbXBpbGUnO1xuXG4gIGxldCBhc3Q6IEhCUy5Qcm9ncmFtO1xuICBpZiAodHlwZW9mIGh0bWwgPT09ICdvYmplY3QnKSB7XG4gICAgYXN0ID0gaHRtbDtcbiAgfSBlbHNlIGlmIChtb2RlID09PSAnY29kZW1vZCcpIHtcbiAgICBhc3QgPSBwYXJzZVdpdGhvdXRQcm9jZXNzaW5nKGh0bWwsIG9wdGlvbnMucGFyc2VPcHRpb25zKSBhcyBIQlMuUHJvZ3JhbTtcbiAgfSBlbHNlIHtcbiAgICBhc3QgPSBwYXJzZShodG1sLCBvcHRpb25zLnBhcnNlT3B0aW9ucykgYXMgSEJTLlByb2dyYW07XG4gIH1cblxuICBsZXQgZW50aXR5UGFyc2VyID0gdW5kZWZpbmVkO1xuICBpZiAobW9kZSA9PT0gJ2NvZGVtb2QnKSB7XG4gICAgZW50aXR5UGFyc2VyID0gbmV3IEVudGl0eVBhcnNlcih7fSk7XG4gIH1cblxuICBsZXQgcHJvZ3JhbSA9IG5ldyBUb2tlbml6ZXJFdmVudEhhbmRsZXJzKGh0bWwsIGVudGl0eVBhcnNlciwgbW9kZSkuYWNjZXB0VGVtcGxhdGUoYXN0KTtcblxuICBpZiAob3B0aW9ucyAmJiBvcHRpb25zLnBsdWdpbnMgJiYgb3B0aW9ucy5wbHVnaW5zLmFzdCkge1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3B0aW9ucy5wbHVnaW5zLmFzdC5sZW5ndGg7IGkgPCBsOyBpKyspIHtcbiAgICAgIGxldCB0cmFuc2Zvcm0gPSBvcHRpb25zLnBsdWdpbnMuYXN0W2ldO1xuICAgICAgbGV0IGVudjogQVNUUGx1Z2luRW52aXJvbm1lbnQgPSBhc3NpZ24oe30sIG9wdGlvbnMsIHsgc3ludGF4IH0sIHsgcGx1Z2luczogdW5kZWZpbmVkIH0pO1xuXG4gICAgICBsZXQgcGx1Z2luUmVzdWx0ID0gdHJhbnNmb3JtKGVudik7XG5cbiAgICAgIHRyYXZlcnNlKHByb2dyYW0sIHBsdWdpblJlc3VsdC52aXNpdG9yKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gcHJvZ3JhbTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=