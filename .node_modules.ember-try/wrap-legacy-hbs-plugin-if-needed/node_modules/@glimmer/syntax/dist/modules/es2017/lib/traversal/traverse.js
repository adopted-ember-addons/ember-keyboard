import visitorKeys from '../types/visitor-keys';
import { cannotRemoveNode, cannotReplaceNode, cannotReplaceOrRemoveInKeyHandlerYet } from './errors';
import { deprecate } from '@glimmer/util';

function getEnterFunction(handler) {
    if (typeof handler === 'function') {
        return handler;
    } else {
        return handler.enter;
    }
}
function getExitFunction(handler) {
    if (typeof handler === 'function') {
        return undefined;
    } else {
        return handler.exit;
    }
}
function getKeyHandler(handler, key) {
    let keyVisitor = typeof handler !== 'function' ? handler.keys : undefined;
    if (keyVisitor === undefined) return;
    let keyHandler = keyVisitor[key];
    if (keyHandler !== undefined) {
        return keyHandler;
    }
    return keyVisitor.All;
}
function getNodeHandler(visitor, nodeType) {
    if (nodeType === 'Template' || nodeType === 'Block') {
        if (visitor.Program) {
            if (false) {
                (false && !(false) && deprecate(`TODO`));
            }
            return visitor.Program;
        }
    }
    let handler = visitor[nodeType];
    if (handler !== undefined) {
        return handler;
    }
    return visitor.All;
}
function visitNode(visitor, node) {
    let handler = getNodeHandler(visitor, node.type);
    let enter;
    let exit;
    if (handler !== undefined) {
        enter = getEnterFunction(handler);
        exit = getExitFunction(handler);
    }
    let result;
    if (enter !== undefined) {
        result = enter(node);
    }
    if (result !== undefined && result !== null) {
        if (JSON.stringify(node) === JSON.stringify(result)) {
            result = undefined;
        } else if (Array.isArray(result)) {
            visitArray(visitor, result);
            return result;
        } else {
            return visitNode(visitor, result) || result;
        }
    }
    if (result === undefined) {
        let keys = visitorKeys[node.type];
        for (let i = 0; i < keys.length; i++) {
            let key = keys[i];
            // we know if it has child keys we can widen to a ParentNode
            visitKey(visitor, handler, node, key);
        }
        if (exit !== undefined) {
            result = exit(node);
        }
    }
    return result;
}
function get(node, key) {
    return node[key];
}
function set(node, key, value) {
    node[key] = value;
}
function visitKey(visitor, handler, node, key) {
    let value = get(node, key);
    if (!value) {
        return;
    }
    let keyEnter;
    let keyExit;
    if (handler !== undefined) {
        let keyHandler = getKeyHandler(handler, key);
        if (keyHandler !== undefined) {
            keyEnter = getEnterFunction(keyHandler);
            keyExit = getExitFunction(keyHandler);
        }
    }
    if (keyEnter !== undefined) {
        if (keyEnter(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
    if (Array.isArray(value)) {
        visitArray(visitor, value);
    } else {
        let result = visitNode(visitor, value);
        if (result !== undefined) {
            // TODO: dynamically check the results by having a table of
            // expected node types in value space, not just type space
            assignKey(node, key, value, result);
        }
    }
    if (keyExit !== undefined) {
        if (keyExit(node, key) !== undefined) {
            throw cannotReplaceOrRemoveInKeyHandlerYet(node, key);
        }
    }
}
function visitArray(visitor, array) {
    for (let i = 0; i < array.length; i++) {
        let result = visitNode(visitor, array[i]);
        if (result !== undefined) {
            i += spliceArray(array, i, result) - 1;
        }
    }
}
function assignKey(node, key, value, result) {
    if (result === null) {
        throw cannotRemoveNode(value, node, key);
    } else if (Array.isArray(result)) {
        if (result.length === 1) {
            set(node, key, result[0]);
        } else {
            if (result.length === 0) {
                throw cannotRemoveNode(value, node, key);
            } else {
                throw cannotReplaceNode(value, node, key);
            }
        }
    } else {
        set(node, key, result);
    }
}
function spliceArray(array, index, result) {
    if (result === null) {
        array.splice(index, 1);
        return 0;
    } else if (Array.isArray(result)) {
        array.splice(index, 1, ...result);
        return result.length;
    } else {
        array.splice(index, 1, result);
        return 1;
    }
}
export default function traverse(node, visitor) {
    visitNode(visitor, node);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3N5bnRheC9saWIvdHJhdmVyc2FsL3RyYXZlcnNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sV0FBUCxNQUFxRCx1QkFBckQ7QUFDQSxTQUNFLGdCQURGLEVBRUUsaUJBRkYsRUFHRSxvQ0FIRixRQUlPLFVBSlA7QUFNQSxTQUFTLFNBQVQsUUFBMEIsZUFBMUI7O0FBVUEsU0FBUyxnQkFBVCxDQUNFLE9BREYsRUFDZ0Q7QUFFOUMsUUFBSSxPQUFPLE9BQVAsS0FBbUIsVUFBdkIsRUFBbUM7QUFDakMsZUFBTyxPQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsZUFBTyxRQUFRLEtBQWY7QUFDRDtBQUNGO0FBTUQsU0FBUyxlQUFULENBQ0UsT0FERixFQUNnRDtBQUU5QyxRQUFJLE9BQU8sT0FBUCxLQUFtQixVQUF2QixFQUFtQztBQUNqQyxlQUFPLFNBQVA7QUFDRCxLQUZELE1BRU87QUFDTCxlQUFPLFFBQVEsSUFBZjtBQUNEO0FBQ0Y7QUFFRCxTQUFTLGFBQVQsQ0FDRSxPQURGLEVBRUUsR0FGRixFQUVRO0FBRU4sUUFBSSxhQUFhLE9BQU8sT0FBUCxLQUFtQixVQUFuQixHQUFnQyxRQUFRLElBQXhDLEdBQStDLFNBQWhFO0FBQ0EsUUFBSSxlQUFlLFNBQW5CLEVBQThCO0FBRTlCLFFBQUksYUFBYSxXQUFXLEdBQVgsQ0FBakI7QUFDQSxRQUFJLGVBQWUsU0FBbkIsRUFBOEI7QUFDNUIsZUFBTyxVQUFQO0FBQ0Q7QUFDRCxXQUFPLFdBQVcsR0FBbEI7QUFDRDtBQU9ELFNBQVMsY0FBVCxDQUNFLE9BREYsRUFFRSxRQUZGLEVBRXFCO0FBRW5CLFFBQUksYUFBYSxVQUFiLElBQTJCLGFBQWEsT0FBNUMsRUFBcUQ7QUFDbkQsWUFBSSxRQUFRLE9BQVosRUFBcUI7QUFDbkIsdUJBQWE7QUFBQSxzQ0FDWCxVQUFVLE1BQVYsQ0FEVztBQUVaO0FBRUQsbUJBQU8sUUFBUSxPQUFmO0FB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O0FBQ0YsS0FWTSxNQVVBO0FBQ0wsWUFBSSxJQUFKLEVBQVUsR0FBVixFQUFlLE1BQWY7QUFDRDtBQUNGO0FBRUQsU0FBUyxXQUFULENBQXFCLEtBQXJCLEVBQXdDLEtBQXhDLEVBQXVELE1BQXZELEVBQTJGO0FBQ3pGLFFBQUksV0FBVyxJQUFmLEVBQXFCO0FBQ25CLGNBQU0sTUFBTixDQUFhLEtBQWIsRUFBb0IsQ0FBcEI7QUFDQSxlQUFPLENBQVA7QUFDRCxLQUhELE1BR08sSUFBSSxNQUFNLE9BQU4sQ0FBYyxNQUFkLENBQUosRUFBMkI7QUFDaEMsY0FBTSxNQUFOLENBQWEsS0FBYixFQUFvQixDQUFwQixFQUF1QixHQUFHLE1BQTFCO0FBQ0EsZUFBTyxPQUFPLE1BQWQ7QUFDRCxLQUhNLE1BR0E7QUFDTCxjQUFNLE1BQU4sQ0FBYSxLQUFiLEVBQW9CLENBQXBCLEVBQXVCLE1BQXZCO0FBQ0EsZUFBTyxDQUFQO0FBQ0Q7QUFDRjtBQUVELGVBQWMsU0FBVSxRQUFWLENBQW1CLElBQW5CLEVBQW1DLE9BQW5DLEVBQXVEO0FBQ25FLGNBQVUsT0FBVixFQUFtQixJQUFuQjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHZpc2l0b3JLZXlzLCB7IFZpc2l0b3JLZXlzLCBWaXNpdG9yS2V5IH0gZnJvbSAnLi4vdHlwZXMvdmlzaXRvci1rZXlzJztcbmltcG9ydCB7XG4gIGNhbm5vdFJlbW92ZU5vZGUsXG4gIGNhbm5vdFJlcGxhY2VOb2RlLFxuICBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQsXG59IGZyb20gJy4vZXJyb3JzJztcbmltcG9ydCAqIGFzIEFTVCBmcm9tICcuLi90eXBlcy9ub2Rlcyc7XG5pbXBvcnQgeyBkZXByZWNhdGUgfSBmcm9tICdAZ2xpbW1lci91dGlsJztcbmltcG9ydCB7IERFVk1PREUgfSBmcm9tICdAZ2xpbW1lci9sb2NhbC1kZWJ1Zy1mbGFncyc7XG5pbXBvcnQgeyBOb2RlSGFuZGxlciwgTm9kZVZpc2l0b3IsIEtleUhhbmRsZXIsIE5vZGVUcmF2ZXJzYWwsIEtleVRyYXZlcnNhbCB9IGZyb20gJy4vdmlzaXRvcic7XG5cbmZ1bmN0aW9uIGdldEVudGVyRnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPlxuKTogTm9kZUhhbmRsZXI8Tj4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFbnRlckZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBOb2RlVHJhdmVyc2FsPE4+IHwgS2V5VHJhdmVyc2FsPE4sIEs+XG4pOiBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQge1xuICBpZiAodHlwZW9mIGhhbmRsZXIgPT09ICdmdW5jdGlvbicpIHtcbiAgICByZXR1cm4gaGFuZGxlcjtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gaGFuZGxlci5lbnRlciBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZT4oaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPik6IE5vZGVIYW5kbGVyPE4+IHwgdW5kZWZpbmVkO1xuZnVuY3Rpb24gZ2V0RXhpdEZ1bmN0aW9uPE4gZXh0ZW5kcyBBU1QuTm9kZSwgSyBleHRlbmRzIFZpc2l0b3JLZXk8Tj4+KFxuICBoYW5kbGVyOiBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IEtleUhhbmRsZXI8TiwgSz4gfCB1bmRlZmluZWQ7XG5mdW5jdGlvbiBnZXRFeGl0RnVuY3Rpb248TiBleHRlbmRzIEFTVC5Ob2RlLCBLIGV4dGVuZHMgVmlzaXRvcktleTxOPj4oXG4gIGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gfCBLZXlUcmF2ZXJzYWw8TiwgSz5cbik6IE5vZGVIYW5kbGVyPE4+IHwgS2V5SGFuZGxlcjxOLCBLPiB8IHVuZGVmaW5lZCB7XG4gIGlmICh0eXBlb2YgaGFuZGxlciA9PT0gJ2Z1bmN0aW9uJykge1xuICAgIHJldHVybiB1bmRlZmluZWQ7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGhhbmRsZXIuZXhpdCBhcyBOb2RlSGFuZGxlcjxOPiB8IEtleUhhbmRsZXI8TiwgSz47XG4gIH1cbn1cblxuZnVuY3Rpb24gZ2V0S2V5SGFuZGxlcjxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPixcbiAga2V5OiBLXG4pOiBLZXlUcmF2ZXJzYWw8TiwgSz4gfCBLZXlUcmF2ZXJzYWw8TiwgVmlzaXRvcktleTxOPj4gfCB1bmRlZmluZWQge1xuICBsZXQga2V5VmlzaXRvciA9IHR5cGVvZiBoYW5kbGVyICE9PSAnZnVuY3Rpb24nID8gaGFuZGxlci5rZXlzIDogdW5kZWZpbmVkO1xuICBpZiAoa2V5VmlzaXRvciA9PT0gdW5kZWZpbmVkKSByZXR1cm47XG5cbiAgbGV0IGtleUhhbmRsZXIgPSBrZXlWaXNpdG9yW2tleV07XG4gIGlmIChrZXlIYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICByZXR1cm4ga2V5SGFuZGxlciBhcyBLZXlUcmF2ZXJzYWw8TiwgSz47XG4gIH1cbiAgcmV0dXJuIGtleVZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiBnZXROb2RlSGFuZGxlcjxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICB2aXNpdG9yOiBOb2RlVmlzaXRvcixcbiAgbm9kZVR5cGU6IE5bJ3R5cGUnXVxuKTogTm9kZVRyYXZlcnNhbDxOPjtcbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyKHZpc2l0b3I6IE5vZGVWaXNpdG9yLCBub2RlVHlwZTogJ0FsbCcpOiBOb2RlVHJhdmVyc2FsPEFTVC5Ob2RlPjtcbmZ1bmN0aW9uIGdldE5vZGVIYW5kbGVyPE4gZXh0ZW5kcyBBU1QuTm9kZT4oXG4gIHZpc2l0b3I6IE5vZGVWaXNpdG9yLFxuICBub2RlVHlwZTogTlsndHlwZSddXG4pOiBOb2RlVHJhdmVyc2FsPE4+IHwgTm9kZVRyYXZlcnNhbDxBU1QuTm9kZT4gfCB1bmRlZmluZWQge1xuICBpZiAobm9kZVR5cGUgPT09ICdUZW1wbGF0ZScgfHwgbm9kZVR5cGUgPT09ICdCbG9jaycpIHtcbiAgICBpZiAodmlzaXRvci5Qcm9ncmFtKSB7XG4gICAgICBpZiAoREVWTU9ERSkge1xuICAgICAgICBkZXByZWNhdGUoYFRPRE9gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHZpc2l0b3IuUHJvZ3JhbSBhcyBhbnk7XG4gICAgfVxuICB9XG5cbiAgbGV0IGhhbmRsZXIgPSB2aXNpdG9yW25vZGVUeXBlXTtcbiAgaWYgKGhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJldHVybiBoYW5kbGVyIGFzIE5vZGVUcmF2ZXJzYWw8Tj47XG4gIH1cbiAgcmV0dXJuIHZpc2l0b3IuQWxsO1xufVxuXG5mdW5jdGlvbiB2aXNpdE5vZGU8TiBleHRlbmRzIEFTVC5Ob2RlPihcbiAgdmlzaXRvcjogTm9kZVZpc2l0b3IsXG4gIG5vZGU6IE5cbik6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkIHtcbiAgbGV0IGhhbmRsZXI6IE5vZGVUcmF2ZXJzYWw8Tj4gPSBnZXROb2RlSGFuZGxlcih2aXNpdG9yLCBub2RlLnR5cGUpO1xuICBsZXQgZW50ZXI7XG4gIGxldCBleGl0O1xuXG4gIGlmIChoYW5kbGVyICE9PSB1bmRlZmluZWQpIHtcbiAgICBlbnRlciA9IGdldEVudGVyRnVuY3Rpb24oaGFuZGxlcik7XG4gICAgZXhpdCA9IGdldEV4aXRGdW5jdGlvbihoYW5kbGVyKTtcbiAgfVxuXG4gIGxldCByZXN1bHQ6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IHVuZGVmaW5lZCB8IG51bGwgfCB2b2lkO1xuICBpZiAoZW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlc3VsdCA9IGVudGVyKG5vZGUpO1xuICB9XG5cbiAgaWYgKHJlc3VsdCAhPT0gdW5kZWZpbmVkICYmIHJlc3VsdCAhPT0gbnVsbCkge1xuICAgIGlmIChKU09OLnN0cmluZ2lmeShub2RlKSA9PT0gSlNPTi5zdHJpbmdpZnkocmVzdWx0KSkge1xuICAgICAgcmVzdWx0ID0gdW5kZWZpbmVkO1xuICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgICB2aXNpdEFycmF5KHZpc2l0b3IsIHJlc3VsdCk7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gdmlzaXROb2RlKHZpc2l0b3IsIHJlc3VsdCkgfHwgcmVzdWx0O1xuICAgIH1cbiAgfVxuXG4gIGlmIChyZXN1bHQgPT09IHVuZGVmaW5lZCkge1xuICAgIGxldCBrZXlzID0gdmlzaXRvcktleXNbbm9kZS50eXBlXTtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkrKykge1xuICAgICAgbGV0IGtleSA9IGtleXNbaV0gYXMgVmlzaXRvcktleXNbTlsndHlwZSddXSAmIGtleW9mIE47XG4gICAgICAvLyB3ZSBrbm93IGlmIGl0IGhhcyBjaGlsZCBrZXlzIHdlIGNhbiB3aWRlbiB0byBhIFBhcmVudE5vZGVcbiAgICAgIHZpc2l0S2V5KHZpc2l0b3IsIGhhbmRsZXIsIG5vZGUgYXMgTiwga2V5KTtcbiAgICB9XG5cbiAgICBpZiAoZXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXN1bHQgPSBleGl0KG5vZGUpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiByZXN1bHQ7XG59XG5cbmZ1bmN0aW9uIGdldDxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICBub2RlOiBOLFxuICBrZXk6IFZpc2l0b3JLZXlzW05bJ3R5cGUnXV0gJiBrZXlvZiBOXG4pOiBBU1QuTm9kZSB8IEFTVC5Ob2RlW10ge1xuICByZXR1cm4gKG5vZGVba2V5XSBhcyB1bmtub3duKSBhcyBBU1QuTm9kZSB8IEFTVC5Ob2RlW107XG59XG5cbmZ1bmN0aW9uIHNldDxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBrZXlvZiBOPihub2RlOiBOLCBrZXk6IEssIHZhbHVlOiBOW0tdKTogdm9pZCB7XG4gIG5vZGVba2V5XSA9IHZhbHVlO1xufVxuXG5mdW5jdGlvbiB2aXNpdEtleTxOIGV4dGVuZHMgQVNULk5vZGU+KFxuICB2aXNpdG9yOiBOb2RlVmlzaXRvcixcbiAgaGFuZGxlcjogTm9kZVRyYXZlcnNhbDxOPixcbiAgbm9kZTogTixcbiAga2V5OiBWaXNpdG9yS2V5c1tOWyd0eXBlJ11dICYga2V5b2YgTlxuKSB7XG4gIGxldCB2YWx1ZSA9IGdldChub2RlLCBrZXkpO1xuICBpZiAoIXZhbHVlKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbGV0IGtleUVudGVyO1xuICBsZXQga2V5RXhpdDtcblxuICBpZiAoaGFuZGxlciAhPT0gdW5kZWZpbmVkKSB7XG4gICAgbGV0IGtleUhhbmRsZXIgPSBnZXRLZXlIYW5kbGVyKGhhbmRsZXIsIGtleSk7XG4gICAgaWYgKGtleUhhbmRsZXIgIT09IHVuZGVmaW5lZCkge1xuICAgICAga2V5RW50ZXIgPSBnZXRFbnRlckZ1bmN0aW9uKGtleUhhbmRsZXIpO1xuICAgICAga2V5RXhpdCA9IGdldEV4aXRGdW5jdGlvbihrZXlIYW5kbGVyKTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RW50ZXIgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmIChrZXlFbnRlcihub2RlLCBrZXkpICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VPclJlbW92ZUluS2V5SGFuZGxlcllldChub2RlLCBrZXkpO1xuICAgIH1cbiAgfVxuXG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIHZpc2l0QXJyYXkodmlzaXRvciwgdmFsdWUpO1xuICB9IGVsc2Uge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgdmFsdWUpO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gVE9ETzogZHluYW1pY2FsbHkgY2hlY2sgdGhlIHJlc3VsdHMgYnkgaGF2aW5nIGEgdGFibGUgb2ZcbiAgICAgIC8vIGV4cGVjdGVkIG5vZGUgdHlwZXMgaW4gdmFsdWUgc3BhY2UsIG5vdCBqdXN0IHR5cGUgc3BhY2VcbiAgICAgIGFzc2lnbktleShub2RlLCBrZXksIHZhbHVlLCByZXN1bHQgYXMgYW55KTtcbiAgICB9XG4gIH1cblxuICBpZiAoa2V5RXhpdCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKGtleUV4aXQobm9kZSwga2V5KSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBjYW5ub3RSZXBsYWNlT3JSZW1vdmVJbktleUhhbmRsZXJZZXQobm9kZSwga2V5KTtcbiAgICB9XG4gIH1cbn1cblxuZnVuY3Rpb24gdmlzaXRBcnJheSh2aXNpdG9yOiBOb2RlVmlzaXRvciwgYXJyYXk6IEFTVC5Ob2RlW10pIHtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheS5sZW5ndGg7IGkrKykge1xuICAgIGxldCByZXN1bHQgPSB2aXNpdE5vZGUodmlzaXRvciwgYXJyYXlbaV0pO1xuICAgIGlmIChyZXN1bHQgIT09IHVuZGVmaW5lZCkge1xuICAgICAgaSArPSBzcGxpY2VBcnJheShhcnJheSwgaSwgcmVzdWx0KSAtIDE7XG4gICAgfVxuICB9XG59XG5cbmZ1bmN0aW9uIGFzc2lnbktleTxOIGV4dGVuZHMgQVNULk5vZGUsIEsgZXh0ZW5kcyBWaXNpdG9yS2V5PE4+PihcbiAgbm9kZTogTixcbiAga2V5OiBLLFxuICB2YWx1ZTogQVNULk5vZGUsXG4gIHJlc3VsdDogTltLXSB8IFtOW0tdXSB8IG51bGxcbikge1xuICBpZiAocmVzdWx0ID09PSBudWxsKSB7XG4gICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlc3VsdCkpIHtcbiAgICBpZiAocmVzdWx0Lmxlbmd0aCA9PT0gMSkge1xuICAgICAgc2V0KG5vZGUsIGtleSwgcmVzdWx0WzBdKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKHJlc3VsdC5sZW5ndGggPT09IDApIHtcbiAgICAgICAgdGhyb3cgY2Fubm90UmVtb3ZlTm9kZSh2YWx1ZSwgbm9kZSwga2V5KTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRocm93IGNhbm5vdFJlcGxhY2VOb2RlKHZhbHVlLCBub2RlLCBrZXkpO1xuICAgICAgfVxuICAgIH1cbiAgfSBlbHNlIHtcbiAgICBzZXQobm9kZSwga2V5LCByZXN1bHQpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHNwbGljZUFycmF5KGFycmF5OiBBU1QuTm9kZVtdLCBpbmRleDogbnVtYmVyLCByZXN1bHQ6IEFTVC5Ob2RlIHwgQVNULk5vZGVbXSB8IG51bGwpIHtcbiAgaWYgKHJlc3VsdCA9PT0gbnVsbCkge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSk7XG4gICAgcmV0dXJuIDA7XG4gIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShyZXN1bHQpKSB7XG4gICAgYXJyYXkuc3BsaWNlKGluZGV4LCAxLCAuLi5yZXN1bHQpO1xuICAgIHJldHVybiByZXN1bHQubGVuZ3RoO1xuICB9IGVsc2Uge1xuICAgIGFycmF5LnNwbGljZShpbmRleCwgMSwgcmVzdWx0KTtcbiAgICByZXR1cm4gMTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiB0cmF2ZXJzZShub2RlOiBBU1QuTm9kZSwgdmlzaXRvcjogTm9kZVZpc2l0b3IpIHtcbiAgdmlzaXROb2RlKHZpc2l0b3IsIG5vZGUpO1xufVxuIl0sInNvdXJjZVJvb3QiOiIifQ==