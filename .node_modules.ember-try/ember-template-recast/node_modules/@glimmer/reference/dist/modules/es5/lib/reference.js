import { getProp, setProp } from '@glimmer/global-context';
import { symbol, isDict } from '@glimmer/util';
import { CONSTANT_TAG, validateTag, consumeTag, INITIAL, valueForTag, track } from '@glimmer/validator';
import { DEBUG } from '@glimmer/env';
export var REFERENCE = symbol('REFERENCE');

var ReferenceImpl = function ReferenceImpl(type) {
  this.tag = null;
  this.lastRevision = INITIAL;
  this.children = null;
  this.compute = null;
  this.update = null;
  this[REFERENCE] = type;
};

export function createPrimitiveRef(value) {
  var ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.tag = CONSTANT_TAG;
  ref.lastValue = value;

  if (DEBUG) {
    ref.debugLabel = String(value);
  }

  return ref;
}
export var UNDEFINED_REFERENCE = createPrimitiveRef(undefined);
export var NULL_REFERENCE = createPrimitiveRef(null);
export var TRUE_REFERENCE = createPrimitiveRef(true);
export var FALSE_REFERENCE = createPrimitiveRef(false);
export function createConstRef(value, debugLabel) {
  var ref = new ReferenceImpl(0
  /* Constant */
  );
  ref.lastValue = value;
  ref.tag = CONSTANT_TAG;

  if (DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}
export function createUnboundRef(value, debugLabel) {
  var ref = new ReferenceImpl(2
  /* Unbound */
  );
  ref.lastValue = value;
  ref.tag = CONSTANT_TAG;

  if (DEBUG) {
    ref.debugLabel = debugLabel;
  }

  return ref;
}
export function createComputeRef(compute, update, debugLabel) {
  if (update === void 0) {
    update = null;
  }

  if (debugLabel === void 0) {
    debugLabel = 'unknown';
  }

  var ref = new ReferenceImpl(1
  /* Compute */
  );
  ref.compute = compute;
  ref.update = update;

  if (DEBUG) {
    ref.debugLabel = "(result of a `" + debugLabel + "` helper)";
  }

  return ref;
}
export function createReadOnlyRef(ref) {
  if (!isUpdatableRef(ref)) return ref;
  return createComputeRef(function () {
    return valueForRef(ref);
  }, null, ref.debugLabel);
}
export function isInvokableRef(ref) {
  return ref[REFERENCE] === 3
  /* Invokable */
  ;
}
export function createInvokableRef(inner) {
  var ref = createComputeRef(function () {
    return valueForRef(inner);
  }, function (value) {
    return updateRef(inner, value);
  });
  ref.debugLabel = inner.debugLabel;
  ref[REFERENCE] = 3
  /* Invokable */
  ;
  return ref;
}
export function isConstRef(_ref) {
  var ref = _ref;
  return ref.tag === CONSTANT_TAG;
}
export function isUpdatableRef(_ref) {
  var ref = _ref;
  return ref.update !== null;
}
export function valueForRef(_ref) {
  var ref = _ref;
  var tag = ref.tag;

  if (tag === CONSTANT_TAG) {
    return ref.lastValue;
  }

  var lastRevision = ref.lastRevision;
  var lastValue;

  if (tag === null || !validateTag(tag, lastRevision)) {
    var compute = ref.compute;
    tag = ref.tag = track(function () {
      lastValue = ref.lastValue = compute();
    }, DEBUG && ref.debugLabel);
    ref.lastRevision = valueForTag(tag);
  } else {
    lastValue = ref.lastValue;
  }

  consumeTag(tag);
  return lastValue;
}
export function updateRef(_ref, value) {
  var ref = _ref;
  var update = ref.update;
  update(value);
}
export function childRefFor(_parentRef, path) {
  var parentRef = _parentRef;
  var type = parentRef[REFERENCE];
  var children = parentRef.children;
  var child;

  if (children === null) {
    children = parentRef.children = new Map();
  } else {
    child = children.get(path);

    if (child !== undefined) {
      return child;
    }
  }

  if (type === 2
  /* Unbound */
  ) {
      var parent = valueForRef(parentRef);

      if (isDict(parent)) {
        child = createUnboundRef(parent[path], DEBUG && parentRef.debugLabel + "." + path);
      } else {
        child = UNDEFINED_REFERENCE;
      }
    } else {
    child = createComputeRef(function () {
      var parent = valueForRef(parentRef);

      if (isDict(parent)) {
        return getProp(parent, path);
      }
    }, function (val) {
      var parent = valueForRef(parentRef);

      if (isDict(parent)) {
        return setProp(parent, path, val);
      }
    });

    if (DEBUG) {
      child.debugLabel = parentRef.debugLabel + "." + path;
    }
  }

  children.set(path, child);
  return child;
}
export function childRefFromParts(root, parts) {
  var reference = root;

  for (var i = 0; i < parts.length; i++) {
    reference = childRefFor(reference, parts[i]);
  }

  return reference;
}
export var createDebugAliasRef;

if (DEBUG) {
  createDebugAliasRef = function createDebugAliasRef(debugLabel, inner) {
    var update = isUpdatableRef(inner) ? function (value) {
      return updateRef(inner, value);
    } : null;
    var ref = createComputeRef(function () {
      return valueForRef(inner);
    }, update);
    ref[REFERENCE] = inner[REFERENCE];
    ref.debugLabel = debugLabel;
    return ref;
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL0BnbGltbWVyL3JlZmVyZW5jZS9saWIvcmVmZXJlbmNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLFNBQUEsT0FBQSxFQUFBLE9BQUEsUUFBQSx5QkFBQTtBQUNBLFNBQUEsTUFBQSxFQUFBLE1BQUEsUUFBQSxlQUFBO0FBQ0EsU0FBQSxZQUFBLEVBQUEsV0FBQSxFQUFBLFVBQUEsRUFBQSxPQUFBLEVBQUEsV0FBQSxFQUFBLEtBQUEsUUFBQSxvQkFBQTtBQVVBLFNBQUEsS0FBQSxRQUFBLGNBQUE7QUFFQSxPQUFPLElBQU0sU0FBUyxHQUFrQixNQUFNLENBQXZDLFdBQXVDLENBQXZDOztJQXVCUCxhLEdBYUUsdUJBQUEsSUFBQSxFQUErQjtBQVh4QixPQUFBLEdBQUEsR0FBQSxJQUFBO0FBQ0EsT0FBQSxZQUFBLEdBQUEsT0FBQTtBQUdBLE9BQUEsUUFBQSxHQUFBLElBQUE7QUFFQSxPQUFBLE9BQUEsR0FBQSxJQUFBO0FBQ0EsT0FBQSxNQUFBLEdBQUEsSUFBQTtBQUtMLE9BQUEsU0FBQSxJQUFBLElBQUE7QUFDRCxDOztBQUdILE9BQU0sU0FBQSxrQkFBQSxDQUFBLEtBQUEsRUFBMkM7QUFDL0MsTUFBSSxHQUFHLEdBQUcsSUFBQSxhQUFBLENBQWlCO0FBQUE7QUFBakIsR0FBVjtBQUVBLEVBQUEsR0FBRyxDQUFILEdBQUEsR0FBQSxZQUFBO0FBQ0EsRUFBQSxHQUFHLENBQUgsU0FBQSxHQUFBLEtBQUE7O0FBRUEsTUFBQSxLQUFBLEVBQVc7QUFDVCxJQUFBLEdBQUcsQ0FBSCxVQUFBLEdBQWlCLE1BQU0sQ0FBdkIsS0FBdUIsQ0FBdkI7QUFDRDs7QUFFRCxTQUFBLEdBQUE7QUFDRDtBQUVELE9BQU8sSUFBTSxtQkFBbUIsR0FBRyxrQkFBa0IsQ0FBOUMsU0FBOEMsQ0FBOUM7QUFDUCxPQUFPLElBQU0sY0FBYyxHQUFHLGtCQUFrQixDQUF6QyxJQUF5QyxDQUF6QztBQUNQLE9BQU8sSUFBTSxjQUFj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LENBQUwsVUFBQSxHQUFzQixTQUFTLENBQUMsVUFBaEMsU0FBQSxJQUFBO0FBQ0Q7QUFDRjs7QUFFRCxFQUFBLFFBQVEsQ0FBUixHQUFBLENBQUEsSUFBQSxFQUFBLEtBQUE7QUFFQSxTQUFBLEtBQUE7QUFDRDtBQUVELE9BQU0sU0FBQSxpQkFBQSxDQUFBLElBQUEsRUFBQSxLQUFBLEVBQTREO0FBQ2hFLE1BQUksU0FBUyxHQUFiLElBQUE7O0FBRUEsT0FBSyxJQUFJLENBQUMsR0FBVixDQUFBLEVBQWdCLENBQUMsR0FBRyxLQUFLLENBQXpCLE1BQUEsRUFBa0MsQ0FBbEMsRUFBQSxFQUF1QztBQUNyQyxJQUFBLFNBQVMsR0FBRyxXQUFXLENBQUEsU0FBQSxFQUFZLEtBQUssQ0FBeEMsQ0FBd0MsQ0FBakIsQ0FBdkI7QUFDRDs7QUFFRCxTQUFBLFNBQUE7QUFDRDtBQUVELE9BQU8sSUFBQSxtQkFBQTs7QUFFUCxJQUFBLEtBQUEsRUFBVztBQUNULEVBQUEsbUJBQW1CLEdBQUcsNkJBQUEsVUFBQSxFQUFBLEtBQUEsRUFBeUM7QUFDN0QsUUFBSSxNQUFNLEdBQUcsY0FBYyxDQUFkLEtBQWMsQ0FBZCxHQUF5QixVQUFBLEtBQUQ7QUFBQSxhQUFvQixTQUFTLENBQUEsS0FBQSxFQUFyRCxLQUFxRCxDQUE3QjtBQUFBLEtBQXhCLEdBQWIsSUFBQTtBQUNBLFFBQUksR0FBRyxHQUFHLGdCQUFnQixDQUFDO0FBQUEsYUFBTSxXQUFXLENBQWxCLEtBQWtCLENBQWpCO0FBQUEsS0FBRCxFQUExQixNQUEwQixDQUExQjtBQUVBLElBQUEsR0FBRyxDQUFILFNBQUcsQ0FBSCxHQUFpQixLQUFLLENBQXRCLFNBQXNCLENBQXRCO0FBRUEsSUFBQSxHQUFHLENBQUgsVUFBQSxHQUFBLFVBQUE7QUFFQSxXQUFBLEdBQUE7QUFSRixHQUFBO0FBVUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBnZXRQcm9wLCBzZXRQcm9wIH0gZnJvbSAnQGdsaW1tZXIvZ2xvYmFsLWNvbnRleHQnO1xuaW1wb3J0IHsgT3B0aW9uLCBleHBlY3QsIHN5bWJvbCwgaXNEaWN0LCBfV2Vha1NldCB9IGZyb20gJ0BnbGltbWVyL3V0aWwnO1xuaW1wb3J0IHtcbiAgVGFnLFxuICBDT05TVEFOVF9UQUcsXG4gIFJldmlzaW9uLFxuICB2YWxpZGF0ZVRhZyxcbiAgY29uc3VtZVRhZyxcbiAgSU5JVElBTCxcbiAgdmFsdWVGb3JUYWcsXG4gIHRyYWNrLFxufSBmcm9tICdAZ2xpbW1lci92YWxpZGF0b3InO1xuaW1wb3J0IHsgREVCVUcgfSBmcm9tICdAZ2xpbW1lci9lbnYnO1xuXG5leHBvcnQgY29uc3QgUkVGRVJFTkNFOiB1bmlxdWUgc3ltYm9sID0gc3ltYm9sKCdSRUZFUkVOQ0UnKTtcblxuY29uc3QgZW51bSBSZWZlcmVuY2VUeXBlIHtcbiAgQ29uc3RhbnQsXG4gIENvbXB1dGUsXG4gIFVuYm91bmQsXG4gIEludm9rYWJsZSxcbn1cblxuZXhwb3J0IGludGVyZmFjZSBSZWZlcmVuY2U8X1QgPSB1bmtub3duPiB7XG4gIFtSRUZFUkVOQ0VdOiBSZWZlcmVuY2VUeXBlO1xuICBkZWJ1Z0xhYmVsPzogc3RyaW5nO1xufVxuXG5leHBvcnQgZGVmYXVsdCBSZWZlcmVuY2U7XG5cbi8vLy8vLy8vLy9cblxuZXhwb3J0IGludGVyZmFjZSBSZWZlcmVuY2VFbnZpcm9ubWVudCB7XG4gIGdldFByb3Aob2JqOiB1bmtub3duLCBwYXRoOiBzdHJpbmcpOiB1bmtub3duO1xuICBzZXRQcm9wKG9iajogdW5rbm93biwgcGF0aDogc3RyaW5nLCB2YWx1ZTogdW5rbm93bik6IHVua25vd247XG59XG5cbmNsYXNzIFJlZmVyZW5jZUltcGw8VCA9IHVua25vd24+IGltcGxlbWVudHMgUmVmZXJlbmNlIHtcbiAgW1JFRkVSRU5DRV06IFJlZmVyZW5jZVR5cGU7XG4gIHB1YmxpYyB0YWc6IE9wdGlvbjxUYWc+ID0gbnVsbDtcbiAgcHVibGljIGxhc3RSZXZpc2lvbjogUmV2aXNpb24gPSBJTklUSUFMO1xuICBwdWJsaWMgbGFzdFZhbHVlPzogVDtcblxuICBwdWJsaWMgY2hpbGRyZW46IE9wdGlvbjxNYXA8c3RyaW5nIHwgUmVmZXJlbmNlLCBSZWZlcmVuY2U+PiA9IG51bGw7XG5cbiAgcHVibGljIGNvbXB1dGU6IE9wdGlvbjwoKSA9PiBUPiA9IG51bGw7XG4gIHB1YmxpYyB1cGRhdGU6IE9wdGlvbjwodmFsOiBUKSA9PiB2b2lkPiA9IG51bGw7XG5cbiAgcHVibGljIGRlYnVnTGFiZWw/OiBzdHJpbmc7XG5cbiAgY29uc3RydWN0b3IodHlwZTogUmVmZXJlbmNlVHlwZSkge1xuICAgIHRoaXNbUkVGRVJFTkNFXSA9IHR5cGU7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZVByaW1pdGl2ZVJlZih2YWx1ZTogdW5rbm93bik6IFJlZmVyZW5jZSB7XG4gIGxldCByZWYgPSBuZXcgUmVmZXJlbmNlSW1wbChSZWZlcmVuY2VUeXBlLlVuYm91bmQpO1xuXG4gIHJlZi50YWcgPSBDT05TVEFOVF9UQUc7XG4gIHJlZi5sYXN0VmFsdWUgPSB2YWx1ZTtcblxuICBpZiAoREVCVUcpIHtcbiAgICByZWYuZGVidWdMYWJlbCA9IFN0cmluZyh2YWx1ZSk7XG4gIH1cblxuICByZXR1cm4gcmVmO1xufVxuXG5leHBvcnQgY29uc3QgVU5ERUZJTkVEX1JFRkVSRU5DRSA9IGNyZWF0ZVByaW1pdGl2ZVJlZih1bmRlZmluZWQpO1xuZXhwb3J0IGNvbnN0IE5VTExfUkVGRVJFTkNFID0gY3JlYXRlUHJpbWl0aXZlUmVmKG51bGwpO1xuZXhwb3J0IGNvbnN0IFRSVUVfUkVGRVJFTkNFID0gY3JlYXRlUHJpbWl0aXZlUmVmKHRydWUpO1xuZXhwb3J0IGNvbnN0IEZBTFNFX1JFRkVSRU5DRSA9IGNyZWF0ZVByaW1pdGl2ZVJlZihmYWxzZSk7XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb25zdFJlZih2YWx1ZTogdW5rbm93biwgZGVidWdMYWJlbDogZmFsc2UgfCBzdHJpbmcpOiBSZWZlcmVuY2Uge1xuICBsZXQgcmVmID0gbmV3IFJlZmVyZW5jZUltcGwoUmVmZXJlbmNlVHlwZS5Db25zdGFudCk7XG5cbiAgcmVmLmxhc3RWYWx1ZSA9IHZhbHVlO1xuICByZWYudGFnID0gQ09OU1RBTlRfVEFHO1xuXG4gIGlmIChERUJVRykge1xuICAgIHJlZi5kZWJ1Z0xhYmVsID0gZGVidWdMYWJlbCBhcyBzdHJpbmc7XG4gIH1cblxuICByZXR1cm4gcmVmO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlVW5ib3VuZFJlZih2YWx1ZTogdW5rbm93biwgZGVidWdMYWJlbDogZmFsc2UgfCBzdHJpbmcpOiBSZWZlcmVuY2Uge1xuICBsZXQgcmVmID0gbmV3IFJlZmVyZW5jZUltcGwoUmVmZXJlbmNlVHlwZS5VbmJvdW5kKTtcblxuICByZWYubGFzdFZhbHVlID0gdmFsdWU7XG4gIHJlZi50YWcgPSBDT05TVEFOVF9UQUc7XG5cbiAgaWYgKERFQlVHKSB7XG4gICAgcmVmLmRlYnVnTGFiZWwgPSBkZWJ1Z0xhYmVsIGFzIHN0cmluZztcbiAgfVxuXG4gIHJldHVybiByZWY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb21wdXRlUmVmPFQgPSB1bmtub3duPihcbiAgY29tcHV0ZTogKCkgPT4gVCxcbiAgdXBkYXRlOiBPcHRpb248KHZhbHVlOiBUKSA9PiB2b2lkPiA9IG51bGwsXG4gIGRlYnVnTGFiZWw6IGZhbHNlIHwgc3RyaW5nID0gJ3Vua25vd24nXG4pOiBSZWZlcmVuY2U8VD4ge1xuICBsZXQgcmVmID0gbmV3IFJlZmVyZW5jZUltcGw8VD4oUmVmZXJlbmNlVHlwZS5Db21wdXRlKTtcblxuICByZWYuY29tcHV0ZSA9IGNvbXB1dGU7XG4gIHJlZi51cGRhdGUgPSB1cGRhdGU7XG5cbiAgaWYgKERFQlVHKSB7XG4gICAgcmVmLmRlYnVnTGFiZWwgPSBgKHJlc3VsdCBvZiBhIFxcYCR7ZGVidWdMYWJlbH1cXGAgaGVscGVyKWA7XG4gIH1cblxuICByZXR1cm4gcmVmO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY3JlYXRlUmVhZE9ubHlSZWYocmVmOiBSZWZlcmVuY2UpOiBSZWZlcmVuY2Uge1xuICBpZiAoIWlzVXBkYXRhYmxlUmVmKHJlZikpIHJldHVybiByZWY7XG5cbiAgcmV0dXJuIGNyZWF0ZUNvbXB1dGVSZWYoKCkgPT4gdmFsdWVGb3JSZWYocmVmKSwgbnVsbCwgcmVmLmRlYnVnTGFiZWwpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gaXNJbnZva2FibGVSZWYocmVmOiBSZWZlcmVuY2UpIHtcbiAgcmV0dXJuIHJlZltSRUZFUkVOQ0VdID09PSBSZWZlcmVuY2VUeXBlLkludm9rYWJsZTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUludm9rYWJsZVJlZihpbm5lcjogUmVmZXJlbmNlKTogUmVmZXJlbmNlIHtcbiAgbGV0IHJlZiA9IGNyZWF0ZUNvbXB1dGVSZWYoXG4gICAgKCkgPT4gdmFsdWVGb3JSZWYoaW5uZXIpLFxuICAgICh2YWx1ZSkgPT4gdXBkYXRlUmVmKGlubmVyLCB2YWx1ZSlcbiAgKTtcbiAgcmVmLmRlYnVnTGFiZWwgPSBpbm5lci5kZWJ1Z0xhYmVsO1xuICByZWZbUkVGRVJFTkNFXSA9IFJlZmVyZW5jZVR5cGUuSW52b2thYmxlO1xuXG4gIHJldHVybiByZWY7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc0NvbnN0UmVmKF9yZWY6IFJlZmVyZW5jZSkge1xuICBsZXQgcmVmID0gX3JlZiBhcyBSZWZlcmVuY2VJbXBsO1xuXG4gIHJldHVybiByZWYudGFnID09PSBDT05TVEFOVF9UQUc7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBpc1VwZGF0YWJsZVJlZihfcmVmOiBSZWZlcmVuY2UpIHtcbiAgbGV0IHJlZiA9IF9yZWYgYXMgUmVmZXJlbmNlSW1wbDtcblxuICByZXR1cm4gcmVmLnVwZGF0ZSAhPT0gbnVsbDtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbHVlRm9yUmVmPFQ+KF9yZWY6IFJlZmVyZW5jZTxUPik6IFQge1xuICBsZXQgcmVmID0gX3JlZiBhcyBSZWZlcmVuY2VJbXBsPFQ+O1xuXG4gIGxldCB7IHRhZyB9ID0gcmVmO1xuXG4gIGlmICh0YWcgPT09IENPTlNUQU5UX1RBRykge1xuICAgIHJldHVybiByZWYubGFzdFZhbHVlIGFzIFQ7XG4gIH1cblxuICBsZXQgeyBsYXN0UmV2aXNpb24gfSA9IHJlZjtcbiAgbGV0IGxhc3RWYWx1ZTtcblxuICBpZiAodGFnID09PSBudWxsIHx8ICF2YWxpZGF0ZVRhZyh0YWcsIGxhc3RSZXZpc2lvbikpIHtcbiAgICBsZXQgeyBjb21wdXRlIH0gPSByZWY7XG5cbiAgICB0YWcgPSByZWYudGFnID0gdHJhY2soKCkgPT4ge1xuICAgICAgbGFzdFZhbHVlID0gcmVmLmxhc3RWYWx1ZSA9IGNvbXB1dGUhKCk7XG4gICAgfSwgREVCVUcgJiYgcmVmLmRlYnVnTGFiZWwpO1xuXG4gICAgcmVmLmxhc3RSZXZpc2lvbiA9IHZhbHVlRm9yVGFnKHRhZyk7XG4gIH0gZWxzZSB7XG4gICAgbGFzdFZhbHVlID0gcmVmLmxhc3RWYWx1ZTtcbiAgfVxuXG4gIGNvbnN1bWVUYWcodGFnKTtcblxuICByZXR1cm4gbGFzdFZhbHVlIGFzIFQ7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiB1cGRhdGVSZWYoX3JlZjogUmVmZXJlbmNlLCB2YWx1ZTogdW5rbm93bikge1xuICBsZXQgcmVmID0gX3JlZiBhcyBSZWZlcmVuY2VJbXBsO1xuXG4gIGxldCB1cGRhdGUgPSBleHBlY3QocmVmLnVwZGF0ZSwgJ2NhbGxlZCB1cGRhdGUgb24gYSBub24tdXBkYXRhYmxlIHJlZmVyZW5jZScpO1xuXG4gIHVwZGF0ZSh2YWx1ZSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBjaGlsZFJlZkZvcihfcGFyZW50UmVmOiBSZWZlcmVuY2UsIHBhdGg6IHN0cmluZyk6IFJlZmVyZW5jZSB7XG4gIGxldCBwYXJlbnRSZWYgPSBfcGFyZW50UmVmIGFzIFJlZmVyZW5jZUltcGw7XG5cbiAgbGV0IHR5cGUgPSBwYXJlbnRSZWZbUkVGRVJFTkNFXTtcblxuICBsZXQgY2hpbGRyZW4gPSBwYXJlbnRSZWYuY2hpbGRyZW47XG4gIGxldCBjaGlsZDogUmVmZXJlbmNlO1xuXG4gIGlmIChjaGlsZHJlbiA9PT0gbnVsbCkge1xuICAgIGNoaWxkcmVuID0gcGFyZW50UmVmLmNoaWxkcmVuID0gbmV3IE1hcCgpO1xuICB9IGVsc2Uge1xuICAgIGNoaWxkID0gY2hpbGRyZW4uZ2V0KHBhdGgpITtcblxuICAgIGlmIChjaGlsZCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gY2hpbGQ7XG4gICAgfVxuICB9XG5cbiAgaWYgKHR5cGUgPT09IFJlZmVyZW5jZVR5cGUuVW5ib3VuZCkge1xuICAgIGxldCBwYXJlbnQgPSB2YWx1ZUZvclJlZihwYXJlbnRSZWYpO1xuXG4gICAgaWYgKGlzRGljdChwYXJlbnQpKSB7XG4gICAgICBjaGlsZCA9IGNyZWF0ZVVuYm91bmRSZWYoXG4gICAgICAgIChwYXJlbnQgYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4pW3BhdGhdLFxuICAgICAgICBERUJVRyAmJiBgJHtwYXJlbnRSZWYuZGVidWdMYWJlbH0uJHtwYXRofWBcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNoaWxkID0gVU5ERUZJTkVEX1JFRkVSRU5DRTtcbiAgICB9XG4gIH0gZWxzZSB7XG4gICAgY2hpbGQgPSBjcmVhdGVDb21wdXRlUmVmKFxuICAgICAgKCkgPT4ge1xuICAgICAgICBsZXQgcGFyZW50ID0gdmFsdWVGb3JSZWYocGFyZW50UmVmKTtcblxuICAgICAgICBpZiAoaXNEaWN0KHBhcmVudCkpIHtcbiAgICAgICAgICByZXR1cm4gZ2V0UHJvcChwYXJlbnQsIHBhdGgpO1xuICAgICAgICB9XG4gICAgICB9LFxuICAgICAgKHZhbCkgPT4ge1xuICAgICAgICBsZXQgcGFyZW50ID0gdmFsdWVGb3JSZWYocGFyZW50UmVmKTtcblxuICAgICAgICBpZiAoaXNEaWN0KHBhcmVudCkpIHtcbiAgICAgICAgICByZXR1cm4gc2V0UHJvcChwYXJlbnQsIHBhdGgsIHZhbCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICApO1xuXG4gICAgaWYgKERFQlVHKSB7XG4gICAgICBjaGlsZC5kZWJ1Z0xhYmVsID0gYCR7cGFyZW50UmVmLmRlYnVnTGFiZWx9LiR7cGF0aH1gO1xuICAgIH1cbiAgfVxuXG4gIGNoaWxkcmVuLnNldChwYXRoLCBjaGlsZCk7XG5cbiAgcmV0dXJuIGNoaWxkO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2hpbGRSZWZGcm9tUGFydHMocm9vdDogUmVmZXJlbmNlLCBwYXJ0czogc3RyaW5nW10pOiBSZWZlcmVuY2Uge1xuICBsZXQgcmVmZXJlbmNlID0gcm9vdDtcblxuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcnRzLmxlbmd0aDsgaSsrKSB7XG4gICAgcmVmZXJlbmNlID0gY2hpbGRSZWZGb3IocmVmZXJlbmNlLCBwYXJ0c1tpXSk7XG4gIH1cblxuICByZXR1cm4gcmVmZXJlbmNlO1xufVxuXG5leHBvcnQgbGV0IGNyZWF0ZURlYnVnQWxpYXNSZWY6IHVuZGVmaW5lZCB8ICgoZGVidWdMYWJlbDogc3RyaW5nLCBpbm5lcjogUmVmZXJlbmNlKSA9PiBSZWZlcmVuY2UpO1xuXG5pZiAoREVCVUcpIHtcbiAgY3JlYXRlRGVidWdBbGlhc1JlZiA9IChkZWJ1Z0xhYmVsOiBzdHJpbmcsIGlubmVyOiBSZWZlcmVuY2UpID0+IHtcbiAgICBsZXQgdXBkYXRlID0gaXNVcGRhdGFibGVSZWYoaW5uZXIpID8gKHZhbHVlOiB1bmtub3duKSA9PiB1cGRhdGVSZWYoaW5uZXIsIHZhbHVlKSA6IG51bGw7XG4gICAgbGV0IHJlZiA9IGNyZWF0ZUNvbXB1dGVSZWYoKCkgPT4gdmFsdWVGb3JSZWYoaW5uZXIpLCB1cGRhdGUpO1xuXG4gICAgcmVmW1JFRkVSRU5DRV0gPSBpbm5lcltSRUZFUkVOQ0VdO1xuXG4gICAgcmVmLmRlYnVnTGFiZWwgPSBkZWJ1Z0xhYmVsO1xuXG4gICAgcmV0dXJuIHJlZjtcbiAgfTtcbn1cbiJdLCJzb3VyY2VSb290IjoiIn0=